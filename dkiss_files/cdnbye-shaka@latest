!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.P2PEngineShaka=t():e.P2PEngineShaka=t()}(self,(()=>(()=>{var e={539:(e,t)=>{"use strict";function i(e,t){return void 0===t&&(t=Object),t&&"function"==typeof t.freeze?t.freeze(e):e}var s=i({HTML:"text/html",isHTML:function(e){return e===s.HTML},XML_APPLICATION:"application/xml",XML_TEXT:"text/xml",XML_XHTML_APPLICATION:"application/xhtml+xml",XML_SVG_IMAGE:"image/svg+xml"}),r=i({HTML:"http://www.w3.org/1999/xhtml",isHTML:function(e){return e===r.HTML},SVG:"http://www.w3.org/2000/svg",XML:"http://www.w3.org/XML/1998/namespace",XMLNS:"http://www.w3.org/2000/xmlns/"});t.freeze=i,t.MIME_TYPE=s,t.NAMESPACE=r},588:(e,t,i)=>{var s=i(539),r=i(89),n=i(369),o=i(835),a=r.DOMImplementation,h=s.NAMESPACE,l=o.ParseError,c=o.XMLReader;function u(e){this.options=e||{locator:{}}}function d(){this.cdata=!1}function f(e,t){t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber}function g(e){if(e)return"\n@"+(e.systemId||"")+"#[line:"+e.lineNumber+",col:"+e.columnNumber+"]"}function p(e,t,i){return"string"==typeof e?e.substr(t,i):e.length>=t+i||t?new java.lang.String(e,t,i)+"":e}function m(e,t){e.currentElement?e.currentElement.appendChild(t):e.doc.appendChild(t)}u.prototype.parseFromString=function(e,t){var i=this.options,s=new c,r=i.domBuilder||new d,o=i.errorHandler,a=i.locator,l=i.xmlns||{},u=/\/x?html?$/.test(t),f=u?n.HTML_ENTITIES:n.XML_ENTITIES;return a&&r.setDocumentLocator(a),s.errorHandler=function(e,t,i){if(!e){if(t instanceof d)return t;e=t}var s={},r=e instanceof Function;function n(t){var n=e[t];!n&&r&&(n=2==e.length?function(i){e(t,i)}:e),s[t]=n&&function(e){n("[xmldom "+t+"]\t"+e+g(i))}||function(){}}return i=i||{},n("warning"),n("error"),n("fatalError"),s}(o,r,a),s.domBuilder=i.domBuilder||r,u&&(l[""]=h.HTML),l.xml=l.xml||h.XML,e&&"string"==typeof e?s.parse(e,l,f):s.errorHandler.error("invalid doc source"),r.doc},d.prototype={startDocument:function(){this.doc=(new a).createDocument(null,null,null),this.locator&&(this.doc.documentURI=this.locator.systemId)},startElement:function(e,t,i,s){var r=this.doc,n=r.createElementNS(e,i||t),o=s.length;m(this,n),this.currentElement=n,this.locator&&f(this.locator,n);for(var a=0;a<o;a++){e=s.getURI(a);var h=s.getValue(a),l=(i=s.getQName(a),r.createAttributeNS(e,i));this.locator&&f(s.getLocator(a),l),l.value=l.nodeValue=h,n.setAttributeNode(l)}},endElement:function(e,t,i){var s=this.currentElement;s.tagName;this.currentElement=s.parentNode},startPrefixMapping:function(e,t){},endPrefixMapping:function(e){},processingInstruction:function(e,t){var i=this.doc.createProcessingInstruction(e,t);this.locator&&f(this.locator,i),m(this,i)},ignorableWhitespace:function(e,t,i){},characters:function(e,t,i){if(e=p.apply(this,arguments)){if(this.cdata)var s=this.doc.createCDATASection(e);else s=this.doc.createTextNode(e);this.currentElement?this.currentElement.appendChild(s):/^\s*$/.test(e)&&this.doc.appendChild(s),this.locator&&f(this.locator,s)}},skippedEntity:function(e){},endDocument:function(){this.doc.normalize()},setDocumentLocator:function(e){(this.locator=e)&&(e.lineNumber=0)},comment:function(e,t,i){e=p.apply(this,arguments);var s=this.doc.createComment(e);this.locator&&f(this.locator,s),m(this,s)},startCDATA:function(){this.cdata=!0},endCDATA:function(){this.cdata=!1},startDTD:function(e,t,i){var s=this.doc.implementation;if(s&&s.createDocumentType){var r=s.createDocumentType(e,t,i);this.locator&&f(this.locator,r),m(this,r),this.doc.doctype=r}},warning:function(e){console.warn("[xmldom warning]\t"+e,g(this.locator))},error:function(e){console.error("[xmldom error]\t"+e,g(this.locator))},fatalError:function(e){throw new l(e,this.locator)}},"endDTD,startEntity,endEntity,attributeDecl,elementDecl,externalEntityDecl,internalEntityDecl,resolveEntity,getExternalSubset,notationDecl,unparsedEntityDecl".replace(/\w+/g,(function(e){d.prototype[e]=function(){return null}})),t.DOMParser=u,r.DOMImplementation,r.XMLSerializer},89:(e,t,i)=>{var s=i(539).NAMESPACE;function r(e){return""!==e}function n(e,t){return e.hasOwnProperty(t)||(e[t]=!0),e}function o(e){if(!e)return[];var t=function(e){return e?e.split(/[\t\n\f\r ]+/).filter(r):[]}(e);return Object.keys(t.reduce(n,{}))}function a(e,t){for(var i in e)t[i]=e[i]}function h(e,t){var i=e.prototype;if(!(i instanceof t)){function s(){}s.prototype=t.prototype,a(i,s=new s),e.prototype=i=s}i.constructor!=e&&("function"!=typeof e&&console.error("unknown Class:"+e),i.constructor=e)}var l={},c=l.ELEMENT_NODE=1,u=l.ATTRIBUTE_NODE=2,d=l.TEXT_NODE=3,f=l.CDATA_SECTION_NODE=4,g=l.ENTITY_REFERENCE_NODE=5,p=l.ENTITY_NODE=6,m=l.PROCESSING_INSTRUCTION_NODE=7,_=l.COMMENT_NODE=8,y=l.DOCUMENT_NODE=9,v=l.DOCUMENT_TYPE_NODE=10,b=l.DOCUMENT_FRAGMENT_NODE=11,S=l.NOTATION_NODE=12,w={},P={},E=(w.INDEX_SIZE_ERR=(P[1]="Index size error",1),w.DOMSTRING_SIZE_ERR=(P[2]="DOMString size error",2),w.HIERARCHY_REQUEST_ERR=(P[3]="Hierarchy request error",3)),T=(w.WRONG_DOCUMENT_ERR=(P[4]="Wrong document",4),w.INVALID_CHARACTER_ERR=(P[5]="Invalid character",5),w.NO_DATA_ALLOWED_ERR=(P[6]="No data allowed",6),w.NO_MODIFICATION_ALLOWED_ERR=(P[7]="No modification allowed",7),w.NOT_FOUND_ERR=(P[8]="Not found",8)),I=(w.NOT_SUPPORTED_ERR=(P[9]="Not supported",9),w.INUSE_ATTRIBUTE_ERR=(P[10]="Attribute in use",10));w.INVALID_STATE_ERR=(P[11]="Invalid state",11),w.SYNTAX_ERR=(P[12]="Syntax error",12),w.INVALID_MODIFICATION_ERR=(P[13]="Invalid modification",13),w.NAMESPACE_ERR=(P[14]="Invalid namespace",14),w.INVALID_ACCESS_ERR=(P[15]="Invalid access",15);function C(e,t){if(t instanceof Error)var i=t;else i=this,Error.call(this,P[e]),this.message=P[e],Error.captureStackTrace&&Error.captureStackTrace(this,C);return i.code=e,t&&(this.message=this.message+": "+t),i}function N(){}function D(e,t){this._node=e,this._refresh=t,L(this)}function L(e){var t=e._node._inc||e._node.ownerDocument._inc;if(e._inc!=t){var i=e._refresh(e._node);le(e,"length",i.length),a(i,e),e._inc=t}}function M(){}function R(e,t){for(var i=e.length;i--;)if(e[i]===t)return i}function A(e,t,i,r){if(r?t[R(t,r)]=i:t[t.length++]=i,e){i.ownerElement=e;var n=e.ownerDocument;n&&(r&&q(n,e,r),function(e,t,i){e&&e._inc++,i.namespaceURI===s.XMLNS&&(t._nsMap[i.prefix?i.localName:""]=i.value)}(n,e,i))}}function O(e,t,i){var s=R(t,i);if(!(s>=0))throw C(T,new Error(e.tagName+"@"+i));for(var r=t.length-1;s<r;)t[s]=t[++s];if(t.length=r,e){var n=e.ownerDocument;n&&(q(n,e,i),i.ownerElement=null)}}function x(){}function k(){}function B(e){return("<"==e?"&lt;":">"==e&&"&gt;")||"&"==e&&"&amp;"||'"'==e&&"&quot;"||"&#"+e.charCodeAt()+";"}function $(e,t){if(t(e))return!0;if(e=e.firstChild)do{if($(e,t))return!0}while(e=e.nextSibling)}function U(){}function q(e,t,i,r){e&&e._inc++,i.namespaceURI===s.XMLNS&&delete t._nsMap[i.prefix?i.localName:""]}function z(e,t,i){if(e&&e._inc){e._inc++;var s=t.childNodes;if(i)s[s.length++]=i;else{for(var r=t.firstChild,n=0;r;)s[n++]=r,r=r.nextSibling;s.length=n}}}function F(e,t){var i=t.previousSibling,s=t.nextSibling;return i?i.nextSibling=s:e.firstChild=s,s?s.previousSibling=i:e.lastChild=i,z(e.ownerDocument,e),t}function H(e,t,i){var s=t.parentNode;if(s&&s.removeChild(t),t.nodeType===b){var r=t.firstChild;if(null==r)return t;var n=t.lastChild}else r=n=t;var o=i?i.previousSibling:e.lastChild;r.previousSibling=o,n.nextSibling=i,o?o.nextSibling=r:e.firstChild=r,null==i?e.lastChild=n:i.previousSibling=n;do{r.parentNode=e}while(r!==n&&(r=r.nextSibling));return z(e.ownerDocument||e,e),t.nodeType==b&&(t.firstChild=t.lastChild=null),t}function W(){this._nsMap={}}function j(){}function G(){}function X(){}function V(){}function Y(){}function J(){}function Q(){}function K(){}function Z(){}function ee(){}function te(){}function ie(){}function se(e,t){var i=[],s=9==this.nodeType&&this.documentElement||this,r=s.prefix,n=s.namespaceURI;if(n&&null==r&&null==(r=s.lookupPrefix(n)))var o=[{namespace:n,prefix:null}];return oe(this,i,e,t,o),i.join("")}function re(e,t,i){var r=e.prefix||"",n=e.namespaceURI;if(!n)return!1;if("xml"===r&&n===s.XML||n===s.XMLNS)return!1;for(var o=i.length;o--;){var a=i[o];if(a.prefix===r)return a.namespace!==n}return!0}function ne(e,t,i){e.push(" ",t,'="',i.replace(/[<&"]/g,B),'"')}function oe(e,t,i,r,n){if(n||(n=[]),r){if(!(e=r(e)))return;if("string"==typeof e)return void t.push(e)}switch(e.nodeType){case c:var o=e.attributes,a=o.length,h=e.firstChild,l=e.tagName,p=l;if(!(i=s.isHTML(e.namespaceURI)||i)&&!e.prefix&&e.namespaceURI){for(var S,w=0;w<o.length;w++)if("xmlns"===o.item(w).name){S=o.item(w).value;break}if(!S)for(var P=n.length-1;P>=0;P--){if(""===(E=n[P]).prefix&&E.namespace===e.namespaceURI){S=E.namespace;break}}if(S!==e.namespaceURI)for(P=n.length-1;P>=0;P--){var E;if((E=n[P]).namespace===e.namespaceURI){E.prefix&&(p=E.prefix+":"+l);break}}}t.push("<",p);for(var T=0;T<a;T++){"xmlns"==(I=o.item(T)).prefix?n.push({prefix:I.localName,namespace:I.value}):"xmlns"==I.nodeName&&n.push({prefix:"",namespace:I.value})}for(T=0;T<a;T++){var I,C,N;if(re(I=o.item(T),0,n))ne(t,(C=I.prefix||"")?"xmlns:"+C:"xmlns",N=I.namespaceURI),n.push({prefix:C,namespace:N});oe(I,t,i,r,n)}if(l===p&&re(e,0,n))ne(t,(C=e.prefix||"")?"xmlns:"+C:"xmlns",N=e.namespaceURI),n.push({prefix:C,namespace:N});if(h||i&&!/^(?:meta|link|img|br|hr|input)$/i.test(l)){if(t.push(">"),i&&/^script$/i.test(l))for(;h;)h.data?t.push(h.data):oe(h,t,i,r,n.slice()),h=h.nextSibling;else for(;h;)oe(h,t,i,r,n.slice()),h=h.nextSibling;t.push("</",p,">")}else t.push("/>");return;case y:case b:for(h=e.firstChild;h;)oe(h,t,i,r,n.slice()),h=h.nextSibling;return;case u:return ne(t,e.name,e.value);case d:return t.push(e.data.replace(/[<&]/g,B).replace(/]]>/g,"]]&gt;"));case f:return t.push("<![CDATA[",e.data,"]]>");case _:return t.push("\x3c!--",e.data,"--\x3e");case v:var D=e.publicId,L=e.systemId;if(t.push("<!DOCTYPE ",e.name),D)t.push(" PUBLIC ",D),L&&"."!=L&&t.push(" ",L),t.push(">");else if(L&&"."!=L)t.push(" SYSTEM ",L,">");else{var M=e.internalSubset;M&&t.push(" [",M,"]"),t.push(">")}return;case m:return t.push("<?",e.target," ",e.data,"?>");case g:return t.push("&",e.nodeName,";");default:t.push("??",e.nodeName)}}function ae(e,t,i){var s;switch(t.nodeType){case c:(s=t.cloneNode(!1)).ownerDocument=e;case b:break;case u:i=!0}if(s||(s=t.cloneNode(!1)),s.ownerDocument=e,s.parentNode=null,i)for(var r=t.firstChild;r;)s.appendChild(ae(e,r,i)),r=r.nextSibling;return s}function he(e,t,i){var s=new t.constructor;for(var r in t){var n=t[r];"object"!=typeof n&&n!=s[r]&&(s[r]=n)}switch(t.childNodes&&(s.childNodes=new N),s.ownerDocument=e,s.nodeType){case c:var o=t.attributes,a=s.attributes=new M,h=o.length;a._ownerElement=s;for(var l=0;l<h;l++)s.setAttributeNode(he(e,o.item(l),!0));break;case u:i=!0}if(i)for(var d=t.firstChild;d;)s.appendChild(he(e,d,i)),d=d.nextSibling;return s}function le(e,t,i){e[t]=i}C.prototype=Error.prototype,a(w,C),N.prototype={length:0,item:function(e){return this[e]||null},toString:function(e,t){for(var i=[],s=0;s<this.length;s++)oe(this[s],i,e,t);return i.join("")}},D.prototype.item=function(e){return L(this),this[e]},h(D,N),M.prototype={length:0,item:N.prototype.item,getNamedItem:function(e){for(var t=this.length;t--;){var i=this[t];if(i.nodeName==e)return i}},setNamedItem:function(e){var t=e.ownerElement;if(t&&t!=this._ownerElement)throw new C(I);var i=this.getNamedItem(e.nodeName);return A(this._ownerElement,this,e,i),i},setNamedItemNS:function(e){var t,i=e.ownerElement;if(i&&i!=this._ownerElement)throw new C(I);return t=this.getNamedItemNS(e.namespaceURI,e.localName),A(this._ownerElement,this,e,t),t},removeNamedItem:function(e){var t=this.getNamedItem(e);return O(this._ownerElement,this,t),t},removeNamedItemNS:function(e,t){var i=this.getNamedItemNS(e,t);return O(this._ownerElement,this,i),i},getNamedItemNS:function(e,t){for(var i=this.length;i--;){var s=this[i];if(s.localName==t&&s.namespaceURI==e)return s}return null}},x.prototype={hasFeature:function(e,t){return!0},createDocument:function(e,t,i){var s=new U;if(s.implementation=this,s.childNodes=new N,s.doctype=i||null,i&&s.appendChild(i),t){var r=s.createElementNS(e,t);s.appendChild(r)}return s},createDocumentType:function(e,t,i){var s=new J;return s.name=e,s.nodeName=e,s.publicId=t||"",s.systemId=i||"",s}},k.prototype={firstChild:null,lastChild:null,previousSibling:null,nextSibling:null,attributes:null,parentNode:null,childNodes:null,ownerDocument:null,nodeValue:null,namespaceURI:null,prefix:null,localName:null,insertBefore:function(e,t){return H(this,e,t)},replaceChild:function(e,t){this.insertBefore(e,t),t&&this.removeChild(t)},removeChild:function(e){return F(this,e)},appendChild:function(e){return this.insertBefore(e,null)},hasChildNodes:function(){return null!=this.firstChild},cloneNode:function(e){return he(this.ownerDocument||this,this,e)},normalize:function(){for(var e=this.firstChild;e;){var t=e.nextSibling;t&&t.nodeType==d&&e.nodeType==d?(this.removeChild(t),e.appendData(t.data)):(e.normalize(),e=t)}},isSupported:function(e,t){return this.ownerDocument.implementation.hasFeature(e,t)},hasAttributes:function(){return this.attributes.length>0},lookupPrefix:function(e){for(var t=this;t;){var i=t._nsMap;if(i)for(var s in i)if(i[s]==e)return s;t=t.nodeType==u?t.ownerDocument:t.parentNode}return null},lookupNamespaceURI:function(e){for(var t=this;t;){var i=t._nsMap;if(i&&e in i)return i[e];t=t.nodeType==u?t.ownerDocument:t.parentNode}return null},isDefaultNamespace:function(e){return null==this.lookupPrefix(e)}},a(l,k),a(l,k.prototype),U.prototype={nodeName:"#document",nodeType:y,doctype:null,documentElement:null,_inc:1,insertBefore:function(e,t){if(e.nodeType==b){for(var i=e.firstChild;i;){var s=i.nextSibling;this.insertBefore(i,t),i=s}return e}return null==this.documentElement&&e.nodeType==c&&(this.documentElement=e),H(this,e,t),e.ownerDocument=this,e},removeChild:function(e){return this.documentElement==e&&(this.documentElement=null),F(this,e)},importNode:function(e,t){return ae(this,e,t)},getElementById:function(e){var t=null;return $(this.documentElement,(function(i){if(i.nodeType==c&&i.getAttribute("id")==e)return t=i,!0})),t},getElementsByClassName:function(e){var t=o(e);return new D(this,(function(i){var s=[];return t.length>0&&$(i.documentElement,(function(r){if(r!==i&&r.nodeType===c){var n=r.getAttribute("class");if(n){var a=e===n;if(!a){var h=o(n);a=t.every((l=h,function(e){return l&&-1!==l.indexOf(e)}))}a&&s.push(r)}}var l})),s}))},createElement:function(e){var t=new W;return t.ownerDocument=this,t.nodeName=e,t.tagName=e,t.localName=e,t.childNodes=new N,(t.attributes=new M)._ownerElement=t,t},createDocumentFragment:function(){var e=new ee;return e.ownerDocument=this,e.childNodes=new N,e},createTextNode:function(e){var t=new X;return t.ownerDocument=this,t.appendData(e),t},createComment:function(e){var t=new V;return t.ownerDocument=this,t.appendData(e),t},createCDATASection:function(e){var t=new Y;return t.ownerDocument=this,t.appendData(e),t},createProcessingInstruction:function(e,t){var i=new te;return i.ownerDocument=this,i.tagName=i.target=e,i.nodeValue=i.data=t,i},createAttribute:function(e){var t=new j;return t.ownerDocument=this,t.name=e,t.nodeName=e,t.localName=e,t.specified=!0,t},createEntityReference:function(e){var t=new Z;return t.ownerDocument=this,t.nodeName=e,t},createElementNS:function(e,t){var i=new W,s=t.split(":"),r=i.attributes=new M;return i.childNodes=new N,i.ownerDocument=this,i.nodeName=t,i.tagName=t,i.namespaceURI=e,2==s.length?(i.prefix=s[0],i.localName=s[1]):i.localName=t,r._ownerElement=i,i},createAttributeNS:function(e,t){var i=new j,s=t.split(":");return i.ownerDocument=this,i.nodeName=t,i.name=t,i.namespaceURI=e,i.specified=!0,2==s.length?(i.prefix=s[0],i.localName=s[1]):i.localName=t,i}},h(U,k),W.prototype={nodeType:c,hasAttribute:function(e){return null!=this.getAttributeNode(e)},getAttribute:function(e){var t=this.getAttributeNode(e);return t&&t.value||""},getAttributeNode:function(e){return this.attributes.getNamedItem(e)},setAttribute:function(e,t){var i=this.ownerDocument.createAttribute(e);i.value=i.nodeValue=""+t,this.setAttributeNode(i)},removeAttribute:function(e){var t=this.getAttributeNode(e);t&&this.removeAttributeNode(t)},appendChild:function(e){return e.nodeType===b?this.insertBefore(e,null):function(e,t){var i=t.parentNode;if(i){var s=e.lastChild;i.removeChild(t),s=e.lastChild}return s=e.lastChild,t.parentNode=e,t.previousSibling=s,t.nextSibling=null,s?s.nextSibling=t:e.firstChild=t,e.lastChild=t,z(e.ownerDocument,e,t),t}(this,e)},setAttributeNode:function(e){return this.attributes.setNamedItem(e)},setAttributeNodeNS:function(e){return this.attributes.setNamedItemNS(e)},removeAttributeNode:function(e){return this.attributes.removeNamedItem(e.nodeName)},removeAttributeNS:function(e,t){var i=this.getAttributeNodeNS(e,t);i&&this.removeAttributeNode(i)},hasAttributeNS:function(e,t){return null!=this.getAttributeNodeNS(e,t)},getAttributeNS:function(e,t){var i=this.getAttributeNodeNS(e,t);return i&&i.value||""},setAttributeNS:function(e,t,i){var s=this.ownerDocument.createAttributeNS(e,t);s.value=s.nodeValue=""+i,this.setAttributeNode(s)},getAttributeNodeNS:function(e,t){return this.attributes.getNamedItemNS(e,t)},getElementsByTagName:function(e){return new D(this,(function(t){var i=[];return $(t,(function(s){s===t||s.nodeType!=c||"*"!==e&&s.tagName!=e||i.push(s)})),i}))},getElementsByTagNameNS:function(e,t){return new D(this,(function(i){var s=[];return $(i,(function(r){r===i||r.nodeType!==c||"*"!==e&&r.namespaceURI!==e||"*"!==t&&r.localName!=t||s.push(r)})),s}))}},U.prototype.getElementsByTagName=W.prototype.getElementsByTagName,U.prototype.getElementsByTagNameNS=W.prototype.getElementsByTagNameNS,h(W,k),j.prototype.nodeType=u,h(j,k),G.prototype={data:"",substringData:function(e,t){return this.data.substring(e,e+t)},appendData:function(e){e=this.data+e,this.nodeValue=this.data=e,this.length=e.length},insertData:function(e,t){this.replaceData(e,0,t)},appendChild:function(e){throw new Error(P[E])},deleteData:function(e,t){this.replaceData(e,t,"")},replaceData:function(e,t,i){i=this.data.substring(0,e)+i+this.data.substring(e+t),this.nodeValue=this.data=i,this.length=i.length}},h(G,k),X.prototype={nodeName:"#text",nodeType:d,splitText:function(e){var t=this.data,i=t.substring(e);t=t.substring(0,e),this.data=this.nodeValue=t,this.length=t.length;var s=this.ownerDocument.createTextNode(i);return this.parentNode&&this.parentNode.insertBefore(s,this.nextSibling),s}},h(X,G),V.prototype={nodeName:"#comment",nodeType:_},h(V,G),Y.prototype={nodeName:"#cdata-section",nodeType:f},h(Y,G),J.prototype.nodeType=v,h(J,k),Q.prototype.nodeType=S,h(Q,k),K.prototype.nodeType=p,h(K,k),Z.prototype.nodeType=g,h(Z,k),ee.prototype.nodeName="#document-fragment",ee.prototype.nodeType=b,h(ee,k),te.prototype.nodeType=m,h(te,k),ie.prototype.serializeToString=function(e,t,i){return se.call(e,t,i)},k.prototype.toString=se;try{if(Object.defineProperty){function ce(e){switch(e.nodeType){case c:case b:var t=[];for(e=e.firstChild;e;)7!==e.nodeType&&8!==e.nodeType&&t.push(ce(e)),e=e.nextSibling;return t.join("");default:return e.nodeValue}}Object.defineProperty(D.prototype,"length",{get:function(){return L(this),this.$$length}}),Object.defineProperty(k.prototype,"textContent",{get:function(){return ce(this)},set:function(e){switch(this.nodeType){case c:case b:for(;this.firstChild;)this.removeChild(this.firstChild);(e||String(e))&&this.appendChild(this.ownerDocument.createTextNode(e));break;default:this.data=e,this.value=e,this.nodeValue=e}}}),le=function(e,t,i){e["$$"+t]=i}}}catch(ue){}t.DocumentType=J,t.DOMException=C,t.DOMImplementation=x,t.Element=W,t.Node=k,t.NodeList=N,t.XMLSerializer=ie},369:(e,t,i)=>{var s=i(539).freeze;t.XML_ENTITIES=s({amp:"&",apos:"'",gt:">",lt:"<",quot:'"'}),t.HTML_ENTITIES=s({lt:"<",gt:">",amp:"&",quot:'"',apos:"'",Agrave:"À",Aacute:"Á",Acirc:"Â",Atilde:"Ã",Auml:"Ä",Aring:"Å",AElig:"Æ",Ccedil:"Ç",Egrave:"È",Eacute:"É",Ecirc:"Ê",Euml:"Ë",Igrave:"Ì",Iacute:"Í",Icirc:"Î",Iuml:"Ï",ETH:"Ð",Ntilde:"Ñ",Ograve:"Ò",Oacute:"Ó",Ocirc:"Ô",Otilde:"Õ",Ouml:"Ö",Oslash:"Ø",Ugrave:"Ù",Uacute:"Ú",Ucirc:"Û",Uuml:"Ü",Yacute:"Ý",THORN:"Þ",szlig:"ß",agrave:"à",aacute:"á",acirc:"â",atilde:"ã",auml:"ä",aring:"å",aelig:"æ",ccedil:"ç",egrave:"è",eacute:"é",ecirc:"ê",euml:"ë",igrave:"ì",iacute:"í",icirc:"î",iuml:"ï",eth:"ð",ntilde:"ñ",ograve:"ò",oacute:"ó",ocirc:"ô",otilde:"õ",ouml:"ö",oslash:"ø",ugrave:"ù",uacute:"ú",ucirc:"û",uuml:"ü",yacute:"ý",thorn:"þ",yuml:"ÿ",nbsp:" ",iexcl:"¡",cent:"¢",pound:"£",curren:"¤",yen:"¥",brvbar:"¦",sect:"§",uml:"¨",copy:"©",ordf:"ª",laquo:"«",not:"¬",shy:"­­",reg:"®",macr:"¯",deg:"°",plusmn:"±",sup2:"²",sup3:"³",acute:"´",micro:"µ",para:"¶",middot:"·",cedil:"¸",sup1:"¹",ordm:"º",raquo:"»",frac14:"¼",frac12:"½",frac34:"¾",iquest:"¿",times:"×",divide:"÷",forall:"∀",part:"∂",exist:"∃",empty:"∅",nabla:"∇",isin:"∈",notin:"∉",ni:"∋",prod:"∏",sum:"∑",minus:"−",lowast:"∗",radic:"√",prop:"∝",infin:"∞",ang:"∠",and:"∧",or:"∨",cap:"∩",cup:"∪",int:"∫",there4:"∴",sim:"∼",cong:"≅",asymp:"≈",ne:"≠",equiv:"≡",le:"≤",ge:"≥",sub:"⊂",sup:"⊃",nsub:"⊄",sube:"⊆",supe:"⊇",oplus:"⊕",otimes:"⊗",perp:"⊥",sdot:"⋅",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigmaf:"ς",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",thetasym:"ϑ",upsih:"ϒ",piv:"ϖ",OElig:"Œ",oelig:"œ",Scaron:"Š",scaron:"š",Yuml:"Ÿ",fnof:"ƒ",circ:"ˆ",tilde:"˜",ensp:" ",emsp:" ",thinsp:" ",zwnj:"‌",zwj:"‍",lrm:"‎",rlm:"‏",ndash:"–",mdash:"—",lsquo:"‘",rsquo:"’",sbquo:"‚",ldquo:"“",rdquo:"”",bdquo:"„",dagger:"†",Dagger:"‡",bull:"•",hellip:"…",permil:"‰",prime:"′",Prime:"″",lsaquo:"‹",rsaquo:"›",oline:"‾",euro:"€",trade:"™",larr:"←",uarr:"↑",rarr:"→",darr:"↓",harr:"↔",crarr:"↵",lceil:"⌈",rceil:"⌉",lfloor:"⌊",rfloor:"⌋",loz:"◊",spades:"♠",clubs:"♣",hearts:"♥",diams:"♦"}),t.entityMap=t.HTML_ENTITIES},716:(e,t,i)=>{var s=i(89);s.DOMImplementation,s.XMLSerializer,t.DOMParser=i(588).DOMParser},835:(e,t,i)=>{var s=i(539).NAMESPACE,r=/[A-Z_a-z\xC0-\xD6\xD8-\xF6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,n=new RegExp("[\\-\\.0-9"+r.source.slice(1,-1)+"\\u00B7\\u0300-\\u036F\\u203F-\\u2040]"),o=new RegExp("^"+r.source+n.source+"*(?::"+r.source+n.source+"*)?$");function a(e,t){this.message=e,this.locator=t,Error.captureStackTrace&&Error.captureStackTrace(this,a)}function h(){}function l(e,t){return t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber,t}function c(e,t,i,r,n,o){function a(e,t,s){i.attributeNames.hasOwnProperty(e)&&o.fatalError("Attribute "+e+" redefined"),i.addValue(e,t,s)}for(var h,l=++t,c=0;;){var u=e.charAt(l);switch(u){case"=":if(1===c)h=e.slice(t,l),c=3;else{if(2!==c)throw new Error("attribute equal must after attrName");c=3}break;case"'":case'"':if(3===c||1===c){if(1===c&&(o.warning('attribute value must after "="'),h=e.slice(t,l)),t=l+1,!((l=e.indexOf(u,t))>0))throw new Error("attribute value no end '"+u+"' match");a(h,d=e.slice(t,l).replace(/&#?\w+;/g,n),t-1),c=5}else{if(4!=c)throw new Error('attribute value must after "="');a(h,d=e.slice(t,l).replace(/&#?\w+;/g,n),t),o.warning('attribute "'+h+'" missed start quot('+u+")!!"),t=l+1,c=5}break;case"/":switch(c){case 0:i.setTagName(e.slice(t,l));case 5:case 6:case 7:c=7,i.closed=!0;case 4:case 1:case 2:break;default:throw new Error("attribute invalid close char('/')")}break;case"":return o.error("unexpected end of input"),0==c&&i.setTagName(e.slice(t,l)),l;case">":switch(c){case 0:i.setTagName(e.slice(t,l));case 5:case 6:case 7:break;case 4:case 1:"/"===(d=e.slice(t,l)).slice(-1)&&(i.closed=!0,d=d.slice(0,-1));case 2:2===c&&(d=h),4==c?(o.warning('attribute "'+d+'" missed quot(")!'),a(h,d.replace(/&#?\w+;/g,n),t)):(s.isHTML(r[""])&&d.match(/^(?:disabled|checked|selected)$/i)||o.warning('attribute "'+d+'" missed value!! "'+d+'" instead!!'),a(d,d,t));break;case 3:throw new Error("attribute value missed!!")}return l;case"":u=" ";default:if(u<=" ")switch(c){case 0:i.setTagName(e.slice(t,l)),c=6;break;case 1:h=e.slice(t,l),c=2;break;case 4:var d=e.slice(t,l).replace(/&#?\w+;/g,n);o.warning('attribute "'+d+'" missed quot(")!!'),a(h,d,t);case 5:c=6}else switch(c){case 2:i.tagName;s.isHTML(r[""])&&h.match(/^(?:disabled|checked|selected)$/i)||o.warning('attribute "'+h+'" missed value!! "'+h+'" instead2!!'),a(h,h,t),t=l,c=1;break;case 5:o.warning('attribute space is required"'+h+'"!!');case 6:c=1,t=l;break;case 3:c=4,t=l;break;case 7:throw new Error("elements closed character '/' and '>' must be connected to")}}l++}}function u(e,t,i){for(var r=e.tagName,n=null,o=e.length;o--;){var a=e[o],h=a.qName,l=a.value;if((f=h.indexOf(":"))>0)var c=a.prefix=h.slice(0,f),u=h.slice(f+1),d="xmlns"===c&&u;else u=h,c=null,d="xmlns"===h&&"";a.localName=u,!1!==d&&(null==n&&(n={},g(i,i={})),i[d]=n[d]=l,a.uri=s.XMLNS,t.startPrefixMapping(d,l))}for(o=e.length;o--;){(c=(a=e[o]).prefix)&&("xml"===c&&(a.uri=s.XML),"xmlns"!==c&&(a.uri=i[c||""]))}var f;(f=r.indexOf(":"))>0?(c=e.prefix=r.slice(0,f),u=e.localName=r.slice(f+1)):(c=null,u=e.localName=r);var p=e.uri=i[c||""];if(t.startElement(p,u,r,e),!e.closed)return e.currentNSMap=i,e.localNSMap=n,!0;if(t.endElement(p,u,r),n)for(c in n)t.endPrefixMapping(c)}function d(e,t,i,s,r){if(/^(?:script|textarea)$/i.test(i)){var n=e.indexOf("</"+i+">",t),o=e.substring(t+1,n);if(/[&<]/.test(o))return/^script$/i.test(i)?(r.characters(o,0,o.length),n):(o=o.replace(/&#?\w+;/g,s),r.characters(o,0,o.length),n)}return t+1}function f(e,t,i,s){var r=s[i];return null==r&&((r=e.lastIndexOf("</"+i+">"))<t&&(r=e.lastIndexOf("</"+i)),s[i]=r),r<t}function g(e,t){for(var i in e)t[i]=e[i]}function p(e,t,i,s){if("-"===e.charAt(t+2))return"-"===e.charAt(t+3)?(r=e.indexOf("--\x3e",t+4))>t?(i.comment(e,t+4,r-t-4),r+3):(s.error("Unclosed comment"),-1):-1;if("CDATA["==e.substr(t+3,6)){var r=e.indexOf("]]>",t+9);return i.startCDATA(),i.characters(e,t+9,r-t-9),i.endCDATA(),r+3}var n=function(e,t){var i,s=[],r=/'[^']+'|"[^"]+"|[^\s<>\/=]+=?|(\/?\s*>|<)/g;r.lastIndex=t,r.exec(e);for(;i=r.exec(e);)if(s.push(i),i[1])return s}(e,t),o=n.length;if(o>1&&/!doctype/i.test(n[0][0])){var a=n[1][0],h=!1,l=!1;o>3&&(/^public$/i.test(n[2][0])?(h=n[3][0],l=o>4&&n[4][0]):/^system$/i.test(n[2][0])&&(l=n[3][0]));var c=n[o-1];return i.startDTD(a,h,l),i.endDTD(),c.index+c[0].length}return-1}function m(e,t,i){var s=e.indexOf("?>",t);if(s){var r=e.substring(t,s).match(/^<\?(\S*)\s*([\s\S]*?)\s*$/);if(r){r[0].length;return i.processingInstruction(r[1],r[2]),s+2}return-1}return-1}function _(){this.attributeNames={}}a.prototype=new Error,a.prototype.name=a.name,h.prototype={parse:function(e,t,i){var r=this.domBuilder;r.startDocument(),g(t,t={}),function(e,t,i,r,n){function o(e){if(e>65535){var t=55296+((e-=65536)>>10),i=56320+(1023&e);return String.fromCharCode(t,i)}return String.fromCharCode(e)}function h(e){var t=e.slice(1,-1);return t in i?i[t]:"#"===t.charAt(0)?o(parseInt(t.substr(1).replace("x","0x"))):(n.error("entity not found:"+e),e)}function g(t){if(t>T){var i=e.substring(T,t).replace(/&#?\w+;/g,h);w&&y(T),r.characters(i,0,t-T),T=t}}function y(t,i){for(;t>=b&&(i=S.exec(e));)v=i.index,b=v+i[0].length,w.lineNumber++;w.columnNumber=t-v+1}var v=0,b=0,S=/.*(?:\r\n?|\n)|.*$/g,w=r.locator,P=[{currentNSMap:t}],E={},T=0;for(;;){try{var I=e.indexOf("<",T);if(I<0){if(!e.substr(T).match(/^\s*$/)){var C=r.doc,N=C.createTextNode(e.substr(T));C.appendChild(N),r.currentElement=N}return}switch(I>T&&g(I),e.charAt(I+1)){case"/":var D=e.indexOf(">",I+3),L=e.substring(I+2,D).replace(/[ \t\n\r]+$/g,""),M=P.pop();D<0?(L=e.substring(I+2).replace(/[\s<].*/,""),n.error("end tag name: "+L+" is not complete:"+M.tagName),D=I+1+L.length):L.match(/\s</)&&(L=L.replace(/[\s<].*/,""),n.error("end tag name: "+L+" maybe not complete"),D=I+1+L.length);var R=M.localNSMap,A=M.tagName==L;if(A||M.tagName&&M.tagName.toLowerCase()==L.toLowerCase()){if(r.endElement(M.uri,M.localName,L),R)for(var O in R)r.endPrefixMapping(O);A||n.fatalError("end tag name: "+L+" is not match the current start tagName:"+M.tagName)}else P.push(M);D++;break;case"?":w&&y(I),D=m(e,I,r);break;case"!":w&&y(I),D=p(e,I,r,n);break;default:w&&y(I);var x=new _,k=P[P.length-1].currentNSMap,B=(D=c(e,I,x,k,h,n),x.length);if(!x.closed&&f(e,D,x.tagName,E)&&(x.closed=!0,i.nbsp||n.warning("unclosed xml attribute")),w&&B){for(var $=l(w,{}),U=0;U<B;U++){var q=x[U];y(q.offset),q.locator=l(w,{})}r.locator=$,u(x,r,k)&&P.push(x),r.locator=w}else u(x,r,k)&&P.push(x);s.isHTML(x.uri)&&!x.closed?D=d(e,D,x.tagName,h,r):D++}}catch(e){if(e instanceof a)throw e;n.error("element parse error: "+e),D=-1}D>T?T=D:g(Math.max(I,T)+1)}}(e,t,i,r,this.errorHandler),r.endDocument()}},_.prototype={setTagName:function(e){if(!o.test(e))throw new Error("invalid tagName:"+e);this.tagName=e},addValue:function(e,t,i){if(!o.test(e))throw new Error("invalid attribute:"+e);this.attributeNames[e]=this.length,this[this.length++]={qName:e,value:t,offset:i}},length:0,getLocalName:function(e){return this[e].localName},getLocator:function(e){return this[e].locator},getQName:function(e){return this[e].qName},getURI:function(e){return this[e].uri},getValue:function(e){return this[e].value}},t.XMLReader=h,t.ParseError=a},204:e=>{"use strict";var t,i="object"==typeof Reflect?Reflect:null,s=i&&"function"==typeof i.apply?i.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};t=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var r=Number.isNaN||function(e){return e!=e};function n(){n.init.call(this)}e.exports=n,e.exports.once=function(e,t){return new Promise((function(i,s){function r(i){e.removeListener(t,n),s(i)}function n(){"function"==typeof e.removeListener&&e.removeListener("error",r),i([].slice.call(arguments))}p(e,t,n,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&p(e,"error",t,i)}(e,r,{once:!0})}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function l(e,t,i,s){var r,n,o,l;if(a(i),void 0===(n=e._events)?(n=e._events=Object.create(null),e._eventsCount=0):(void 0!==n.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),n=e._events),o=n[t]),void 0===o)o=n[t]=i,++e._eventsCount;else if("function"==typeof o?o=n[t]=s?[i,o]:[o,i]:s?o.unshift(i):o.push(i),(r=h(e))>0&&o.length>r&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,l=c,console&&console.warn&&console.warn(l)}return e}function c(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function u(e,t,i){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},r=c.bind(s);return r.listener=i,s.wrapFn=r,r}function d(e,t,i){var s=e._events;if(void 0===s)return[];var r=s[t];return void 0===r?[]:"function"==typeof r?i?[r.listener||r]:[r]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(r):g(r,r.length)}function f(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(e,t){for(var i=new Array(t),s=0;s<t;++s)i[s]=e[s];return i}function p(e,t,i,s){if("function"==typeof e.on)s.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function r(n){s.once&&e.removeEventListener(t,r),i(n)}))}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return h(this)},n.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,n=this._events;if(void 0!==n)r=r&&void 0===n.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var h=n[e];if(void 0===h)return!1;if("function"==typeof h)s(h,this,t);else{var l=h.length,c=g(h,l);for(i=0;i<l;++i)s(c[i],this,t)}return!0},n.prototype.addListener=function(e,t){return l(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return l(this,e,t,!0)},n.prototype.once=function(e,t){return a(t),this.on(e,u(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,u(this,e,t)),this},n.prototype.removeListener=function(e,t){var i,s,r,n,o;if(a(t),void 0===(s=this._events))return this;if(void 0===(i=s[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(r=-1,n=i.length-1;n>=0;n--)if(i[n]===t||i[n].listener===t){o=i[n].listener,r=n;break}if(r<0)return this;0===r?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,r),1===i.length&&(s[e]=i[0]),void 0!==s.removeListener&&this.emit("removeListener",e,o||t)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,i,s;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var r,n=Object.keys(i);for(s=0;s<n.length;++s)"removeListener"!==(r=n[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},n.prototype.listeners=function(e){return d(this,e,!0)},n.prototype.rawListeners=function(e){return d(this,e,!1)},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},n.prototype.listenerCount=f,n.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},622:function(e){var t,i,s,r,n;t=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,i=/^(?=([^\/?#]*))\1([^]*)$/,s=/(?:\/|^)\.(?=\/)/g,r=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,n={buildAbsoluteURL:function(e,t,s){if(s=s||{},e=e.trim(),!(t=t.trim())){if(!s.alwaysNormalize)return e;var r=n.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");return r.path=n.normalizePath(r.path),n.buildURLFromParts(r)}var o=n.parseURL(t);if(!o)throw new Error("Error trying to parse relative URL.");if(o.scheme)return s.alwaysNormalize?(o.path=n.normalizePath(o.path),n.buildURLFromParts(o)):t;var a=n.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var h=i.exec(a.path);a.netLoc=h[1],a.path=h[2]}a.netLoc&&!a.path&&(a.path="/");var l={scheme:a.scheme,netLoc:o.netLoc,path:null,params:o.params,query:o.query,fragment:o.fragment};if(!o.netLoc&&(l.netLoc=a.netLoc,"/"!==o.path[0]))if(o.path){var c=a.path,u=c.substring(0,c.lastIndexOf("/")+1)+o.path;l.path=n.normalizePath(u)}else l.path=a.path,o.params||(l.params=a.params,o.query||(l.query=a.query));return null===l.path&&(l.path=s.alwaysNormalize?n.normalizePath(o.path):o.path),n.buildURLFromParts(l)},parseURL:function(e){var i=t.exec(e);return i?{scheme:i[1]||"",netLoc:i[2]||"",path:i[3]||"",params:i[4]||"",query:i[5]||"",fragment:i[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(s,"");e.length!==(e=e.replace(r,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=n},47:(e,t)=>{"use strict";t.l=r;var i=2147483647;function s(e){if(e>i)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=r.prototype,t}function r(e,t,i){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return a(e)}return n(e,t,i)}function n(e,t,i){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!r.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var i=0|c(e,t),n=s(i),o=n.write(e,t);o!==i&&(n=n.slice(0,o));return n}(e,t);if(ArrayBuffer.isView(e))return h(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(_(e,ArrayBuffer)||e&&_(e.buffer,ArrayBuffer))return function(e,t,i){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(i||0))throw new RangeError('"length" is outside of buffer bounds');var s;s=void 0===t&&void 0===i?new Uint8Array(e):void 0===i?new Uint8Array(e,t):new Uint8Array(e,t,i);return s.__proto__=r.prototype,s}(e,t,i);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return r.from(n,t,i);var o=function(e){if(r.isBuffer(e)){var t=0|l(e.length),i=s(t);return 0===i.length||e.copy(i,0,0,t),i}if(void 0!==e.length)return"number"!=typeof e.length||y(e.length)?s(0):h(e);if("Buffer"===e.type&&Array.isArray(e.data))return h(e.data)}(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return r.from(e[Symbol.toPrimitive]("string"),t,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function o(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function a(e){return o(e),s(e<0?0:0|l(e))}function h(e){for(var t=e.length<0?0:0|l(e.length),i=s(t),r=0;r<t;r+=1)i[r]=255&e[r];return i}function l(e){if(e>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return 0|e}function c(e,t){if(r.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||_(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var i=e.length,s=arguments.length>2&&!0===arguments[2];if(!s&&0===i)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return m(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;default:if(n)return s?-1:m(e).length;t=(""+t).toLowerCase(),n=!0}}function u(e,t,i,s){i=Number(i)||0;const r=e.length-i;s?(s=Number(s))>r&&(s=r):s=r;const n=t.length;let o;for(s>n/2&&(s=n/2),o=0;o<s;++o){const s=parseInt(t.substr(2*o,2),16);if(y(s))return o;e[i+o]=s}return o}function d(e,t,i,s){return p(m(t,e.length-i),e,i,s)}function f(e,t,i,s){return p(function(e){const t=[];for(let i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,s)}function g(e,t,i,s){return p(function(e,t){let i,s,r;const n=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)i=e.charCodeAt(o),s=i>>8,r=i%256,n.push(r),n.push(s);return n}(t,e.length-i),e,i,s)}function p(e,t,i,s){let r;for(r=0;r<s&&!(r+i>=t.length||r>=e.length);++r)t[r+i]=e[r];return r}function m(e,t){var i;t=t||1/0;for(var s=e.length,r=null,n=[],o=0;o<s;++o){if((i=e.charCodeAt(o))>55295&&i<57344){if(!r){if(i>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(o+1===s){(t-=3)>-1&&n.push(239,191,189);continue}r=i;continue}if(i<56320){(t-=3)>-1&&n.push(239,191,189),r=i;continue}i=65536+(r-55296<<10|i-56320)}else r&&(t-=3)>-1&&n.push(239,191,189);if(r=null,i<128){if((t-=1)<0)break;n.push(i)}else if(i<2048){if((t-=2)<0)break;n.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;n.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return n}function _(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function y(e){return e!=e}"undefined"!=typeof Symbol&&null!=Symbol.species&&r[Symbol.species]===r&&Object.defineProperty(r,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),r.from=function(e,t,i){return n(e,t,i)},r.prototype.__proto__=Uint8Array.prototype,r.__proto__=Uint8Array,r.alloc=function(e,t,i){return function(e,t,i){return o(e),e<=0?s(e):void 0!==t?"string"==typeof i?s(e).fill(t,i):s(e).fill(t):s(e)}(e,t,i)},r.allocUnsafe=function(e){return a(e)},r.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==r.prototype},r.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},r.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return r.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var s=r.allocUnsafe(t),n=0;for(i=0;i<e.length;++i){var o=e[i];if(_(o,Uint8Array)&&(o=r.from(o)),!r.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(s,n),n+=o.length}return s},r.byteLength=c,r.prototype._isBuffer=!0,r.prototype.copy=function(e,t,i,s){if(!r.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),s||0===s||(s=this.length),t>=e.length&&(t=e.length),t||(t=0),s>0&&s<i&&(s=i),s===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),e.length-t<s-i&&(s=e.length-t+i);var n=s-i;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,i,s);else if(this===e&&i<t&&t<s)for(var o=n-1;o>=0;--o)e[o+t]=this[o+i];else Uint8Array.prototype.set.call(e,this.subarray(i,s),t);return n},r.prototype.write=function(e,t,i,s){if(void 0===t)s="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)s=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(i)?(i>>>=0,void 0===s&&(s="utf8")):(s=i,i=void 0)}const r=this.length-t;if((void 0===i||i>r)&&(i=r),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");let n=!1;for(;;)switch(s){case"hex":return u(this,e,t,i);case"utf8":case"utf-8":return d(this,e,t,i);case"ascii":case"latin1":case"binary":return f(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return g(this,e,t,i);default:if(n)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),n=!0}}},934:e=>{"use strict";function t(e,t){for(const i in t)Object.defineProperty(e,i,{value:t[i],enumerable:!0,configurable:!0});return e}e.exports=function(e,i,s){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");s||(s={}),"object"==typeof i&&(s=i,i=void 0),null!=i&&(s.code=i);try{return t(e,s)}catch(i){s.message=e.message,s.stack=e.stack;const r=function(){};return r.prototype=Object.create(Object.getPrototypeOf(e)),t(new r,s)}}},485:function(e,t,i){var s;!function(r){"use strict";function n(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function o(e,t,i,s,r,o){return n((a=n(n(t,e),n(s,o)))<<(h=r)|a>>>32-h,i);var a,h}function a(e,t,i,s,r,n,a){return o(t&i|~t&s,e,t,r,n,a)}function h(e,t,i,s,r,n,a){return o(t&s|i&~s,e,t,r,n,a)}function l(e,t,i,s,r,n,a){return o(t^i^s,e,t,r,n,a)}function c(e,t,i,s,r,n,a){return o(i^(t|~s),e,t,r,n,a)}function u(e,t){var i,s,r,o,u;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var d=1732584193,f=-271733879,g=-1732584194,p=271733878;for(i=0;i<e.length;i+=16)s=d,r=f,o=g,u=p,d=a(d,f,g,p,e[i],7,-680876936),p=a(p,d,f,g,e[i+1],12,-389564586),g=a(g,p,d,f,e[i+2],17,606105819),f=a(f,g,p,d,e[i+3],22,-1044525330),d=a(d,f,g,p,e[i+4],7,-176418897),p=a(p,d,f,g,e[i+5],12,1200080426),g=a(g,p,d,f,e[i+6],17,-1473231341),f=a(f,g,p,d,e[i+7],22,-45705983),d=a(d,f,g,p,e[i+8],7,1770035416),p=a(p,d,f,g,e[i+9],12,-1958414417),g=a(g,p,d,f,e[i+10],17,-42063),f=a(f,g,p,d,e[i+11],22,-1990404162),d=a(d,f,g,p,e[i+12],7,1804603682),p=a(p,d,f,g,e[i+13],12,-40341101),g=a(g,p,d,f,e[i+14],17,-1502002290),d=h(d,f=a(f,g,p,d,e[i+15],22,1236535329),g,p,e[i+1],5,-165796510),p=h(p,d,f,g,e[i+6],9,-1069501632),g=h(g,p,d,f,e[i+11],14,643717713),f=h(f,g,p,d,e[i],20,-373897302),d=h(d,f,g,p,e[i+5],5,-701558691),p=h(p,d,f,g,e[i+10],9,38016083),g=h(g,p,d,f,e[i+15],14,-660478335),f=h(f,g,p,d,e[i+4],20,-405537848),d=h(d,f,g,p,e[i+9],5,568446438),p=h(p,d,f,g,e[i+14],9,-1019803690),g=h(g,p,d,f,e[i+3],14,-187363961),f=h(f,g,p,d,e[i+8],20,1163531501),d=h(d,f,g,p,e[i+13],5,-1444681467),p=h(p,d,f,g,e[i+2],9,-51403784),g=h(g,p,d,f,e[i+7],14,1735328473),d=l(d,f=h(f,g,p,d,e[i+12],20,-1926607734),g,p,e[i+5],4,-378558),p=l(p,d,f,g,e[i+8],11,-2022574463),g=l(g,p,d,f,e[i+11],16,1839030562),f=l(f,g,p,d,e[i+14],23,-35309556),d=l(d,f,g,p,e[i+1],4,-1530992060),p=l(p,d,f,g,e[i+4],11,1272893353),g=l(g,p,d,f,e[i+7],16,-155497632),f=l(f,g,p,d,e[i+10],23,-1094730640),d=l(d,f,g,p,e[i+13],4,681279174),p=l(p,d,f,g,e[i],11,-358537222),g=l(g,p,d,f,e[i+3],16,-722521979),f=l(f,g,p,d,e[i+6],23,76029189),d=l(d,f,g,p,e[i+9],4,-640364487),p=l(p,d,f,g,e[i+12],11,-421815835),g=l(g,p,d,f,e[i+15],16,530742520),d=c(d,f=l(f,g,p,d,e[i+2],23,-995338651),g,p,e[i],6,-198630844),p=c(p,d,f,g,e[i+7],10,1126891415),g=c(g,p,d,f,e[i+14],15,-1416354905),f=c(f,g,p,d,e[i+5],21,-57434055),d=c(d,f,g,p,e[i+12],6,1700485571),p=c(p,d,f,g,e[i+3],10,-1894986606),g=c(g,p,d,f,e[i+10],15,-1051523),f=c(f,g,p,d,e[i+1],21,-2054922799),d=c(d,f,g,p,e[i+8],6,1873313359),p=c(p,d,f,g,e[i+15],10,-30611744),g=c(g,p,d,f,e[i+6],15,-1560198380),f=c(f,g,p,d,e[i+13],21,1309151649),d=c(d,f,g,p,e[i+4],6,-145523070),p=c(p,d,f,g,e[i+11],10,-1120210379),g=c(g,p,d,f,e[i+2],15,718787259),f=c(f,g,p,d,e[i+9],21,-343485551),d=n(d,s),f=n(f,r),g=n(g,o),p=n(p,u);return[d,f,g,p]}function d(e){var t,i="",s=32*e.length;for(t=0;t<s;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function f(e){var t,i=[];for(i[(e.length>>2)-1]=void 0,t=0;t<i.length;t+=1)i[t]=0;var s=8*e.length;for(t=0;t<s;t+=8)i[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return i}function g(e){var t,i,s="0123456789abcdef",r="";for(i=0;i<e.length;i+=1)t=e.charCodeAt(i),r+=s.charAt(t>>>4&15)+s.charAt(15&t);return r}function p(e){return unescape(encodeURIComponent(e))}function m(e){return function(e){return d(u(f(e),8*e.length))}(p(e))}function _(e,t){return function(e,t){var i,s,r=f(e),n=[],o=[];for(n[15]=o[15]=void 0,r.length>16&&(r=u(r,8*e.length)),i=0;i<16;i+=1)n[i]=909522486^r[i],o[i]=1549556828^r[i];return s=u(n.concat(f(t)),512+8*t.length),d(u(o.concat(s),640))}(p(e),p(t))}function y(e,t,i){return t?i?_(t,e):g(_(t,e)):i?m(e):g(m(e))}void 0===(s=function(){return y}.call(t,i,t,e))||(e.exports=s)}()},422:e=>{const t={ANDROID_WEB:"android-web",IOS_WEB:"iOS-web",PC_NATIVE:"PC-native",PC_WEB:"PC-web"};var i={getNetType:function(){let e=(new RegExp("nettype\\/(\\w*)").exec(s())||[,""])[1].toLowerCase();if(!e&&navigator.connection){switch(navigator.connection.type){case"ethernet":e="ethernet";break;case"cellular":e="cellular";break;default:e="wifi"}}return e},getPlatform:function(){return i.isAndroid()?t.ANDROID_WEB:i.isIOS()?t.IOS_WEB:i.isElectron()?t.PC_NATIVE:t.PC_WEB},isX5:function(){return this.isAndroid()&&/\s(TBS|X5Core)\/[\w\.\-]+/i.test(s())},isPC:function(){return!n(r("os "))&&!n(r("android[/ ]"))},isIOS:function(){return n(r("os "))},isAndroid:function(){return n(r("android[/ ]"))},isIOSSafari:function(){return this.isIOS()&&this.isSafari()},isElectron:function(){return/electron/i.test(s())},isMobile:function(){return i.isAndroid()||i.isIOS()},isSafari:function(){return/^((?!chrome|android).)*safari/i.test(s())},isFirefox:function(){return/firefox/i.test(s())},isChrome:function(){return/chrome/i.test(s())},isLocalHost:function(){return"localhost"===location.hostname},device:t,getBrowser:function(){return i.isX5()?"X5":i.isChrome()?"Chrome":i.isFirefox()?"Firefox":i.isIOSSafari()?"iOS-Safari":i.isSafari()?"Mac-Safari":"Unknown"}};function s(){return navigator.userAgent.toLowerCase()}function r(e){return""+(new RegExp(e+"(\\d+((\\.|_)\\d+)*)").exec(s())||[,0])[1]||void 0}function n(e){return parseFloat((e||"").replace(/\_/g,"."))||0}e.exports=i},77:e=>{let t;e.exports="function"==typeof queueMicrotask?queueMicrotask.bind(globalThis):e=>(t||(t=Promise.resolve())).then(e).catch((e=>setTimeout((()=>{throw e}),0)))}},t={};function i(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,i),n.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s={};return(()=>{"use strict";i.d(s,{default:()=>ji});var e=i(622),t=i.n(e),r=i(47);const n=64e3;function o(){return!0}function a(){return Date.parse(new Date)/1e3}function h(e,t){return parseInt(Math.random()*(t-e+1)+e,10)}function l(e,t,i,s=3500){const r=new XMLHttpRequest;return new Promise(((n,o)=>{r.open("GET",e,!0),r.responseType="arraybuffer",r.timeout=s,r.onreadystatechange=e=>{if(4===r.readyState){const e=r.status;206===e?n(r.response):o(`status ${e}`)}},r.onerror=e=>{o("request error")},r.ontimeout=e=>{o("timeout")},r.setRequestHeader("Range",t||"bytes=0-0"),i&&i(r,e),r.send()})).catch((e=>{}))}function c(){if("undefined"==typeof window)return null;var e={RTCPeerConnection:window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCSessionDescription:window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,RTCIceCandidate:window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate};return e.RTCPeerConnection?e:null}function u(){return location.protocol.startsWith("https")}function d(e,t){const i=e.byteLength-t,s=[];let o=t,a=Math.floor(i/n),h=i%n;for(let t=0;t<a;t++){const t=(0,r.l)(n);e.copy(t,0,o,o+n),s.push(t),o+=n}if(h>0){const t=(0,r.l)(h);e.copy(t,0,o,o+h),s.push(t)}return s}function f(e,t){if(e.size<=t)return;const i=[...e.keys()];do{e.delete(i.shift())}while(e.size>t)}function g(e,t){if(e.size<=t)return;const i=[...e.values()];do{e.delete(i.shift())}while(e.size>t)}function p(e){return e instanceof ArrayBuffer&&0!==e.byteLength}var m=i(204),_=i.n(m),y=i(77),v=i.n(y);const b=65536;function S(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}class w extends(_()){constructor(e){super(),this.channelName=e.initiator?e.channelName:null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||w.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},w.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||5e3,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=e.wrtc&&"object"==typeof e.wrtc?e.wrtc:c(),this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(e){return void v()((()=>this.destroy(e)))}this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this._needsNegotiation()}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}signal(e){if(!this.destroyed){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}e.renegotiate&&this.initiator&&this._needsNegotiation(),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((e=>{this._addIceCandidate(e)})),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((e=>{this.destroy(e)})),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.destroy(new Error("signal() called with invalid signal data"))}}_addIceCandidate(e){const t=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch((e=>{var i;!t.address||t.address.endsWith(".local")?(i="Ignoring unsupported ICE candidate.",console.warn(i)):this.destroy(e)}))}send(e){this._channel.send(e)}_needsNegotiation(){this._batchedNegotiation||(this._batchedNegotiation=!0,v()((()=>{this._batchedNegotiation=!1,!this.initiator&&this._firstNegotiation||this.negotiate(),this._firstNegotiation=!1})))}negotiate(){this.initiator?this._isNegotiating?this._queuedNegotiation=!0:setTimeout((()=>{this._createOffer()}),0):this._isNegotiating?this._queuedNegotiation=!0:this.emit("signal",{type:"renegotiate",renegotiate:!0}),this._isNegotiating=!0}destroy(e){this._destroy(e)}_destroy(e){this.destroyed||this.destroying||(this.destroying=!0,v()((()=>{if(this.destroyed=!0,this.destroying=!1,this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")})))}_setupData(e){if(!e.channel)return this.destroy(new Error("Data channel event is missing `channel` property"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=b),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=e=>{this.destroy(e)};let t=!1;this._closingInterval=setInterval((()=>{this._channel&&"closing"===this._channel.readyState?(t&&this._onChannelClose(),t=!0):t=!1}),5e3)}get isBufferedAmountHigh(){return this._channel.bufferedAmount>b}write(e,t){if(this.destroyed)return t(new Error("cannot write after peer is destroyed"));if(this._connected){try{this.send(e)}catch(e){return this.destroy(e)}this.isBufferedAmountHigh?this._cb=t:t(null)}else this._chunk=e,this._cb=t}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=S(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(e)}))})).catch((e=>{this.destroy(e)}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=S(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(e)}))})).catch((e=>{this.destroy(e)}))}_onConnectionStateChange(){this.destroyed||"failed"===this._pc.connectionState&&this.destroy(new Error("Connection failed."))}_onIceStateChange(){if(this.destroyed)return;const e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.destroy(new Error("Ice connection failed.")),"closed"===e&&this.destroy(new Error("Ice connection closed."))}getStats(e){const t=e=>("[object Array]"===Object.prototype.toString.call(e.values)&&e.values.forEach((t=>{Object.assign(e,t)})),e);0===this._pc.getStats.length?this._pc.getStats().then((i=>{const s=[];i.forEach((e=>{s.push(t(e))})),e(null,s)}),(t=>e(t))):this._pc.getStats.length>0?this._pc.getStats((i=>{if(this.destroyed)return;const s=[];i.result().forEach((e=>{const i={};e.names().forEach((t=>{i[t]=e.stat(t)})),i.id=e.id,i.type=e.type,i.timestamp=e.timestamp,s.push(t(i))})),e(null,s)}),(t=>e(t))):e(null,[])}_maybeReady(){if(this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this.getStats(((t,i)=>{if(this.destroyed)return;t&&(i=[]);const s={},r={},n={};let o=!1;i.forEach((e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(s[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(r[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(n[e.id]=e)}));const a=e=>{o=!0;let t=r[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let i=s[e.remoteCandidateId];i&&(i.ip||i.address)?(this.remoteAddress=i.ip||i.address,this.remotePort=Number(i.port)):i&&i.ipAddress?(this.remoteAddress=i.ipAddress,this.remotePort=Number(i.portNumber)):"string"==typeof e.googRemoteAddress&&(i=e.googRemoteAddress.split(":"),this.remoteAddress=i[0],this.remotePort=Number(i[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4")};if(i.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId&&a(n[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&a(e)})),o||Object.keys(n).length&&!Object.keys(r).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(t){return this.destroy(t)}this._chunk=null;const e=this._cb;this._cb=null,e(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this.emit("connect")}else setTimeout(e,100)}))};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>b||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._sendersAwaitingStable.forEach((e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._queuedNegotiation=!1,this._needsNegotiation()):this.emit("negotiated")),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;t instanceof ArrayBuffer&&(t=r.l.from(t)),this.emit("data",t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;const e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||this.destroy()}}w.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},w.channelConfig={};const P=w,E={DC_SIGNAL:"SIGNAL",DC_OPEN:"OPEN",DC_REQUEST:"REQUEST",DC_SEND_REQUEST:"SEND_REQUEST",DC_PIECE_NOT_FOUND:"PIECE_NOT_FOUND",DC_PIECE_ABORT:"PIECE_ABORT",DC_PIECE_CANCEL:"PIECE_CANCEL",DC_CLOSE:"CLOSE",DC_RESPONSE:"RESPONSE",DC_ERROR:"ERROR",DC_PIECE:"PIECE",DC_PIECE_DATA:"PIECE_DATA",DC_TIMEOUT:"TIMEOUT",DC_PIECE_ACK:"PIECE_ACK",DC_METADATA:"METADATA",DC_PLAT_ANDROID:"ANDROID",DC_PLAT_IOS:"IOS",DC_PLAT_WEB:"WEB",DC_CHOKE:"CHOKE",DC_UNCHOKE:"UNCHOKE",DC_HAVE:"HAVE",DC_HAVE_REVERSE:"HAVE_REVERSE",DC_LOST:"LOST",DC_GET_PEERS:"GET_PEERS",DC_PEERS:"PEERS",DC_STATS:"STATS",DC_PEER_SIGNAL:"PEER_SIGNAL",DC_PLAYLIST:"PLAYLIST",BM_LOST:"lost",BM_ADDED_SEG_:"BM_ADDED_SEG_",BM_ADDED_SN_:"BM_ADDED_SN_",BM_SEG_ADDED:"BM_SEG_ADDED",FRAG_CHANGED:"FRAG_CHANGED",FRAG_LOADED:"FRAG_LOADED",FRAG_LOADING:"FRAG_LOADING",RESTART_P2P:"RESTART_P2P",EXCEPTION:"exception",REQUESTING_MAP_HAVE:"REQUESTING_MAP_HAVE",BUILDER_MAP_HAVE:"BUILDER_MAP_HAVE",SYN_OUTPUT:"SYN_OUTPUT",SYN_ERROR:"SYN_ERROR",SYN_PARTIAL:"SYN_PARTIAL"};class T{constructor(e,t,i,s,r=0){this.sn=e,this.segId=t,this.data=i,this.fromPeerId=s,this.level=r||0}static fromSegment(e){return new T(e.sn,e.segId,e.data,e.fromPeerId,e.level)}get size(){return this.data.byteLength}get isSequential(){return this.sn>=0}}var I=i(422),C=i.n(I);class N extends(_()){static get defaultPacketSize(){return n}static get VERSION(){return"8"}constructor(e,t,i,s,r,o={}){super(),this.channel=e.fetcher.channelId,this.logger=e.logger,this.config=r,this.isInitiator=s,this.options=o,this.intermediator=o.intermediator||null,this.signalMsgs=[],this.assignPeerId(t,i),this.platform="unknown",this.super=!1,this.mobile=!1,this.mobileWeb=!1,this.mobileNet=!1,this.connected=!1,this.msgQueue=[],this.miss=0,this.notifySet=new Set,this.bufArr=[],this.packetSize=n,this.sendReqQueue=[],this.downloading=!1,this.uploading=!1,this.choked=!1,this.streamListeners=[],this.pieceMsg={},this.uploadInterrupter={targetSegId:void 0,currentSegId:void 0,canceled:!1},this.datasToSend=[],this.bytesUploaded=0,this.dataWriting=!1,this.timeSendRequest=0,this.timeReceivePiece=0,this.timeSendPiece=0,this.weight=0,this.peersConnected=1,this.uploadSpeed=0,this.gotPeers=!1,this.currentLevel=0,this.currentPos=0,this.useBackupSignal=!1,this.webRTCConfig={};const{stuns:a}=this.options;if(a&&a.length>0){const e=[];a.forEach((t=>{this.logger.info(`use stun ${t}`),e.push({urls:t})})),this.webRTCConfig.iceServers=e}this.config.webRTCConfig&&(this.webRTCConfig={...this.config.webRTCConfig,...this.webRTCConfig}),this.playlistMap=new Map,this._initPeerChannel(),this.notFatalClosed=!1,this.startSN=Number.MAX_SAFE_INTEGER,this.endSN=-1,this._loadedBytes=0}assignPeerId(e,t){this.remotePeerId=t,this.channelId=this.isInitiator?`${e}-${t}`:`${t}-${e}`,t&&(this.timeJoin=a(),this.dataExchangeTs=this.timeJoin,this.gotStatsTs=this.timeJoin,this._startTimer()),setTimeout((()=>{for(let e of this.signalMsgs)this.emit(E.DC_SIGNAL,e,!0)}),0)}_startTimer(){this.connTimeout=setTimeout((()=>{this.logger.warn(`dc ${this.channelId} connection timeout`),this.emit(E.DC_TIMEOUT)}),25e3)}get isAvailable(){return this.downloadNum<2&&!this.choked}get isAvailableUrgently(){return!this.downloading&&!this.choked}cancelDownload(e,t,i){if(i&&this.downloading&&!(this.streamListeners.length>0||this.remainAttachments<=2))return this.logger.info(`cancel download ${i} remain packets ${this.remainAttachments}`),this.timeReceivePiece=0,this.sendJson({event:E.DC_PIECE_CANCEL,sn:e,level:t,seg_id:i})}addStreamListener(e,t,i){this.streamListeners.push({handler:i,peerId:t})}removeStreamListener(e){this.streamListeners=this.streamListeners.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)))}_initPeerChannel(){const e=new P({initiator:this.isInitiator,trickle:this.options.trickle||!1,config:this.webRTCConfig});this._datachannel=e,e.on("error",(e=>{let t=!0;"Ice connection failed."===e.message&&this.notFatalClosed&&(t=!1),this.emit(E.DC_ERROR,t)})),e.on("signal",(e=>{this.signalMsgs.push(e),this.emit(E.DC_SIGNAL,e)}));e.on("connect",(()=>{for(this.logger.info(`datachannel CONNECTED to ${this.remotePeerId} from ${this.intermediator?"peer":"server"}`),this.connected=!0,clearTimeout(this.connTimeout),this.signalMsgs=[],this.emit(E.DC_OPEN);this.msgQueue.length>0;){let e=this.msgQueue.shift();this.emit(e.event,e)}})),e.on("data",(e=>{const{logger:t}=this;if("string"==typeof e){let i=JSON.parse(e);if(!this.connected)return void this.msgQueue.push(i);let s,r=i.event;switch(s=r!==E.DC_PLAYLIST&&r!==E.DC_PEER_SIGNAL?`string: ${e}`:`event: ${r}`,t.debug(`datachannel receive ${s} from ${this.remotePeerId}`),r){case E.DC_HAVE:if(this.emit(i.event,i),!i.sn)return;this.config.live||(i.sn<this.startSN&&(this.startSN=i.sn),i.sn>this.endSN&&(this.endSN=i.sn));break;case E.DC_PIECE:this.downloading=!0,this.dataExchangeTs=a(),this.timeReceivePiece=performance.now(),this.pieceMsg=i,this._prepareForBinary(i.attachments,i.seg_id,i.sn,i.size),this.emit(i.event,i);break;case E.DC_PIECE_CANCEL:this.uploadInterrupter.targetSegId=i.seg_id,this.emit(i.event,i);break;case E.DC_PIECE_NOT_FOUND:this._sendNextReq()||(this.downloading=!1),this.emit(i.event,i);break;case E.DC_REQUEST:this._handleRequestMsg(i);break;case E.DC_PIECE_ACK:this.uploadInterrupter.canceled||(this._handlePieceAck(i.size,i.miss),this.emit(i.event,i));break;case E.DC_STATS:this._handleStats(i);break;case E.DC_PLAYLIST:this.config.sharePlaylist&&this._handlePlaylist(i);break;case E.DC_METADATA:this._handleMetadata(i);break;case E.DC_PIECE_ABORT:this.downloading&&(this._notifyDownloadListenersAbort("aborted by upstream peer"),this.emit(E.DC_PIECE_ABORT,i));break;case E.DC_CHOKE:t.info(`choke peer ${this.remotePeerId}`),this.choked=!0;break;case E.DC_UNCHOKE:t.info(`unchoke peer ${this.remotePeerId}`),this.choked=!1;break;case E.DC_CLOSE:this.emit(i.event,i.fatal||!1);break;default:this.emit(i.event,i)}}else{if(!e)return void t.error("datachannel on data is undefined!");if(!this.downloading)return void t.warn(`peer not downloading, data size ${e.byteLength} pieceMsg ${JSON.stringify(this.pieceMsg)}`);this._handleBinaryMsg(e)}})),e.once("close",(()=>{this.emit(E.DC_CLOSE,!1)})),e.on("iceStateChange",((e,t)=>{"disconnected"===e&&(this.logger.warn(`${this.remotePeerId} disconnected`),this.connected=!1)}))}sendJson(e){e.event!==E.DC_PLAYLIST&&e.event!==E.DC_PEER_SIGNAL?this.logger.debug(`dc bufferSize ${this._datachannel.bufferSize} send ${JSON.stringify(e)} to ${this.remotePeerId}`):this.logger.debug(`dc send event ${e.event} to ${this.remotePeerId}`);const t=JSON.stringify(e);return t.length>n?(this.logger.error("string to send is too large"),!1):this.send(t,!1)}send(e,t=!0){return t?(this.datasToSend.push(e),this.dataWriting||this._sendDataSync(),!0):this.sendImmediately(e)}_checkIfNeedInterrupt(){const{targetSegId:e,currentSegId:t,canceled:i}=this.uploadInterrupter;return!!i||!(!e||e!==t)&&(this.logger.info("cancel send data"),this.sendMsgPieceAbort(`${t} transfer canceled`),this.datasToSend=[],this.uploadInterrupter.canceled=!0,this._handlePieceAck(this.bytesUploaded,0),this.emit(E.DC_PIECE_ACK,{seg_id:t,size:this.bytesUploaded,canceled:!0}),!0)}_sendDataSync(){if(this._checkIfNeedInterrupt()||0===this.datasToSend.length)return void(this.dataWriting=!1);this.dataWriting=!0;const e=this.datasToSend.shift();e?(this.bytesUploaded+=e.byteLength,this._datachannel.write(e,(e=>{if(e)return this.dataWriting=!1,this.logger.warn(e.message),void this.emit(E.DC_ERROR,!1);this._sendDataSync()}))):this.logger.error("sendDataSync data is undefined!")}sendImmediately(e){if(this._datachannel.connected)try{return this._datachannel.send(e),!0}catch(e){this.logger.warn(`datachannel ${this.channelId} send data failed, close it`),this.emit(E.DC_ERROR,!1)}return!1}sendMsgHave(e,t,i={}){const s=i.reverse||void 0;delete i.reverse,this.sendJson({event:s?E.DC_HAVE_REVERSE:E.DC_HAVE,sn:e,seg_id:t,...i})}sendPieceNotFound(e,t,i={}){this.uploading=!1,this.sendJson({event:E.DC_PIECE_NOT_FOUND,seg_id:t,sn:e,...i})}sendPeers(e){this.sendJson({event:E.DC_PEERS,peers:e})}sendPeersRequest(){this.sendJson({event:E.DC_GET_PEERS})}sendMsgStats(e,t={}){const i={event:E.DC_STATS,total_conns:e,...t};this.sendJson(i)}sendMsgPlaylist(e,t,i){const s=this.playlistMap.get(e);if(s&&s.seq>=i)return;const r={event:E.DC_PLAYLIST,url:e,data:t,seq:i};this.playlistMap.set(e,{data:t,seq:i}),this.sendJson(r)}sendMsgSignal(e,t,i){return this.sendJson({event:E.DC_PEER_SIGNAL,action:"signal",to_peer_id:e,from_peer_id:t,data:i})}sendMsgSignalReject(e,t,i,s=!1){return this.sendJson({event:E.DC_PEER_SIGNAL,action:"reject",to_peer_id:e,from_peer_id:t,reason:i,fatal:s})}sendMetaData(e,t,i,s=!1){this.isInitiator&&(this.timeSendRequest=performance.now()),this.sendJson({event:E.DC_METADATA,field:e,platform:E.DC_PLAT_WEB,mobile:!!C().isMobile(),mobile_net:s,channel:this.channel,version:"0.5.0",sequential:t,peers:i})}sendPartialBuffer(e,t,i={}){this.sendMsgPiece(e,i);for(let e=0;e<t.length;e++)this.send(t[e])}sendMsgPiece(e,t={}){const{targetSegId:i}=this.uploadInterrupter;if(i&&i===e.seg_id)return this.logger.info("cancel send piece msg"),this.sendMsgPieceAbort(`${i} piece canceled`),void(this.uploadInterrupter.canceled=!0);this.uploadInterrupter={currentSegId:e.seg_id,targetSegId:void 0,canceled:!1},this.datasToSend=[],this.bytesUploaded=0,e.ext||(e.ext={}),e.ext.from&&t.from&&(t.from=`${e.ext.from}->${t.from}`),t.incompletes&&e.ext.incompletes&&(t.incompletes+=e.ext.incompletes),t=Object.assign({},e.ext,t);const s={...e,ext:t};this.sendJson(s)}sendBuffer(e,t,i,s={}){const r=s.reverse||void 0;if(delete s.reverse,!i)return void this.logger.error("sendBuffer payload is undefined!");let n=i.byteLength,o=0,a=0;n%this.packetSize==0?a=n/this.packetSize:(a=Math.floor(n/this.packetSize)+1,o=n%this.packetSize);let h={event:E.DC_PIECE,attachments:a,seg_id:t,sn:e,level:s.level,size:n,reverse:r};delete s.level,this.sendMsgPiece(h,s);const l=function(e,t,i,s){let r=[];if(s){let n;for(let s=0;s<i-1;s++)n=e.slice(s*t,(s+1)*t),r.push(n);n=e.slice(e.byteLength-s,e.byteLength),r.push(n)}else{let s;for(let n=0;n<i;n++)s=e.slice(n*t,(n+1)*t),r.push(s)}return r}(i,this.packetSize,a,o);this._sendBufferArray(l,r),this.uploading=!1,this.timeSendPiece=performance.now()}get downloadNum(){return this.downloading?this.sendReqQueue.length+1:0}requestDataById(e,t,i=!1,s={}){const r={event:E.DC_REQUEST,seg_id:e,sn:t,...s,urgent:i};this.downloading?(this.logger.info(`${this.remotePeerId} add req ${e} in queue`),i?this.sendReqQueue.unshift(r):this.sendReqQueue.push(r)):this._realRequestData(r)}requestDataBySN(e,t=!1,i={}){const s={event:E.DC_REQUEST,sn:e,...i,urgent:t};this.downloading?(this.logger.info(`add req ${e} in queue`),t?this.sendReqQueue.unshift(s):this.sendReqQueue.push(s)):this._realRequestData(s)}_sendBufferArray(e,t=!1){const i=t?e.reverse():e;for(let e=0;e<i.length;e++)this.send(i[e])}_realRequestData(e){this.sendJson(e),this.timeSendRequest=performance.now(),this.downloading=!0,this.emit(E.DC_SEND_REQUEST)}shouldWaitForRemain(e){return 0!==this.bufArrSize&&(0!==this.timeReceivePiece&&this.currentLoadSpeed()>=this.minRequiredSpeed(e))}close(e){e||(this.notFatalClosed=!0),this.emit(E.DC_CLOSE,e)}receiveSignal(e){e&&this._datachannel.signal(e)}_notifyDownloadListenersAbort(e){for(let t of this.streamListeners){const{handler:i}=t;i(void 0,void 0,!0,e)}this.streamListeners=[]}destroy(e=!0){this.logger.info(`destroy datachannel ${this.channelId}`),this.chokeTimer&&clearTimeout(this.chokeTimer),this.connTimeout&&clearTimeout(this.connTimeout),this.uploading&&this.sendMsgPieceAbort("peer is closing"),this._notifyDownloadListenersAbort("upstream peer is closed");let t={event:E.DC_CLOSE,fatal:e};this.sendJson(t),this._datachannel.removeAllListeners(),this.removeAllListeners(),this._datachannel.destroy()}_handleBinaryMsg(e){const{attachments:t,level:i,reverse:s}=this.pieceMsg;this.listenerCount(E.DC_RESPONSE)>0&&this.bufArr.push(e),this._loadedBytes+=e.byteLength,this.remainAttachments--;let r=s?this.remainAttachments+1:t-this.remainAttachments;const n=0===this.remainAttachments;if(this.emit(E.DC_PIECE_DATA,this.bufSN,this.segId,e,r,n,this.pieceMsg),this.streamListeners.length>0)for(let t of this.streamListeners){const{handler:i}=t;i(this.bufSN,this.segId,!1,e,n)}if(n){if(this.streamListeners=[],this.timeSendRequest>0)if(this.super)this.weight=1;else{const e=this.expectedSize/(performance.now()-this.timeSendRequest);this.weight=this.weight>0?.6*this.weight+.4*e:e}this.sendJson({event:E.DC_PIECE_ACK,sn:this.bufSN,seg_id:this.segId,level:i,size:this.expectedSize,miss:this.miss||void 0}),this.timeSendRequest=0,this.timeReceivePiece=0,this._sendNextReq()||(this.downloading=!1),this._handleBinaryData(s)}}_sendNextReq(){if(this.sendReqQueue.length>0){const e=this.sendReqQueue.shift();return this.logger.info(`get msg from sendReqQueue ${JSON.stringify(e)}`),this._realRequestData(e),!0}return!1}_handlePlaylist(e){const{url:t,data:i,seq:s}=e;this.playlistMap.set(t,{data:i,seq:s})}getLatestPlaylist(e,t){if(!this.playlistMap.has(e))return null;const i=this.playlistMap.get(e);return i.seq<=t||i.seq>t+2?null:i}_handleMetadata(e){const{logger:t}=this;if(this.isInitiator){const e=performance.now()-this.timeSendRequest;e>0&&(this.weight=1e5/e,t.info(`handle Metadata from ${this.remotePeerId} initial weight ${this.weight}`)),this.timeSendRequest=0}const i=e.channel;if(this.channel!==i)return t.error(`peer channel ${i} not matched!`),void this.emit(E.DC_ERROR,!0);e.super&&(t.info(`got super peer ${this.remotePeerId}`),this.super=!0);switch(e.platform){case E.DC_PLAT_ANDROID:this.platform=E.DC_PLAT_ANDROID;break;case E.DC_PLAT_IOS:this.platform=E.DC_PLAT_IOS;break;case E.DC_PLAT_WEB:this.platform=E.DC_PLAT_WEB}if(this.mobile=e.mobile||!1,this.mobileNet=e.mobile_net||!1,this.mobileWeb=this.mobile&&this.platform===E.DC_PLAT_WEB||!1,this.sequential=e.sequential,t.info(`${this.remotePeerId} platform ${this.platform} sequential ${this.sequential}`),e.peers&&(this.peersConnected+=e.peers,t.info(`${this.remotePeerId} now has ${this.peersConnected} peers`)),this.emit(E.DC_METADATA,e),e.field&&!this.config.live&&e.sequential){const{field:t}=e;if(Array.isArray(t))this._handleField(t);else for(let e in t)this._handleField(t[e])}}_handleField(e){e.forEach((e=>{e>=0&&(e<this.startSN&&(this.startSN=e),e>this.endSN&&(this.endSN=e))}))}_handleStats(e){this.gotStatsTs=a();const t=e.total_conns;t>0&&this.peersConnected!==t&&(this.peersConnected=t,this.logger.info(`${this.remotePeerId} now has ${this.peersConnected} peers`)),e.level&&(this.currentLevel=e.level),e.pos&&(this.currentPos=e.pos)}_handleRequestMsg(e){if(this.dataExchangeTs=a(),this.uploading)return this.logger.warn(`${this.remotePeerId} is uploading when receive request`),void this.sendPieceNotFound(e.sn,e.seg_id,{level:e.level});this.uploading=!0,this.emit(E.DC_REQUEST,e)}_handlePieceAck(e,t){0!==this.timeSendPiece&&(this.uploadSpeed=Math.round(e/(performance.now()-this.timeSendPiece)*2),this.timeSendPiece=0,this.logger.info(`${this.remotePeerId} uploadSpeed is ${this.uploadSpeed}`)),t>0&&this.logger.warn(`peer ${this.remotePeerId} miss ${t}`)}_prepareForBinary(e,t,i,s){this.bufArr=[],this.remainAttachments=e,this.segId=t,this.bufSN=i,this.expectedSize=s}_handleBinaryData(e=!1){if(this.listenerCount(E.DC_RESPONSE)>0){e&&this.bufArr.reverse();let t=r.l.concat(this.bufArr);const i=t.byteLength;if(i===this.expectedSize){let e=t.buffer;const i=new T(this.bufSN,this.segId,e,this.remotePeerId,this.pieceMsg.level);this.emit(E.DC_RESPONSE,i,this.weight)}else this.logger.error(`${this.segId} expectedSize ${this.expectedSize} != byteLength ${i}`)}this.segId="",this.bufArr=[],this._loadedBytes=0}checkIfNeedChoke(e=!1){const{logger:t}=this,i=performance.now()-this.timeSendRequest;if(!e&&i<1500)t.info(`duration ${i} no need choke`);else if(this.miss++,t.info(`${this.remotePeerId} miss ${this.miss}`),this.miss>2&&!this.choked){this.choked=!0;const e=30*this.miss;e<=150?(t.warn(`datachannel ${this.channelId} is choked`),this.chokeTimer=setTimeout((()=>{this.choked=!1,t.warn(`datachannel ${this.channelId} is unchoked`)}),1e3*e)):t.warn(`datachannel ${this.channelId} is choked permanently`)}}get bufArrSize(){return this.downloading?this.pieceMsg.attachments-this.remainAttachments:0}loadtimeout(){const{logger:e,pieceMsg:t}=this;return e.warn(`timeout while downloading from ${this.remotePeerId}, ${this.bufArrSize} of ${t.attachments} packets loaded`),this.checkIfNeedChoke(),!0}sendMsgPieceAbort(e){(this.uploading||0!==this.datasToSend.length)&&(this.uploading=!1,this.sendJson({event:E.DC_PIECE_ABORT,reason:e}))}loadedBytes(){return this._loadedBytes}currentLoadSpeed(){return 0===this.timeReceivePiece?0:this.loadedBytes()/(performance.now()-this.timeReceivePiece)}minRequiredSpeed(e){return(this.pieceMsg.size-this.loadedBytes())/e}}const D=N;var L=i(485),M=i.n(L),R=i(934),A=i.n(R);const O=e=>{const t=localStorage.getItem(e);try{const e=JSON.parse(t);return e.value?e.value:e}catch(e){return t}},x=(e,t,i)=>{((e,t)=>{"object"==typeof t&&(t=JSON.stringify(t)),localStorage.setItem(e,t)})(e,{value:t,duration:i,startTime:(new Date).getTime()})};class k{constructor(){this.p2p=0,this.share=0,this.http=0}recordP2p(e){this.p2p+=e}recordShare(e){this.share+=e}recordHttp(e){this.http+=e}resetTraffic(){this.p2p=0,this.share=0,this.http=0}get healthRatio(){if(0===this.http)return 1e3;let e=Math.round((this.p2p+this.share)/this.http*100);return e<=0&&(e=1),e}}const B="SW_GEOIP_KEY",$="TRACKER_EXPT",U="IPAPI_ERROR",q="Y24u",z="Y2Ru",F="Nvb",H="YnllLm",W="Q==",j="aGsuc3d",G="hcm1j",X="bG91ZC",V="5uZXQ=",Y=Symbol("httpDownloaded"),J=Symbol("p2pDownloaded"),Q=Symbol("p2pUploaded");class K extends(_()){constructor(e,i,s,r,n){let o;super(),this.config=e.config;let h=this.config.announceLocation;switch(this.config.trackerZone&&(h=this.config.trackerZone),h){case"cn":case"eu":o=q+z+H+F+W;break;case"hk":o=j+G+X+V;break;case"us":o="dXMuaGR0dmNsb3VkLmNvbQ=="}this.engine=e,this.key=i||void 0,this.baseUrl=r||`https://${window.atob(o)}/v1`,this.channelId=window.btoa(s),this.timestamp=a(),this.health=new k;const l=t().parseURL(this.baseUrl).netLoc;this.announce=l.replace(/\/\//,"");const c=function(e,t,i,s,r,n){let o=location.hostname;"localhost"===o&&n&&(o=`${n}.${o}`);function a(e,t,i,s,r,n){return M()(e+t+i+s+r,n)}const h=a(o,t,i,s,r,e);return h.substr(0,8)}(this.timestamp,"0.5.0",this.announce,this.channelId,n.type,this.key);this.native=!!n.bundle,this.announceInfo={...n,channel:this.channelId,ts:this.timestamp,version:"0.5.0",v:c,announce:this.announce,token:this.key},this.announceURL=`${this.baseUrl}/channel`,this.reportFails=0,this.statsRequesting=!1,this.forbidden=!1,this.failConns=0,this.totalHTTPDownloaded=0,this.totalP2PDownloaded=0,this.totalP2PUploaded=0,this[Y]=0,this[J]=0,this[Q]=0,this.speed=0,this.offline=!1,this.errsBufStalled=0,this.mediaRequests=0,this.errsInternalExpt=0}geoipRequest(){const{logger:e}=this.engine;return new Promise(((t,i)=>{if((e=>{const t=localStorage.getItem(e);try{const e=JSON.parse(t);return!(!e.duration||!e.startTime)&&(new Date).getTime()-e.startTime<e.duration}catch(e){return!1}})(B)){const i=O(B);e.info("found local geo data"),t(i)}else fetch("//pro.ip-api.com/json?fields=2181826&key=XOpiansRgYxGTho").then((e=>e.json())).then((e=>{if("success"===e.status){const i=e.mobile?432e5:2592e5;x(B,e,i),t(e)}else{const t=new Error(`preflight status ${e.status}`);i(A()(t,U))}})).catch((e=>{i(e)}))}))}btAnnouncePreflight(){const{logger:e}=this.engine;return this.announceInfo.asn?this.btAnnounce():(e.info("preflight ip-api"),Promise.race([this.geoipRequest(),new Promise(((e,t)=>{setTimeout((()=>{t(A()(new Error("request timeout"),U))}),600)}))]).then((e=>(this._parseGeoResponse(e),this.btAnnounce()))).catch((t=>{if(t.code!==$){const t=O(B);return t&&(e.info("use expired ipData"),this._parseGeoResponse(t)),this.btAnnounce()}throw t})))}_parseGeoResponse(e){const{lat:t,lon:i,isp:s,as:r,mobile:n,countryCode:o,continentCode:a}=e;n&&(this.announceInfo.netType="cellular");const h=r.split(" ")[0].substr(2);this.announceInfo.tag||(this.announceInfo.tag=`${a||""}-${(0,I.getBrowser)()}${u()?"s":""}`),this.announceInfo={...this.announceInfo,lat:t,lon:i,isp:s,asn:h,country:o}}btAnnounce(){const{logger:e}=this.engine;return this.announceInfo.tag||(this.announceInfo.tag=`${(0,I.getBrowser)()}${u()?"s":""}`),new Promise(((t,i)=>{fetch(this.announceURL,{headers:this._requestHeader,method:"POST",body:JSON.stringify(this.announceInfo)}).then((e=>{if(!e.ok){const t=e.status>=500&&e.status<600;i(A()(new Error(`server response code is ${e.status}`),$,{retry:t}))}return e.json()})).then((e=>{this.engine||i(A()(new Error("runtime error"),$,{retry:!1}));const s=e.data;if(s.f&&(this.forbidden=!0),-1===e.ret){const{code:t,msg:s}=e.data;i(A()(new Error(s),$,{retry:t>=5e3}))}else s.info&&console.info(`${s.info}`),s.warn&&console.warn(`${s.warn}`),s.min_conns||(s.min_conns=8),(!s.rejected||s.rejected&&s.share_only)&&s.id&&s.report_interval&&s.peers?(this.peerId=this.id=s.id,s.report_interval<20&&(s.report_interval=20),this.btStats(s.report_interval),this.getPeersURL=`${this.baseUrl}/channel/${this.channelId}/node/${this.peerId}/peers`,this.statsURL=`${this.baseUrl}/channel/${this.channelId}/node/${this.peerId}/stats`,t(s)):(this.engine&&(this.engine.p2pEnabled=!1),i(A()(new Error("msg not valid"),$,{retry:!1})))})).catch((t=>{e.error(`btAnnounce error ${t}`),i(A()(t,$,{retry:!0}))}))}))}btStats(e=10){this.heartbeater=setInterval((()=>{this.postStats()}),1e3*e)}postStatsWithBeacon(){if(this.offline)return;this.offline=!0;let e={off:!0};this.statsRequesting||(e={...e,...this._makeStatsBody()}),navigator.sendBeacon(this.statsURL,JSON.stringify(e))}postStats(){const{logger:e}=this.engine;this.statsRequesting=!0,fetch(this.statsURL,{method:"POST",body:JSON.stringify(this._makeStatsBody())}).then((e=>(this.statsRequesting=!1,this.reportFails=0,e.text()))).then((t=>{let i;if(i=t?JSON.parse(t):{ret:0,data:{}},-1===i.ret)clearInterval(this.heartbeater),e.error(`${i.data.msg} code ${i.data.code}`),this.engine.emit(E.RESTART_P2P);else{const{http:e=0,p2p:t=0,share:i=0,failConns:s=0,rebuffers:r=0,requests:n=0,errsInternalExpt:o=0}=this.lastStats||{};this[Y]>=e&&(this[Y]-=e),this[J]>=t&&(this[J]-=t),this[Q]>=i&&(this[Q]-=i),this.failConns>=s&&(this.failConns-=s),this.errsBufStalled>=r&&(this.errsBufStalled-=r),this.mediaRequests>=n&&(this.mediaRequests-=n),this.errsInternalExpt>=o&&(this.errsInternalExpt-=o),this.exptMsg&&(this.exptMsg=void 0)}})).catch((t=>{e.error(`btStats error ${t}`),this.statsRequesting=!1,this.reportFails++,this.reportFails>=3&&clearInterval(this.heartbeater)}))}btGetPeers(e,t=!1){const{logger:i}=this.engine,{asn:s,country:r}=this.announceInfo;let n={exclusions:e,asn:s,country:r,ratio:this.health.healthRatio,urgent:t||void 0},o={};return this.engine.getExtraForPeersRequest&&(o=this.engine.getExtraForPeersRequest()),n=Object.assign({},n,o),new Promise(((e,t)=>{fetch(this.getPeersURL,{headers:this._requestHeader,method:"POST",body:JSON.stringify(n)}).then((e=>e.json())).then((i=>{-1===i.ret?t(new Error(i.data.msg)):e(i.data)})).catch((e=>{i.error(`btGetPeers error ${e}`),t(e)})).finally((()=>{this.health.resetTraffic()}))}))}increFailConns(){this.failConns++}increRebuffers(){this.errsBufStalled++}increMediaRequests(){this.mediaRequests++}reportFlow(e){const t=Math.round(e/1024);this[Y]+=t,this.totalHTTPDownloaded+=t,this.health.recordHttp(t),this._emitStats()}reportDCTraffic(e,t){const i=Math.round(e/1024);this[J]+=i,this.totalP2PDownloaded+=i,this.health.recordP2p(i),this.speed=Math.round(t),this._emitStats()}reportUploaded(e=0){const t=Math.round(e/1024);this.totalP2PUploaded+=t,this.health.recordShare(t),this[Q]+=t,this._emitStats()}destroy(){const{logger:e}=this.engine;e.warn("destroy fetcher"),this.removeAllListeners(),clearInterval(this.heartbeater)}_emitStats(){this.engine.emit("stats",{totalHTTPDownloaded:this.totalHTTPDownloaded,totalP2PDownloaded:this.totalP2PDownloaded,totalP2PUploaded:this.totalP2PUploaded,p2pDownloadSpeed:this.speed});const e=this.config.getStats;e&&"function"==typeof e&&e(this.totalP2PDownloaded,this.totalP2PUploaded,this.totalHTTPDownloaded,this.speed)}_makeStatsBody(){const{asn:e,country:t}=this.announceInfo;let i={totalConns:this.engine.tracker.totalConns,failConns:this.failConns,rebuffers:this.errsBufStalled||void 0,requests:this.mediaRequests||void 0,errsInternalExpt:this.errsInternalExpt,http:Math.round(this[Y])||0,p2p:Math.round(this[J])||0,share:Math.round(this[Q])||0,asn:e,country:t},s={};return this.engine.getExtraForStats&&(s=this.engine.getExtraForStats()),i=Object.assign({},i,s),this.lastStats=JSON.parse(JSON.stringify(i)),Object.keys(i).forEach((e=>{0===i[e]&&delete i[e]})),this.exptMsg&&(i.exptMsg="0.5.0 "+this.exptMsg),i}get _requestHeader(){let e={};return this.native&&(e={...e,token:this.key,"User-Agent":"electron",appid:this.announceInfo.bundle}),e}}const Z=K;var ee=function(e,t){return ee=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},ee(e,t)};function te(e,t){function i(){this.constructor=e}ee(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function ie(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var s,r,n=i.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(s=n.next()).done;)o.push(s.value)}catch(e){r={error:e}}finally{try{s&&!s.done&&(i=n.return)&&i.call(n)}finally{if(r)throw r.error}}return o}function se(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(ie(arguments[t]));return e}var re=function(e,t){this.target=t,this.type=e},ne=function(e){function t(t,i){var s=e.call(this,"error",i)||this;return s.message=t.message,s.error=t,s}return te(t,e),t}(re),oe=function(e){function t(t,i,s){void 0===t&&(t=1e3),void 0===i&&(i="");var r=e.call(this,"close",s)||this;return r.wasClean=!0,r.code=t,r.reason=i,r}return te(t,e),t}(re),ae=function(){if("undefined"!=typeof WebSocket)return WebSocket},he={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1};const le=function(){function e(e,t,i){var s=this;void 0===i&&(i={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(e){s._debug("open event");var t=s._options.minUptime,i=void 0===t?he.minUptime:t;clearTimeout(s._connectTimeout),s._uptimeTimeout=setTimeout((function(){return s._acceptOpen()}),i),s._ws.binaryType=s._binaryType,s._messageQueue.forEach((function(e){return s._ws.send(e)})),s._messageQueue=[],s.onopen&&s.onopen(e),s._listeners.open.forEach((function(t){return s._callEventListener(e,t)}))},this._handleMessage=function(e){s._debug("message event"),s.onmessage&&s.onmessage(e),s._listeners.message.forEach((function(t){return s._callEventListener(e,t)}))},this._handleError=function(e){s._debug("error event",e.message),s._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),s.onerror&&s.onerror(e),s._debug("exec error listeners"),s._listeners.error.forEach((function(t){return s._callEventListener(e,t)})),s._connect()},this._handleClose=function(e){s._debug("close event"),s._clearTimeouts(),s._shouldReconnect&&s._connect(),s.onclose&&s.onclose(e),s._listeners.close.forEach((function(t){return s._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=i,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,i=void 0===t?he.maxEnqueuedMessages:t;this._messageQueue.length<i&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,i,s=this._listeners[e.type];if(s)try{for(var r=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],i=0;return t?t.call(e):{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}}}(s),n=r.next();!n.done;n=r.next()){var o=n.value;this._callEventListener(e,o)}}catch(e){t={error:e}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,se(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,i=void 0===t?he.reconnectionDelayGrowFactor:t,s=e.minReconnectionDelay,r=void 0===s?he.minReconnectionDelay:s,n=e.maxReconnectionDelay,o=void 0===n?he.maxReconnectionDelay:n,a=0;return this._retryCount>0&&(a=r*Math.pow(i,this._retryCount-1))>o&&(a=o),this._debug("next delay",a),a},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,i=t.maxRetries,s=void 0===i?he.maxRetries:i,r=t.connectionTimeout,n=void 0===r?he.connectionTimeout:r,o=t.WebSocket,a=void 0===o?ae():o;if(this._retryCount>=s)this._debug("max retries reached",this._retryCount,">=",s);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(h=a)||!h||2!==h.CLOSING)throw Error("No valid WebSocket class provided");var h;this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled||(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new a(t,e._protocols):new a(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout((function(){return e._handleTimeout()}),n))}))}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new ne(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new oe(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}();class ce extends(_()){constructor(e,t,i,s,r="main"){super(),this.logger=e,this.config=t,this.wsAddr=i,this.serverVersion=0,this.pingInterval=s||60,this._ws=this._init(),this.name=r}_init(){const e={maxRetries:this.config.wsMaxRetries,minReconnectionDelay:h(1e4,6e4),maxReconnectionDelay:6e5,maxEnqueuedMessages:20};let t=new le(this.wsAddr,void 0,e);return t.addEventListener("open",(()=>{this.logger.info(`signal ${this.name} ${this.wsAddr} connection opened`),this.onopen&&this.onopen(),this._startPing(this.pingInterval)})),t.push=t.send,t.send=e=>{let i=JSON.stringify(e);t.push(i)},t.addEventListener("message",(e=>{let t=e.data;const i=JSON.parse(t),s=i.action;if("pong"!==s){if("ver"!==s)return"close"===s?(this.logger.warn(`server close signal ${this.name} reason ${i.reason}`),void this.close()):void(this.onmessage&&this.onmessage(i,this.name));this.serverVersion=i.ver}else clearTimeout(this.pongTimer)})),t.addEventListener("close",(e=>{this.logger.warn(`signal ${this.name} ${this.wsAddr} closed ${e.code} ${e.reason}`),this.onclose&&this.onclose(),this._stopPing()})),t.addEventListener("error",(e=>{this.logger.error(`signal ${this.name} ${this.wsAddr} error`),this._stopPing(),this.onerror&&this.onerror(e)})),t}sendSignal(e,t){const i={action:"signal",to_peer_id:e,data:t};this._send(i)}sendReject(e,t,i){const s={action:"reject",to_peer_id:e,reason:t,fatal:i};this._send(s)}_send(e){this._ws&&this._ws.send(e)}_startPing(e=120){this.connected&&(this.pingTimer=setInterval((()=>{this._send({action:"ping"}),this.serverVersion>=22&&this._waitForPong()}),1e3*e))}_waitForPong(){this.pongTimer=setTimeout((()=>{this.logger.warn(`signal ${this.name} wait for pong timeout, reconnect`),this.close(),this.reconnect()}),15e3)}_resetPing(){this._stopPing(),this._startPing(this.pingInterval)}_stopPing(){clearInterval(this.pingTimer),clearTimeout(this.pongTimer),this.pingTimer=null,this.pongTimer=null}close(){this.logger.info(`close signal ${this.name}`),this._stopPing(),(()=>{this._ws&&this._ws.close(1e3,"normal close")})()}reconnect(){this._ws&&(this.logger.info(`reconnect signal ${this.name}`),this._ws.reconnect())}destroy(){this.close(),this._ws=null,this.removeAllListeners()}get connected(){return!!this._ws&&this._ws.readyState===le.OPEN}}const ue=ce,de=class extends(_()){constructor(e,t,i,s){super(),this.logger=e,this.config=t,this.mainAddr=i,this.backupAddr=s,this.mainWS=this._init(i),this.backupTimer=setTimeout((()=>{this.destroyed||(this.backupWS=this._init(s,"backup"))}),900),this._connected=!1,this.destroyed=!1}_init(e,t){if(!e)return null;let i=new ue(this.logger,this.config,e,270,t);return i.onopen=()=>{!this._connected&&this.onopen&&(this._connected=!0,this.onopen())},i.onmessage=e=>{this.onmessage&&this.onmessage(e,i.name)},i.onclose=()=>{this._connected&&!this.connected&&this.onclose&&(this._connected=!1,this.onclose())},i.onerror=e=>{this.onerror&&this.onerror(e)},i}sendSignal(e,t,i){if(i){const s=this._getWSByName(i);s&&s.sendSignal(e,t)}else this.mainConnected?this.mainWS.sendSignal(e,t):this.backupConnected?this.backupWS.sendSignal(e,t):this.logger.warn("no signal available")}sendReject(e,t,i,s){if(s){const r=this._getWSByName(s);if(r)return void r.sendReject(e,t,i)}this.mainConnected?this.mainWS.sendReject(e,t,i):this.backupConnected?this.backupWS.sendReject(e,t,i):this.logger.warn("no signal available, send reject failed")}close(){this.mainWS&&this.mainWS.close(),this.backupWS&&this.backupWS.close()}_getWSByName(e){return this.mainWS&&this.mainWS.name===e?this.mainWS:this.backupWS&&this.backupWS.name===e?this.backupWS:null}reconnect(){this.mainWS&&this.mainWS.reconnect(),this.backupWS&&this.backupWS.reconnect()}destroy(){this.close(),clearTimeout(this.backupTimer),this.mainWS=null,this.backupWS=null,this.removeAllListeners(),this.destroyed=!0}get connected(){return this.mainConnected||this.backupConnected}get mainConnected(){return this.mainWS&&this.mainWS.connected}get backupConnected(){return this.backupWS&&this.backupWS.connected}};const fe=function(e,t,i=40){var s=null,r=!1,n=i;return function(i=!1){if(i)return clearTimeout(s),void(r=!1);r||(r=!0,s=setTimeout((function(){e.call(t,n),r=!1,s=null}),1e3*n),n*=1.1)}};class ge{constructor(e,t,i=15){this.engine=e,this.config=t,this.trickle=t.waitForPeer,this.poolSize=i,this.pool=[];for(let e=0;e<i;e++)this.pool.push(this._createPeer());this.timer=setTimeout((()=>{this.destroy()}),2e4)}_createPeer(){return new D(this.engine,void 0,void 0,!0,this.config,{trickle:this.trickle})}get size(){return this.pool.length}getPeer(){return 0===this.size?this._createPeer():this.pool.shift()}destroy(){for(let e of this.pool)e.destroy(!0);this.pool=[],clearTimeout(this.timer)}}class pe extends(_()){constructor(e,t,i,s){super(),this.engine=e,this.logger=e.logger,this.config=s,this.connected=!1,this.scheduler=i,this.sequential=this.scheduler.sequential,this.DCMap=new Map,this.failedDCSet=new Set,this.notFoundDCSet=new Set;const r=C().isMobile();this.peerPool=new ge(e,s,r?10:15),this.signalerWs=null,this.fetcher=t,this.peers=[],this.minConns=5,this.stuns=[],this.requestMorePeers=fe(this._requestMorePeers,this),this.maxConns=r?13:22,this.maxConnsActive=r?8:12,this.peersIncrement=0,this.gotPeersFromTracker=!1,this.fuseRate=-1,this.overloaded=!1}get totalConns(){return this.scheduler.peersNum+1}resumeP2P(){if(!this.fetcher)return;const{engine:e,config:t,fetcher:i}=this,{btAnnounce:s,btAnnouncePreflight:r}=i,{wsSignalerAddr:n,wifiOnly:o,geoIpPreflight:a,getPeerId:l}=t;(a?r:s).call(i).then((t=>{if(!this.scheduler)return;e.peerId=this.peerId=t.id,this.minConns=t.min_conns;const s=t.peers;this.scheduler.notifyPeersLoaded(s.length),e.netType=i.announceInfo.netType,(t.wifi_only||o)&&e.isMobileNet&&(this.scheduler.downloadOnly=!0,this.logger.info("downloadOnly mode")),t.overload&&(this.overloaded=!0,this.logger.warn("server is overloaded, degrade"));const r=n.main;let a=n.backup;t.signal&&!t.signal2&&(a=void 0),this.signalerWs=this._initSignalerWs(t.signal||r,t.signal2||a,t.token,t.token2),0===s.length?this.requestMorePeers():this.peers=this._filterPeers(s),e.emit("peerId",this.peerId),l&&"function"==typeof l&&l(this.peerId),t.stun&&t.stun.length>0&&(this.stuns=t.stun),t.debug&&this.logger.enableDebug(),t.fuse_rate&&(this.fuseRate=t.fuse_rate),this.logger.info(`announce request response ${JSON.stringify(t,null,2)}`)})).catch((t=>{if("TRACKER_EXPT"===t.code&&e.emit(E.EXCEPTION,t),this.scheduler.notifyPeersLoaded(0),t.retry){const e=h(15e3,4e4);this.logger.warn(`announce retry after ${e}ms`),this.announceTimer=setTimeout((()=>{this.resumeP2P()}),e)}}))}stopP2P(){this.fetcher.postStatsWithBeacon(),this.fetcher.destroy(),this.fetcher=null,this.requestMorePeers(!0),this.scheduler.destroy(),this.scheduler=null,this.signalerWs&&(this.signalerWs.destroy(),this.signalerWs=null),this.peers=[];for(let e of this.DCMap.values())e.destroy(!0);this.DCMap.clear(),this.peerPool.destroy(),this.peerPool=null,this.failedDCSet.clear(),this.notFoundDCSet.clear(),this.logger.warn("tracker stop p2p")}destroy(){this.stopP2P(),this.removeAllListeners(),clearTimeout(this.announceTimer);const{config:e}=this;e.getStats=e.getPeerId=e.getPeersInfo=null,this.logger.warn("destroy tracker")}_filterPeers(e){const t=[],i=[...this.DCMap.keys(),...this.failedDCSet.keys(),this.peerId];return e.filter((e=>!i.includes(e.id))).forEach((e=>{t.push({id:e.id,intermediator:e.intermediator})})),t}_tryConnectToAllPeers(){if(0!==this.peers.length&&this.signalerWs.connected)for(this.logger.info(`try connect to ${this.peers.length} peers`);this.peers.length>0&&!(this.DCMap.size>=this.maxConnsActive);){let e=this.peers.shift();const t=e.intermediator;this.logger.debug(`new DataChannel ${e.id} intermediator ${t}`),this._createDatachannel(e.id,!0,t)}}_setupDC(e){e.on(E.DC_SIGNAL,((t,i)=>{const s=e.remotePeerId;if(e.intermediator){const i=this.DCMap.get(e.intermediator);if(i){if(i.sendMsgSignal(s,this.peerId,t))return;this.logger.warn(`intermediator ${e.intermediator} relay failed`)}}this.signalerWs.sendSignal(s,t,e.signalName)})).on(E.DC_PEER_SIGNAL,(t=>{const i=t.to_peer_id,s=t.from_peer_id,r=t.action;if(i&&s&&r)if(i!==this.peerId){this.logger.info(`relay signal for ${s}`);const n=this.DCMap.get(i);if(n){if("signal"!==r)return void n.sendMsgSignalReject(i,s,t.reason,t.fatal);if(n.sendMsgSignal(i,s,t.data))return}e.sendMsgSignal(s,i)}else"signal"===r?this._handleSignalMsg(s,t,e.remotePeerId):this._handSignalRejected(s,t)})).on(E.DC_GET_PEERS,(()=>{const t=a(),i=this.scheduler.getPeers().filter((e=>e.peersConnected<(e.mobileWeb?13:22)&&!e.super));if(i&&i.length>0){const s=[];i.forEach((i=>{if(i.remotePeerId===e.remotePeerId||i.remotePeerId===this.peerId)return;if(!this.config.live&&(i.currentPos-e.currentPos>600||i.currentPos<e.currentPos))return;t-i.timeJoin>50&&s.push({id:i.remotePeerId})})),this.logger.info(`send ${s.length} peers to ${e.remotePeerId}`),e.sendPeers(s)}})).on(E.DC_PEERS,(t=>{e.gotPeers=!0;const i=t.peers;if(i&&i.length>0&&this.scheduler.peersNum<10){const t=5;this.logger.info(`receive ${i.length} peers from ${e.remotePeerId}`),i.forEach((t=>{t.intermediator=e.remotePeerId})),this.peers=this._filterPeers(i).slice(0,t),this._tryConnectToAllPeers()}})).once(E.DC_ERROR,(t=>{this.logger.info(`datachannel ${e.channelId} failed fatal ${t}`),this.scheduler&&(this.scheduler.deletePeer(e),this._destroyAndDeletePeer(e.remotePeerId,t),this.requestMorePeers(),this.fetcher&&(e.connected||t&&this.fetcher.increFailConns(),t&&this.failedDCSet.add(e.remotePeerId),this._doSignalFusing(this.scheduler.peersNum),this._tryConnectToAllPeers()))})).once(E.DC_TIMEOUT,(()=>{this.notFoundDCSet.add(e.remotePeerId)})).once(E.DC_CLOSE,(t=>{this.logger.info(`datachannel ${e.channelId} closed fatal ${t}`),this.scheduler&&(this.scheduler.deletePeer(e),this._doSignalFusing(this.scheduler.peersNum)),this._destroyAndDeletePeer(e.remotePeerId,t),t&&this.failedDCSet.add(e.remotePeerId),this.requestMorePeers(),this._tryConnectToAllPeers()})).once(E.DC_OPEN,(()=>{e.isInitiator&&this.scheduler.handshakePeer(e)})).once(E.DC_METADATA,(t=>{const{scheduler:i}=this;e.isInitiator||i.handshakePeer(e),i.handleMetaData(e,t);const s=this.DCMap.size>=this.minConns+3;this.requestMorePeers(s),this.peersIncrement++,this._doSignalFusing(i.peersNum+1)}))}_doSignalFusing(e){if(this.fuseRate<=0)return;const t=this.signalerWs.connected;t&&e>=this.fuseRate+2?(this.logger.warn("reach fuseRate, report stats close signaler"),this.totalConns-1>0&&this.fetcher.postStats(),this.signalerWs.close()):!t&&e<this.fuseRate&&(this.logger.warn("low conns, reconnect signaler"),this.signalerWs.reconnect())}_initSignalerWs(e,t,i,s){const r=(e,t)=>{let i=`${e}?id=${this.peerId}&p=web&v=0.5.0`;return t&&(i=`${i}&token=${t}`),i};let n,o=r(e,i);if(!this.overloaded&&t&&t!==e){let e=r(t,s);n=new de(this.logger,this.config,o,e)}else n=new ue(this.logger,this.config,o,270);return n.onopen=()=>{this.connected=!0,this.engine.emit("serverConnected",!0),this._tryConnectToAllPeers()},n.onmessage=(e,t)=>{let i=e.action;const s=e.from_peer_id;switch(i){case"signal":this._handleSignalMsg(s,e,null,t);break;case"reject":this._handSignalRejected(s,e);break;default:this.logger.warn(`Signal websocket unknown action ${i}`)}},n.onclose=()=>{this.connected=!1,this.engine.emit("serverConnected",!1)},n.onerror=e=>{e.message&&this.engine.emit(E.EXCEPTION,A()(e,"SIGNAL_EXPT"))},n}_handSignalRejected(e,t){this.logger.warn(`signaling ${e} rejected, reason ${t.reason}`);const i=this.DCMap.get(e);i&&!i.connected&&(i.destroy(t.fatal),this.DCMap.delete(e)),this.requestMorePeers(),t.fatal&&this.failedDCSet.add(e),this._tryConnectToAllPeers()}_handleSignalMsg(e,t,i,s){if(!this.scheduler)return;const{logger:r}=this;if(t.data){if(this.failedDCSet.has(e))return void this._sendSignalReject(e,`peer ${e} in blocked list`,i,s,!0);this._handleSignal(e,t.data,i,s)}else{const t=this.DCMap.get(e);if(!t)return;if(this.signalerWs.backupConnected&&t&&t.signalMsgs.length>0&&"main"===s&&!t.useBackupSignal){t.useBackupSignal=!0,t.signalName="backup",r.warn(`${e} not found from main, try backup signal`);for(let i of t.signalMsgs)this.signalerWs.sendSignal(e,i,"backup");return}if(t.useBackupSignal)return;this._destroyAndDeletePeer(e),r.info(`signaling ${e} not found`);const{scheduler:n}=this;n.waitForPeer&&(n.waitingPeers--,0===n.waitingPeers&&n.notifyPeersLoaded(0)),this.requestMorePeers(),this._tryConnectToAllPeers(),i||this.notFoundDCSet.add(e)}}_handleSignal(e,t,i,s){const r=t.type,{logger:n}=this;let o=this.DCMap.get(e);if(o){if(o.connected)return void n.info("datachannel had connected, signal ignored");if("offer"===r){if(!(this.peerId>e))return void n.warn(`signal type wrong ${r}, ignored`);this._destroyAndDeletePeer(e,!1),n.warn(`signal type wrong ${r}, convert to non initiator`),o=this._createDatachannel(e,!1,i)}}else{if("answer"===r){const t=`signal type wrong ${r}`;return n.warn(t),this._sendSignalReject(e,t,i,s),void this._destroyAndDeletePeer(e,!1)}n.debug(`receive node ${e} connection request`);const t=this.scheduler.peersNum;if(t>=this.maxConns){const r=this.scheduler.getNonactivePeers();if(!(r.length>0)){const t=`peers reach limit ${this.maxConns}`;return n.warn(t),void this._sendSignalReject(e,t,i,s)}{let e=t-this.maxConns+2;for(r.length<e&&(e=r.length);e>0;){const t=r.shift();t&&(n.warn(`close inactive peer ${t.remotePeerId}`),t.close(!1)),e--}}}o=this._createDatachannel(e,!1,i)}s&&(o.signalName=s),o.receiveSignal(t)}_createDatachannel(e,t,i){let s;if(t&&this.peerPool.size>0)s=this.peerPool.getPeer(),this.logger.info(`get peer from pool, signal size ${s.signalMsgs.length}`),s.assignPeerId(this.peerId,e);else{let r=this.config.trickleICE;i||this.overloaded&&(r=!1),s=new D(this.engine,this.peerId,e,t,this.config,{stuns:this.stuns,intermediator:i,trickle:r})}return this.DCMap.set(e,s),this._setupDC(s),s}_sendSignalReject(e,t,i,s,r){if(i){const s=this.DCMap.get(i);if(s&&s.sendMsgSignalReject(e,this.peerId,t,r))return}this.signalerWs.sendReject(e,t,r,s)}_requestMorePeers(e){const{logger:t}=this;t.info(`requestMorePeers after delay ${e}`);const i=this.scheduler.peersNum,s=this.peersIncrement;this.peersIncrement=0,i>=this.minConns||(0===i||s<=3&&!this.gotPeersFromTracker&&!this.overloaded?(this.failedDCSet.size>50&&(this.failedDCSet=new Set([...this.failedDCSet].slice(-50))),this.notFoundDCSet.size>20&&(this.notFoundDCSet=new Set([...this.notFoundDCSet].slice(-20))),this.fetcher.btGetPeers([...this.DCMap.keys(),...this.failedDCSet.keys(),...this.notFoundDCSet.keys()],0===i).then((e=>{t.info(`requestMorePeers resp ${JSON.stringify(e,null,2)}`),this.peers=this._filterPeers(e.peers),this._tryConnectToAllPeers()})).catch((e=>{t.error(`requestMorePeers error ${e}`)})),this.gotPeersFromTracker=!0):i<this.maxConnsActive&&(this.scheduler.requestPeers(),this.gotPeersFromTracker=!1))}_destroyAndDeletePeer(e,t=!0){const i=this.DCMap.get(e);return!!i&&(i.destroy(t),this.DCMap.delete(e),!0)}}const me=pe;let _e={wsMaxRetries:10,p2pEnabled:!0,wifiOnly:!1,memoryCacheLimit:{pc:629145600,mobile:314572800},dcDownloadTimeout:25,logLevel:"error",tag:"",webRTCConfig:{},token:void 0,appName:void 0,appId:void 0,prefetchNum:5,showSlogan:!1,trickleICE:!0,announceLocation:"cn",trackerZone:void 0,geoIpPreflight:!0,getStats:function(e,t,i){},getPeerId:function(e){},getPeersInfo:function(e){}};const ye=_e;const ve=class{constructor(){this.peerMap=new Map}isEmpty(){return 0===this.peerMap.size}size(){return this.peerMap.size}clear(){this.peerMap.clear()}getPeers(){return[...this.peerMap.values()]}getPeerValues(){return this.peerMap.values()}hasPeer(e){return this.peerMap.has(e)}addPeer(e,t){this.peerMap.set(e,t)}getPeerIds(){return[...this.peerMap.keys()]}removePeer(e){this.peerMap.delete(e)}getPeersOrderByWeight(){const e=this.getAvailablePeers();return e.sort(((e,t)=>0===t.weight?1:0===e.weight?-1:t.weight-e.weight)),e}getPeer(e){return this.peerMap.get(e)}getAvailablePeers(){return this.getPeers().filter((e=>e.isAvailableUrgently))}},be=1,Se=2,we=3,Pe=4;class Ee{constructor(e){this.generator=e,this.status=be,this.next=this.next.bind(this)}next(e){if(this.status===Pe)return console.warn("status is canceled");if(this.status===Se)return console.warn("status is waiting");const t=this.execute.bind(this,this.cb);this.nextInfo=this.generator(t),this.status=Se,this.nextInfo.execute(e)}execute(e,t){this.status=we,e.apply(t,[this.next])}cancel(){this.status=Pe,this.nextInfo&&"function"==typeof this.nextInfo.cancel&&this.nextInfo.cancel()}start(e,t){if("function"!=typeof e)throw new SyntaxError("param cb must be a function");this.cb=e,this.next(t)}continue(e){this.status=be,this.next(e)}}const Te=Symbol("shareOnly");class Ie extends(_()){constructor(e,t){super(),this.engine=e,this.config=t,this.logger=e.logger,this.bufMgr=null,this.peerManager=new ve,this._setupEngine&&this._setupEngine(),this.startCheckConnsTimer(),this.dcDownloadTimeout=t.dcDownloadTimeout,this[Te]=!1,this.downloadOnly=!1,this.loadedPeerNum=0}get isMobileNet(){return this.engine.isMobileNet}startCheckConnsTimer(){this.checkConnsTimer=setInterval((()=>{this.logger.info("start check conns");const e=this.getStatsForPeer();let t=this.peersNum;const i=a();this.getPeers().forEach((s=>{t>4&&(i-s.dataExchangeTs>150||i-s.gotStatsTs>=83)?(this.logger.warn(`close dead or different level peer ${s.remotePeerId} level ${s.currentLevel}`),s.close(!1),t--):s.connected&&s.sendMsgStats(t,e)}))}),4e4)}getStatsForPeer(){return{}}getNonactivePeers(){const e=a();return this.getPeers().filter((t=>e-t.dataExchangeTs>150)).sort(((e,t)=>e.dataExchangeTs-t.dataExchangeTs))}requestPeers(){this.logger.info("request peers from peer");const e={event:E.DC_GET_PEERS};for(let t of this.getPeers())t.mobileNet||t.super||t.sendJson(e)}chokePeerRequest(e){const t={event:E.DC_CHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}unchokePeerRequest(e){const t={event:E.DC_UNCHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}stopRequestFromPeers(){for(let e of this.getPeers())e.choked=!0}resumeRequestFromPeers(){for(let e of this.getPeers())e.choked=!1}setShareOnly(){this[Te]=!0}deletePeer(e){this.peerManager.hasPeer(e.remotePeerId)&&this.peerManager.removePeer(e.remotePeerId),this._peersStats(this.peerManager.getPeerIds())}getPeers(){return[...this.peerManager.getPeerValues()]}addPeer(e){const{logger:t}=this;this.peerManager.addPeer(e.remotePeerId,e),this[Te]&&(e.choked=!0);const i=this.peerManager.getPeerIds();this._peersStats(i),t.info(`add peer ${e.remotePeerId}, now has ${i.length} peers`),!e.mobileNet&&!this.waitForPeer&&e.isInitiator&&this.peersNum<=5&&e.peersConnected>1&&e.sendPeersRequest()}get hasPeers(){return this.peersNum>0}get peersNum(){return this.peerManager.size()}get hasIdlePeers(){const{logger:e}=this,t=this.getIdlePeer().length;if(e.info(`peers: ${this.peersNum} idle peers: ${t}`),t<this.peersNum){const t=this.peerManager.getPeers(),i=t.filter((e=>e.downloading));e.warn(`downloading: ${i.length} choked: ${t.filter((e=>e.choked)).length}`);for(let t of i)e.warn(`${t.remotePeerId} loading ${t.segId} packets ${t.bufArr.length} total ${t.pieceMsg.attachments}`)}return t>0}getIdlePeer(){return this.peerManager.getAvailablePeers()}set bufferManager(e){this.bufMgr=e,e.on(E.BM_LOST,(({sn:e,segId:t,next:i,level:s})=>{this.config.live||this._broadcastToPeers({event:E.DC_LOST,sn:e,seg_id:t,level:s||void 0}),this.onBufferManagerLost(e,t,i,s)})).on(E.BM_SEG_ADDED,(e=>{this.onBufferManagerSegAdded(e)}))}onBufferManagerSegAdded(e){}destroy(){const{logger:e}=this;this.peersNum>0&&this.peerManager.clear(),this.removeAllListeners(),clearInterval(this.checkConnsTimer),this.checkTimer&&this.checkTimer.cancel(),e.warn("destroy BtScheduler")}notifyPeersLoaded(e){}_setupDC(e){const{logger:t}=this;e.on(E.DC_PIECE_ACK,(i=>{i.size&&(this.engine.fetcher.reportUploaded(i.size),t.info(`uploaded ${i.seg_id} size ${i.size} to ${e.remotePeerId}, canceled ${i.canceled||!1}`))})).on(E.DC_PIECE_ABORT,(i=>{t.warn(`peer ${e.remotePeerId} download aborted, reason ${i.reason}`),e.downloading&&this._handlePieceAborted&&this._handlePieceAborted(e.remotePeerId),e.downloading=!1})).on(E.DC_REQUEST,(()=>{})).on(E.DC_SEND_REQUEST,(()=>{}))}_broadcastToPeers(e){for(let t of this.getPeers())t.sendJson(e)}_peersStats(e){this.engine.emit("peers",e);const t=this.engine.config.getPeersInfo;t&&"function"==typeof t&&t(e)}startCheckPeersTimer(e=3e3){this.checkTimer=new Ee((function(e){let t;return{execute:function(i=1e3){t=setTimeout(e,i)},cancel:function(){clearTimeout(t)}}})),this.checkTimer.start((e=>{this.checkPeers();const t=1e3*(0===(i=this.loadedPeerNum)?3:.5*i+1.67);var i;this.logger.info(`loaded peers ${this.loadedPeerNum} nextDelay ${t}`),this.loadedPeerNum=0,e(t)}),e)}}const Ce=Ie;class Ne extends(_()){constructor(e,t,i=!0){super(),this.isSequential=i,this.logger=t.logger;const s=e.browserInfo.device;this.maxBufSize=s===C().device.PC_WEB||s===C().device.PC_NATIVE?t.memoryCacheLimit.pc:t.memoryCacheLimit.mobile,t.live&&(this.maxBufSize=36700160),this._segPool=new Map,this._currBufSize=0,this.id2Sn=new Map,this.overflowed=!1}get currBufSize(){return this._currBufSize}hasSegOfId(e){if(this.isSequential){const t=this.id2Sn.get(e);return this._segPool.has(t)}return this._segPool.has(e)}hasSegOfSN(e){return!!this.isSequential&&this._segPool.has(e)}_calSegPoolSize(){let e=0;return this._segPool.forEach((t=>{e+=t.size})),e}putSeg(e){if(this._currBufSize>=1.5*this.maxBufSize&&(this._currBufSize=this._calSegPoolSize(),this._currBufSize>=1.5*this.maxBufSize&&(this.clear(),this.overflowed=!1)),this.isSequential){if(this._segPool.has(e.sn))return;this._addSequentialSeg(e)}else{if(this._segPool.has(e.segId))return;this._addUnsequentialSeg(e)}}_addSequentialSeg(e){const{logger:t}=this,{segId:i,sn:s,size:r}=e;this.id2Sn.set(i,s),this._segPool.set(s,e),this._currBufSize+=parseInt(r);const n=this._segPool.size;if(this.emit(`${E.BM_ADDED_SN_}${e.sn}`,e),this.emit(E.BM_SEG_ADDED,e),this._currBufSize<this.maxBufSize||n<=5)return;let o=Array.from(this._segPool.keys()).sort(((e,t)=>e-t)),a=0;do{if(a++>10){console.error("too much loops in SegmentCache");break}const e=o.shift();if(void 0===e){t.error("lastSN not found");continue}const i=o[0],s=this._segPool.get(e);if(!s){t.error("lastSeg not found");continue}const r=s.size;this._currBufSize-=parseInt(r),this._segPool.delete(e),this.id2Sn.delete(s.segId),t.info(`pop seg ${e} size ${r} currBufSize ${this._currBufSize}`),this.overflowed||(this.overflowed=!0),this.emit(E.BM_LOST,{sn:e,segId:s.segId,next:i,level:s.level})}while(this._currBufSize>=this.maxBufSize&&this._segPool.size>5)}_addUnsequentialSeg(e){const{logger:t}=this,{segId:i,size:s}=e;this._segPool.set(i,e),this._currBufSize+=parseInt(s),this.emit(`${E.BM_ADDED_SEG_}${e.segId}`,e),this.emit(E.BM_SEG_ADDED,e);let r=0;for(;this._currBufSize>=this.maxBufSize&&this._segPool.size>5;){if(r++>10){console.error("too much loops in SegmentCache");break}const e=[...this._segPool.values()].shift(),i=e.segId,s=e.size;this._currBufSize-=parseInt(s),t.info(`pop seg ${i} size ${s}`),this._segPool.delete(i),this.overflowed||(this.overflowed=!0),this.emit(E.BM_LOST,{sn:-1,segId:i,level:e.level})}}getSegById(e){if(this.isSequential){const t=this.id2Sn.get(e);return this._segPool.get(t)}return this._segPool.get(e)}getSegIdBySN(e){const t=this._segPool.get(e);return t?t.segId:null}getSegBySN(e){if(this.isSequential)return this._segPool.get(e);throw new Error("fatal error in SegmentCache")}clear(){this.logger.warn("clear segment cache"),this._segPool.clear(),this.id2Sn.clear(),this._currBufSize=0}destroy(){this.clear(),this.removeAllListeners()}}const De=Ne,Le={debug:0,info:1,warn:2,error:3,none:4};const Me=class{constructor(e){this.logLevel=e,this.onlineDebug=!1,console.debug=console.log,"debug"!==e&&"info"!==e||(this.logLevel="warn"),!0===e?this.logLevel="warn":!1===e?this.logLevel="none":e in Le||(this.logLevel="error"),this.resetLogger()}enableDebug(){this.onlineDebug=!0;for(let e in Le)this[e]=console[e]}resetLogger(){this.onlineDebug=!1;for(let e in Le)Le[e]<Le[this.logLevel]?this[e]=o:this[e]=console[e]}get isDebugLevel(){return Le[this.logLevel]<=2||this.onlineDebug}},Re={DPlayer:"dplayer",CBPlayer:"cbplayer",jwplayer:"jwplayer",videojs:"videojs",Clappr:"clappr",ckplayer:"ckplayer",MediaElementPlayer:"mediaelement",MediaElement:"mediaelement",TcPlayer:"tcplayer",flowplayer:"flowplayer",Chimee:"chimee",ChimeePlayer:"chimee",HlsJsPlayer:"xgplayer",fluidPlayer:"fluidplayer",OpenPlayer:"openplayer",Plyr:"plyr",Playerjs:"playerjs",Aliplayer:"aliplayer",shaka:"shakaplayer"};function Ae(){let e;for(let t in Re)if(window[t]){e=Re[t];break}return e}const Oe="nllL",xe="d3NzJ",ke="==",Be="TNBLy9z",$e="aWduY",Ue="mNvbQ",qe="WwuY2RuY";class ze extends(_()){constructor(e={}){var t;if(super(),this.p2pEnabled=!(!1===e.p2pEnabled||"0"===(t="_p2p",new URL(location.href).searchParams.get(t))),e.tag&&e.tag.length>20)throw new Error("Tag is too long");if(e.appName&&e.appName.length>30)throw new Error("appName is too long");if(e.appId&&e.appId.length>30)throw new Error("appId is too long");if(e.token&&e.token.length>20)throw new Error("Token is too long")}initLogger(){const{config:e}=this;e.showSlogan&&"en"==("zh-CN"===(navigator.language||navigator.userLanguage)?"cn":"en")&&console.log(`%cLet the browsers become your unlimitedly scalable CDN!\n%c${window.atob("aHR0cHM6Ly9zd2FybWNsb3VkLm5ldC9lbi8=")}`,"color: dodgerblue; padding:20px 0; font-size: x-large","font-size: medium; padding-bottom:15px");const t=new Me(e.logLevel);return e.logger=this.logger=t,t}getExtraForStats(){return{}}getExtraForPeersRequest(){const e={};return e.num_want=this._getNumWant(),e}_getNumWant(){const{tracker:e}=this,t=e.scheduler.peersNum;if(t>0&&e.maxConnsActive-t>0)return e.maxConnsActive-t}makeChannelId(e,t){if(!e||"string"!=typeof e){const e="token is required while using customized channelId!";throw console.error(e),new Error(e)}return"function"==typeof t?(i,s)=>`${e}-${t(i,s)}`:()=>`${e}-${t}`}makeSignalId(){let e="";const{config:i}=this,s=decodeURIComponent(window.atob(xe+Be+$e+qe+Oe+Ue+ke)),{wsSignalerAddr:r}=i;if(r){let n;"object"==typeof r?(r.main||(r.main=s),n=r.main):"string"==typeof r&&(n=r,i.wsSignalerAddr={main:n}),n===s&&(n=void 0),n&&!i.wsSignalerAddr.backup&&(e=t().parseURL(n).netLoc.substr(2))}else i.wsSignalerAddr={main:s,default:!0};return e}get commonBrowserInfo(){const e=C().getPlatform(),t=C().getNetType()||"wifi";return this.netType=t,{device:e,netType:t,player:Ae()||void 0}}get isMobileNet(){return"wifi"!==this.netType&&"ethernet"!==this.netType}setupWindowListeners(e){const t=["iPad","iPhone"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",i=()=>{this.fetcher&&this.fetcher.postStatsWithBeacon(),this.p2pEnabled&&this.disableP2P(),window.removeEventListener(t,i)};e?window.removeEventListener(t,i):window.addEventListener(t,i)}destroy(){this.disableP2P(!0),this.removeAllListeners(),this.setupWindowListeners(!0)}enableP2P(){return this.p2pEnabled?null:(this.logger&&this.logger.info("enable P2P"),this.config.p2pEnabled=this.p2pEnabled=!0,this.browserInfo?(this._init(this.channel,this.browserInfo),this):null)}get version(){return ze.version}static isSupported(){const e=c();return!(!e||void 0===e.RTCPeerConnection.prototype.createDataChannel)}static get TrackerZone(){return{CN:"cn",EU:"eu",HK:"hk",USA:"us"}}}ze.version="0.5.0",ze.protocolVersion=D.VERSION;const Fe=ze;let He={...ye,httpLoadTime:3,sharePlaylist:!1,useHttpRange:!0,useDiskCache:!0,diskCacheLimit:{pc:262144e4,mobile:1572864e3}};He.validateSegment=function(e,t){return!0};const We=He,je={...E};class Ge extends(_()){constructor(e){super(),this.internalMap=new Map,this.eventName=e}has(e){return this.internalMap.has(e)}set(e,t){this.internalMap.set(e,t),this.emit(`${this.eventName}${e}`,t)}get(e){return this.internalMap.get(e)}delete(e){const t=this.internalMap.get(e);return!!t&&(t.destroy(),this.internalMap.delete(e),!0)}clear(){this.internalMap.clear(),this.removeAllListeners()}}const Xe={...E,SCH_DCHAVE:"SCH_DCHAVE",SCH_WAIT_PEER:"SCH_WAIT_PEER",STREAM_DETECT:"STREAM_DETECT",STREAM_DISABLE:"STREAM_DISABLE",SW_STREAM_ENABLE:"SW_STREAM_ENABLE",SW_PLAYLIST:"SW_PLAYLIST",SW_GET_PLAYLIST:"SW_GET_PLAYLIST",SW_MEDIA:"SW_MEDIA",SW_PRE_MEDIA:"SW_PRE_MEDIA",SW_GET_MEDIA:"SW_GET_MEDIA",SW_STREAM:"SW_STREAM",LEVEL_LOADED:"LEVEL_LOADED",MANIFEST_PARSED:"MANIFEST_PARSED"};function Ve(e,t,i,s=0,r=0){const o=n;let a="bytes=",h=s,l=r||i-1;const c=Math.floor(i/o),u=i%o>0?c+1:c;if(e>=0&&(h+=(e+1)*o),a=`${a}${h}-`,t>=0&&t<u){l-=i%o+(u-t-1)*o,a=`${a}${l}`}else 0!==r&&(a=`${a}${l}`);return a}const Ye=0,Je=1,Qe=2,Ke=3;class Ze extends(_()){constructor(e,t,i,s=!1,r){super(),this.coordinator=e,this.logger=t,this.rangeSupported=s,this.rangeStart=0,this.rangeEnd=0,this.httpLoadTime=2e3,this.allowLoadPartial=!1,r&&this.setExtra(r),this.forwardPeer=null,this.reversePeer=null,this.bufArr=[],this.forwardBufList=[],this.reverseBufList=[],this.pieceMsg={seg_id:i},this.forwardOffset=-1,this.reverseOffset=1e4,this.timeStart=0,this.timeReceivePiece=0,this.timer=void 0,this.destroyed=!1,this.forwardStreamListeners=[],this.reverseStreamListeners=[],this.rangeRequesting=!1,this.waitingRemain=!1,this.httpLoaded=0,this.p2pLoaded=0,this.deadline=0,this.p2pCanceled=!1}isDownloading(){return this.timeReceivePiece>0}isAlmostDeadline(){return!!this.rangeRequesting||this.deadline>0&&this.deadline-performance.now()<400}hasPeer(e){return!!e&&(e===this.forwardPeer||e===this.reversePeer)}_notifyStreamListeners(e,t,i){const{seg_id:s,attachments:r}=this.pieceMsg,n=e&&0===i||!e&&i===r-1,o=e?this.reverseStreamListeners:this.forwardStreamListeners;e?this.reverseBufList.push(t):this.forwardBufList.push(t),n&&(this.forwardBufList.push([...this.reverseBufList].reverse()),this.reverseBufList.push([...this.forwardBufList].reverse()));for(let e of o){const{handler:i}=e;i(s,!1,t,n)}n&&(o.length=0)}_notifyStreamListenersAbort(){const e=[...this.reverseStreamListeners,...this.forwardStreamListeners];for(let t of e){const{handler:e}=t;e(void 0,void 0,!0,"aborted by synthesizer")}e.length=0}_notifyStreamListenersRemain(){if(this.forwardStreamListeners.length>0){for(let e=this.forwardOffset+1;e<this.bufArr.length;e++)this._notifyStreamListeners(!1,this.bufArr[e],e);this.forwardStreamListeners=[]}if(this.reverseStreamListeners.length>0){for(let e=this.reverseOffset-1;e>=0;e--)this._notifyStreamListeners(!0,this.bufArr[e],e);this.reverseStreamListeners=[]}}addStreamListener(e,t,i){(e?this.reverseStreamListeners:this.forwardStreamListeners).push({handler:i,peerId:t})}removeStreamListener(e){const t=t=>t.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)));this.forwardStreamListeners=t(this.forwardStreamListeners),this.reverseStreamListeners=t(this.reverseStreamListeners)}setTimeout(e=0){e<=0?setTimeout((()=>{this._handleTimeout(!1,!1)}),0):(this.deadline=performance.now()+e,this._startTimer(e))}setExtra(e={}){e.url&&(this.url=e.url),e.rangeStart&&(this.rangeStart=e.rangeStart),e.rangeEnd&&(this.rangeEnd=e.rangeEnd),e.httpLoadTime&&(this.httpLoadTime=e.httpLoadTime),e.allowLoadPartial&&(this.allowLoadPartial=!0),e.xhrSetup&&(this.xhrSetup=e.xhrSetup),e.headers&&(this.headers=e.headers)}hasForwardPeer(){return!!this.forwardPeer}hasReversePeer(){return!!this.reversePeer}hasPeerId(e){return this.forwardPeer&&this.forwardPeer.remotePeerId===e||this.reversePeer&&this.reversePeer.remotePeerId===e}isEmpty(){return null===this.forwardPeer&&null===this.reversePeer}isFull(){return this.forwardPeer&&this.reversePeer}setForwardPeer(e){this.forwardPeer=e,this.reversePeer&&this._print(),this._setupPeer(e,!1)}setReversePeer(e){this.reversePeer=e,this.forwardPeer&&this._print(),this._setupPeer(e,!0)}deletePeer(e,t=!1){const i=e===this.reversePeer;this._detachPeer(e),i?(this.reversePeer=null,t&&(this.reverseOffset=this.pieceMsg.attachments||1e4)):(this.forwardPeer=null,t&&(this.forwardOffset=-1)),this.isEmpty()&&this._handleTimeout(!1,!1)}terminate(){this._handleTimeout(!1,!1)}_emitPartialOrError(e){if(this.allowLoadPartial&&this.hasPartialBuffer()){const[e,t]=this.getPartialBuffer();this.emit(Xe.SYN_PARTIAL,this.pieceMsg,e,t)}else this.emit(Xe.SYN_ERROR,this.pieceMsg,e)}hasPartialBuffer(){return this.forwardOffset>=0||this.pieceMsg&&this.reverseOffset<this.pieceMsg.attachments}getPartialBuffer(){return[this.forwardOffset>=0?r.l.concat(this.bufArr.slice(0,this.forwardOffset+1)):null,this.pieceMsg&&this.reverseOffset<this.pieceMsg.attachments?r.l.concat(this.bufArr.slice(this.reverseOffset)):null]}_cancelP2p(){if(this.p2pCanceled)return;this.p2pCanceled=!0;const{seg_id:e}=this.pieceMsg;[this.forwardPeer,this.reversePeer].filter((e=>!!e)).forEach((t=>{t.cancelDownload(void 0,void 0,e)}))}destroy(){this.logger.info("destroy syn"),this._notifyStreamListenersAbort(),clearTimeout(this.timer),this._cancelP2p(),this.removeAllListeners(),this.destroyed=!0,this._detachPeer(this.forwardPeer),this.forwardPeer=null,this.forwardOffset=-1,this._detachPeer(this.reversePeer),this.reversePeer=null,this.reverseOffset=1e4,this.bufArr=[],this.forwardStreamListeners=[],this.reverseStreamListeners=[]}_detachPeer(e){if(!e)return;const t=e===this.reversePeer?this.reverseEvents:this.forwardEvents;e.off(Xe.DC_PIECE_DATA,t.onPieceData).off(Xe.DC_PIECE,t.onPiece).off(Xe.DC_PIECE_NOT_FOUND,t.onPieceNotFound).off(Xe.DC_PIECE_ABORT,t.onPieceAbort)}_receivePacket(e,t,i,s=!0){const{seg_id:n,size:o}=this.pieceMsg,a=t-1;if(this.bufArr[a])return this.logger.warn(`syn bufArr ${n} already has ${a}`),!1;if(s?this.p2pLoaded+=i.byteLength:this.httpLoaded+=i.byteLength,this.bufArr[a]=i,e?this.reverseOffset=a:this.forwardOffset=a,this._notifyStreamListeners(e,i,a),this.forwardOffset!==this.reverseOffset-1)return!0;this.forwardPeer&&(this.forwardPeer.miss=0),this.reversePeer&&(this.reversePeer.miss=0),clearTimeout(this.timer),this._notifyStreamListenersRemain();const h=o/(performance.now()-this.timeStart);let l=r.l.concat(this.bufArr);const c=l.byteLength;if(c===o){let e=l.buffer;const t=new T(-1,n,e,this.getFromPeerId());this.emit(Xe.SYN_OUTPUT,t,{speed:h,p2p:this.p2pLoaded,http:this.httpLoaded})}else this.logger.error(`${n} expectedSize ${o} != byteLength ${c} forward ${this.forwardOffset} reverse ${this.reverseOffset}`),this.emit(Xe.SYN_ERROR,this.pieceMsg,Ye)}_setupPeer(e,t){0===this.timeStart&&(this.timeStart=performance.now());const i=(t,i,s,r,n,o)=>{if(this.destroyed)return;if(!this._validateMsg(i))return void this.logger.error(`onPieceData ${i} not match ${JSON.stringify(this.pieceMsg)} from ${e.remotePeerId}`);const{reverse:a}=o;this._receivePacket(a,r,s)&&!this.waitingRemain&&!this.rangeRequesting&&this.deadline>0&&this._shouldSwitch()&&(this.logger.warn("should switch to http"),clearTimeout(this.timer),this._handleTimeout(!1,!1))},s=t=>{if(this.destroyed)return;const{attachments:i,size:s,seg_id:r}=t;return this._validateMsg(r)?this.pieceMsg.size&&s!==this.pieceMsg.size?(this.logger.error(`onPiece ${r} size not match`),void this.emit(Xe.SYN_ERROR,this.pieceMsg,Ye)):void(0===this.bufArr.length&&(this.pieceMsg={...this.pieceMsg,seg_id:r,size:s,attachments:i},this.reverseOffset=i,this.bufArr=new Array(i),this.timeReceivePiece=performance.now())):(this.logger.error(`onPiece ${r} not match ${JSON.stringify(this.pieceMsg)}`),void this.deletePeer(e))},r=t=>{this.destroyed||(this._validateMsg(t.seg_id)?this.deletePeer(e):this.logger.error(`onPieceNotFound ${t.seg_id} not match ${JSON.stringify(this.pieceMsg)}`))},n=()=>{this.destroyed||this.deletePeer(e)},o={onPieceData:i,onPiece:s,onPieceNotFound:r,onPieceAbort:n};t?this.reverseEvents=o:this.forwardEvents=o,e.on(Xe.DC_PIECE_DATA,i).once(Xe.DC_PIECE,s).once(Xe.DC_PIECE_NOT_FOUND,r).once(Xe.DC_PIECE_ABORT,n)}_validateMsg(e){return e===this.pieceMsg.seg_id}_shouldSwitch(){const e=this.pieceMsg.size-64e3*this.loadedPackets();return this.coordinator.shouldSwitchToHttp(e,this.deadline,this.p2pSpeed,64e3,this.httpLoadTime)}_startTimer(e,t=!0){this.timer=setTimeout(this._handleTimeout.bind(this,t),e)}loadedPackets(){return this.pieceMsg.attachments-(this.reverseOffset-this.forwardOffset-1)}_handleTimeout(e=!1,t=!0){if(this.destroyed)return;const{seg_id:i,size:s,attachments:r}=this.pieceMsg;if(!s||0===this.timeReceivePiece)return this.logger.warn(`syn load timeout ${i} url ${this.url}`),void this.emit(Xe.SYN_ERROR,this.pieceMsg,Ye);if(e&&this.timeReceivePiece>0&&(this.logger.warn(`syn ${this.loadedPackets()} of ${r} packets loaded`),this.shouldWaitForRemain(this.httpLoadTime))){const e=this.httpLoadTime;return this.waitingRemain=!0,this.logger.info(`syn wait for remain ${e}`),void this._startTimer(e,!1)}if(t){const e=[this.forwardPeer,this.reversePeer].filter((e=>!!e)).sort(((e,t)=>e.currentLoadSpeed()-t.currentLoadSpeed())).shift();e&&e.loadtimeout()}if(this._cancelP2p(),this.rangeSupported&&this.url)return this._loadRemainBufferByHttp();this._notifyStreamListenersAbort(),this._emitPartialOrError(Ke)}shouldWaitForRemain(e){if(e<=0)return!1;return performance.now()-this.timeStart<1e3&&this.timeReceivePiece>0&&e>3e3||this.shouldWaitForRemainUrgent(e)}shouldWaitForRemainUrgent(e){if(0===this.timeReceivePiece||e<=0)return!1;const t=this.p2pSpeed;let i=0;[this.forwardPeer,this.reversePeer].forEach((e=>{e&&(i+=e.loadedBytes())}));const s=(this.pieceMsg.size-i)/e;return this.logger.info(`syn remainTime ${e} speed ${t} required ${s}`),t>=s}get p2pSpeed(){let e=0;return[this.forwardPeer,this.reversePeer].forEach((t=>{t&&(e+=t.currentLoadSpeed())})),e}getFromPeerId(){const{forwardPeer:e,reversePeer:t}=this;return this.isFull()&&e!==t?`${e.remotePeerId}:${t.remotePeerId}`:e?`${e.remotePeerId}`:t?`${t.remotePeerId}`:""}_loadRemainBufferByHttp(){if(this.rangeRequesting)return;const{size:e,seg_id:t}=this.pieceMsg,i=this.rangeEnd>0?this.rangeEnd-1:0,s=this.forwardOffset,n=Ve(s,this.reverseOffset,e,this.rangeStart,i),o=performance.now();let a=this.deadline+this.httpLoadTime-o+1e3;a<2e3?a=2e3:a>6e3&&(a=6e3),this.logger.info(`continue download ${t} from ${this.url} range: ${n} timeout ${a}`),this.rangeRequesting=!0,this.headers&&(this.xhrSetup=e=>{for(const t of Object.keys(this.headers))e.setRequestHeader(t,this.headers[t])}),l(this.url,n,this.xhrSetup,a).then((e=>{if(this.destroyed)return;if(this.rangeRequesting=!1,!e)return void this.emit(Xe.SYN_ERROR,this.pieceMsg,Je);let t=r.l.from(e);const i=t.byteLength/(performance.now()-o);this.coordinator.addHttpSpeed(i);const n=d(t,0);let a=s+1;for(let e=0;e<n.length;e++)this.bufArr[a]||this._receivePacket(!1,a+1,n[e],!1),a++})).catch((e=>{if(this.destroyed)return;this.rangeRequesting=!1,this.logger.error(`http partial download ${t} error ${e}`);const i="timeout"===e?Qe:Je;this.emit(Xe.SYN_ERROR,this.pieceMsg,i)}))}_print(){const{seg_id:e}=this.pieceMsg;this.logger.info(`syn parallel loading ${e}`)}}class et{constructor(){this.meanHttpSpeed=0}addHttpSpeed(e){this.meanHttpSpeed=.4*this.meanHttpSpeed+.6*e}shouldSwitchToHttp(e,t,i,s,r){if(this.meanHttpSpeed<=0)return!1;if(i>=this.meanHttpSpeed)return!1;if(this.meanHttpSpeed*r>=e)return!1;return((r+t-performance.now())*this.meanHttpSpeed-e)/(this.meanHttpSpeed-i)*i<s}}const tt=0,it=1,st=2,rt=3,nt=(e,t,i)=>e.filter((e=>e.bitset.has(i,t)));class ot{constructor(e=!1,t){if(this.isLive=e,this.internalMap=new Map,t)for(let e of t)this.internalMap.set(e,it)}has(e,t=tt){if(t===tt)return this.internalMap.has(e);return this.internalMap.get(e)===t}hasCompleteOr(e,t=it){const i=this.internalMap.get(e);return i===it||i===t}getState(e){return this.internalMap.get(e)}delete(e){return this.internalMap.delete(e)}add(e,t){this.internalMap.set(e,t),this.isLive&&this._trimBitset(e)}array(){return this._keysForStateComplete(this.internalMap)}clear(){this.internalMap.clear()}size(){return this.internalMap.size}_trimBitset(){f(this.internalMap,20)}_keysForStateComplete(e){const t=[];let i=0;for(let[s,r]of e)if(r===it&&(t.push(s),i+=s.length,i>6e4))break;return t}}class at{constructor(){this.internalMap=new Map}has(e){return this.internalMap.has(e)}delete(e){return this.internalMap.delete(e)}decre(e){if(this.internalMap.has(e)){let t=this.internalMap.get(e);1===t?this.internalMap.delete(e):this.internalMap.set(e,t-1)}}incre(e){if(this.internalMap.has(e)){let t=this.internalMap.get(e);this.internalMap.set(e,t+1)}else this.internalMap.set(e,1)}clear(){this.internalMap.clear()}size(){return this.internalMap.size}}function ht(e){let t=0,i=e.currentTime,s=e.buffered;for(let e=s.length-1;e>=0;e--)if(i>=s.start(e)&&i<=s.end(e)){t=s.end(e)-i;break}return t>0?t:0}class lt extends Ce{constructor(e,t){super(e,t),this.logger.info("use DashScheduler"),this.sequential=!1,this.requestingMap=new Ge,this.bitset=new ot,this.bitCounts=new at,this.targetPeers=[],this.mBufferedDuration=0,this.allowP2pLimit=t.httpLoadTime+2,this.segmentBuilderMap=new Ge,this.resolveMap=new Map,this.playlistInfo=new Map,this.currentSegId="",this.nextSegId="",this.httpTimeouts=0,this.httpRangeErrs=0,this.coordinator=new et,this.config.live?this.maxPrefetchCount=10:(this.maxPrefetchCount=100,this.startCheckPeersTimer())}get httpRangeSupported(){return this.config.httpRangeSupported}handshakePeer(e){this._setupDC(e),e.sendMetaData(this.bitset.array(),this.sequential,this.peersNum,this.isMobileNet)}handleMetaData(e,t){t.field&&(e.bitset=new ot(this.config.live,t.field),t.field.forEach((e=>{this.bitset.has(e)||this.bitCounts.incre(e)})),this.addPeer(e),this.downloadOnly&&this.chokePeerRequest(e))}peersHas(e){return this.bitCounts.has(e)}reportTraffic(e,t,i){const{fetcher:s}=this.engine;s?(e>0&&s.reportFlow(e),t>0&&s.reportDCTraffic(t,i)):this.logger.error("DC report failed")}checkPeers(){if(!this.hasPeers)return;const{logger:e,config:t,engine:i}=this;if(this.getBufferedDuration()<this.allowP2pLimit)return void e.info(`low buffer time ${this.mBufferedDuration}, skip prefetch`);const{fragMap:s}=i;if(!s.has(this.currentSegId))return;const r=t.live,n=this.peerManager.getPeersOrderByWeight();if(0===n.length)return;const o=[];let a=10;r&&(a=1);let l=0;const c=s.get(this.currentSegId);let u=c.sn;const d=[...s.keys()],f=d.indexOf(this.currentSegId)+1;if(0===f)return;const g=[],p=d.slice(f);for(let e of p){const t=s.get(e);if(!(t&&t.sn>u))break;g.push(e),t.sn===c.sn+1&&(this.nextSegId=e)}if(0===g.length)return;let m=0;for(;o.length<a&&o.length<n.length&&l<this.maxPrefetchCount&&m<g.length;){const i=g[m];if(this.bitset.has(i))m++;else{if(this.bitCounts.has(i)&&!this.requestingMap.has(i))for(let s of n)if(!o.includes(s)&&s.bitset.has(i)){const n=s.bitset.getState(i);let a;a=n===it?r?h(0,100)>40:0===h(0,1):n===rt,o.push(s);const l=new Ze(this.coordinator,this.logger,i,t.httpRangeSupported);this._setupSynthesizer(l),a?l.setReversePeer(s):l.setForwardPeer(s),this.requestingMap.set(i,l),s.requestDataById(i,-1,!1),e.info(`request prefetch ${i} from peer ${s.remotePeerId}`);break}l++,m++}}this.loadedPeerNum=o.length}updateLoaded(e){this.bitset.has(e)||(this.bitset.add(e,it),this.bitCounts.has(e)&&this.bitCounts.delete(e))}notifyAllPeers(e,t=it){if(this.downloadOnly)return;if(this.bitset.has(e,t))return;const{live:i}=this.config,s=((e,t)=>`${e}-${t}`)(e,t);let r;t!==rt&&(r=t===it);const n=this.requestingMap.get(e);for(let o of this.getPeers())n&&n.hasPeer(o)||o.notifySet.has(s)||o.bitset.hasCompleteOr(e,t)||o.uploading||(o.sendMsgHave(-1,e,{reverse:t===rt,complete:r}),o.notifySet.add(s),i&&g(o.notifySet,20))}deletePeer(e){this.peerManager.hasPeer(e.remotePeerId)&&e.bitset.array().forEach((e=>{this.bitCounts.decre(e)})),this.cleanRequestingMap(e.remotePeerId),super.deletePeer(e)}hasAndSetTargetPeer(e,t){const{logger:i,config:s}=this;if(t<=this.allowP2pLimit)return!1;const r=1e3*(t-s.httpLoadTime),n=s.httpLoadTime+2;if(this.resolveMap.size>0&&i.info(`scheduler still loading ${[...this.resolveMap.keys()]}, num ${this.resolveMap.size}`),this.requestingMap.has(e)){const o=this.requestingMap.get(e);if(!o)return this._searchAvailablePeers(e);if(!o.shouldWaitForRemain(r)){if(i.warn(`syn prefetch timeout at ${e}`),o.isFull())return!1;const r=this.peerManager.getPeersOrderByWeight(),a=nt(r,it,e);if(o.hasReversePeer()){const t=a.concat(nt(r,st,e));if(t.length>0)return this.targetPeers.forwardPeer=t[0],!0}else{const t=a.concat(nt(r,rt,e));if(t.length>0)return this.targetPeers.reversePeer=t[0],!0}return s.httpRangeSupported&&t>n+1}return i.info(`prefetch ${e} wait for remain`),!0}return this._searchAvailablePeers(e)}_searchAvailablePeers(e){if(!this.hasIdlePeers||!this.peersHas(e))return!1;const t=this.peerManager.getPeersOrderByWeight(),[i,s]=((e,t)=>{const i=nt(e,it,t);if(i.length>=2)return[i[0],i[1]];if(1===i.length){const s=nt(e,st,t);if(s.length>=1)return[s[0],i[0]];const r=nt(e,rt,t);return r.length>=1?[i[0],r[0]]:0===h(0,1)?[null,i[0]]:[i[0],null]}const s=nt(e,st,t);if(s.length>=1)return[s[0],null];const r=nt(e,rt,t);return r.length>=1?[null,r[0]]:[null,null]})(t,e);return this.targetPeers={forwardPeer:i,reversePeer:s},[i,s].some((e=>!!e))}load(e,t,i){const{logger:s,config:r}=this;let n=this.mBufferedDuration-r.httpLoadTime;n>this.dcDownloadTimeout&&(n=this.dcDownloadTimeout);const{forwardPeer:o,reversePeer:a}=this.targetPeers;o||a||(n-=1);let h=this.requestingMap.get(e),l=0,c=0;if(i.Range){const e=i.Range.substring(6);l=Number(e.split("-")[0]),c=Number(e.split("-")[1]),delete i.Range}let u={rangeStart:Number(l),rangeEnd:Number(c)+1,url:t,httpLoadTime:1e3*r.httpLoadTime-500,headers:i};h?h.setExtra(u):(h=new Ze(this.coordinator,this.logger,e,this.httpRangeSupported,u),this._setupSynthesizer(h),this.requestingMap.set(e,h)),h.setTimeout(1e3*n),o&&(h.setForwardPeer(o),o.requestDataById(e,-1,!0)),a&&(h.setReversePeer(a),a.requestDataById(e,-1,!0,{reverse:!0}));const d=new Promise((t=>{const i={resolve:t};this.resolveMap.set(e,i)}));return this.targetPeers={},d}getBufferedDuration(){const e=ht(this.engine.media);return this.mBufferedDuration=e,e>0?e:0}onBufferManagerLost(e,t,i){this.bitset.delete(t),this.bitCounts.delete(t)}destroy(){super.destroy();const{logger:e}=this;this.segmentBuilderMap.clear(),e.warn("destroy ShakaScheduler")}_setupEngine(){}_setupDC(e){super._setupDC(e);const{logger:t}=this;e.on(E.DC_HAVE,(t=>{if(!e.bitset)return;const{seg_id:i,complete:s}=t;this.bitset.has(i)||this.bitCounts.incre(i);const r=s?it:st;e.bitset.add(i,r),e.isAvailableUrgently&&this._handleDCHave(e,i,r)})).on(E.DC_HAVE_REVERSE,(t=>{if(!e.bitset)return;const{seg_id:i}=t;this.bitset.has(i)||this.bitCounts.incre(i),e.bitset.hasCompleteOr(i,rt)||e.bitset.add(i,rt),e.isAvailableUrgently&&this._handleDCHave(e,i,rt)})).on(E.DC_LOST,(t=>{if(!e.bitset)return;const i=t.seg_id;e.bitset.has(i)&&(e.bitset.delete(i),this.bitCounts.decre(i))})).on(E.DC_PIECE,(e=>{const t=e.seg_id;e.ext&&e.ext.incompletes>=6||this.notifyAllPeers(t,e.reverse?rt:st)})).on(E.DC_PIECE_CANCEL,(t=>{const{seg_id:i}=t,s=this.requestingMap.get(i);if(s)return void s.removeStreamListener(e.remotePeerId);const r=this.segmentBuilderMap.get(i);r&&r.removeStreamListener(e.remotePeerId)})).on(E.DC_PIECE_NOT_FOUND,(t=>{const i=t.seg_id;e.bitset.delete(i),this.bitCounts.decre(i),e.checkIfNeedChoke(!0)})).on(E.DC_REQUEST,(i=>{const{seg_id:s,reverse:r}=i,n=this.requestingMap.get(s);let o=!1;n&&n.isDownloading()&&(o=r&&n.hasReversePeer()||!r&&n.hasForwardPeer());if(this.bufMgr.getSegById(s)){t.info(`found ${s} from bufMgr`);const i=this.bufMgr.getSegById(s);e.sendBuffer(-1,i.segId,i.data,{from:"FromCache",reverse:r})}else if(o){t.info(`syn had ${n.loadedPackets()} packets, wait remain from upstream ${n.getFromPeerId()}`);const i={...n.pieceMsg,reverse:r},s=r?n.reverseBufList:n.forwardBufList;e.sendPartialBuffer(i,s,{from:n.isFull()?"WaitPartialDouble":"WaitPartialSingle",incompletes:1}),s.length<i.attachments?a(n,e,r):e.uploading=!1}else if(r)e.sendPieceNotFound(-1,s);else{const i=this.segmentBuilderMap.get(s);i?(t.info(`peer request ${s} wait from builder, sent ${i.bufferList.length}`),function(e,t){t.sendPartialBuffer(e.pieceMsg,e.bufferList,{from:"FromHttpStream",incompletes:1}),e.bufferList.length<e.pieceMsg.attachments?a(e,t,!1):t.uploading=!1}(i,e)):(t.info(`peer request ${s} wait`),this.bufMgr.once(`${E.BM_ADDED_SEG_}${s}`,(i=>{i?(t.info(`peer request notify ${s}`),e.sendBuffer(-1,s,i.data,{from:"NotifySegment",reverse:r})):e.sendPieceNotFound(-1,s)})))}function a(e,t,i){e.addStreamListener(i,t.remotePeerId,((e,i,s,r,n)=>{s?t.sendMsgPieceAbort(r):t.send(r),n&&(t.uploading=!1)}))}}))}onHttpBodyStart(e){this.notifyAllPeers(e,st)}onFragLoading(e){this.currentSegId=e}onFragLoaded(e,t){t&&this.notifyAllPeers(e),this.updateLoaded(e)}_setupSynthesizer(e){e.on(E.SYN_OUTPUT,((t,i)=>{const{config:s,logger:r}=this,{segId:n,data:o}=t,{speed:a,http:h,p2p:l}=i;this.httpTimeouts>0&&this.httpTimeouts--;const c=this.resolveMap.has(n);if(s.validateSegment(n,new Uint8Array(o))){this.notifyAllPeers(n),this.bitset.has(n)||this.reportTraffic(h,l,a);const i=e.getFromPeerId();if(c){r.info(`receive criticalSeg seg_id ${n}`);const e=this.resolveMap.get(n);this.resolveMap.delete(n),e.resolve({data:o,fromPeerId:i})}else this.bitset.has(n)||(this.bufMgr.putSeg(t),this.updateLoaded(n))}else if(r.error(`segment ${n} validate failed`),c){const e=this.resolveMap.get(n);this.resolveMap.delete(n),e.resolve()}this.requestingMap.delete(n)})).on(E.SYN_ERROR,((e,t)=>{const{seg_id:i}=e;if(this.resolveMap.has(i)){const e=this.resolveMap.get(i);this.resolveMap.delete(i),e.resolve()}this.requestingMap.delete(i),this._handleSynError(t)}))}_handleDCHave(e,t,i){const s=0!==this.resolveMap.size;s&&this.resolveMap.has(t)?this._notifySynthesizer(e,t,i,!0):this.httpTimeouts>=1&&t===this.nextSegId&&this._notifySynthesizer(e,t,i,!1),this.config.live&&!s&&v()((()=>{this.checkPeers()}))}cleanRequestingMap(e){const t=this.peerManager.getPeer(e);if(t)for(let[i,s]of this.requestingMap.internalMap)s.hasPeerId(e)&&(this.logger.info(`delete ${i} in requestingMap`),s.deletePeer(t),this.bitCounts.decre(i),t.bitset.delete(i))}_notifySynthesizer(e,t,i,s=!0){const{logger:r}=this,n=this.requestingMap.get(t);function o(i,s){e.requestDataById(t,-1,s,{reverse:i})}n&&(n.isFull()||(n.isAlmostDeadline()?r.info("almost deadline, ignored"):n.hasForwardPeer()||i!==st&&i!==it?n.hasReversePeer()||i!==rt&&i!==it||(n.setReversePeer(e),o(!0,s)):(n.setForwardPeer(e),o(!1,s))))}_handleSynError(e){switch(e){case Je:this.logger.warn("ERROR_SYN_RANGE_REQUEST"),this.httpRangeErrs++;break;case Qe:this.logger.warn("ERROR_SYN_HTTP_TIMEOUT"),this.httpTimeouts+=3}}}const ct=0,ut=1,dt=2,ft=3,gt=(e,t,i,s,r)=>e.filter((e=>e.bitset.hasWithId(i,s,r,t)));class pt{constructor(e=!1,t){this.isLive=e,this.levelMap=new Map;for(let e in t){const i=Number(e);if(i<0)continue;const s=new Map;if(t[e])for(let i of t[e])s.set(i,{state:ut,segId:void 0});this.levelMap.set(i,s)}}totalLevels(){return this.levelMap.size}hasWithId(e,t,i,s=ct){if(t<0)return!1;const r=this._createOrGetSet(t).get(e);return!!r&&((!i||!r.segId||r.segId===i)&&(s===ct||r.state===s))}has(e,t,i=ct){return this.hasWithId(e,t,void 0,i)}hasCompleteOr(e,t,i=ut){const s=this._createOrGetSet(t).get(e);return!!s&&(s.state===ut||s.state===i)}getObj(e,t){let i=this._createOrGetSet(t).get(e);return i||(i={}),i}getSegId(e,t){return this.getObj(e,t).segId}getState(e,t){return this.getObj(e,t).state}delete(e,t){const i=this._createOrGetSet(t);return-1===t?(this.levelMap.forEach((t=>{t.delete(e)})),!0):i.delete(e)}add(e,t,i,s){if("number"!=typeof(r=e)||r%1!=0)return;var r;this._createOrGetSet(t).set(e,{state:s,segId:i}),this.isLive&&this._trimBitset(e)}array(e){const t=this._createOrGetSet(e);return this._keysForStateComplete(t)}allArray(){let e={};return this.levelMap.forEach(((t,i)=>{e[i]=this._keysForStateComplete(t)})),e}clear(){this.levelMap.forEach((e=>{e.clear()}))}size(e){return this._createOrGetSet(e).size}_createOrGetSet(e){"number"!=typeof e&&(e=Number(e));let t=this.levelMap.get(e);return t||(t=new Map,this.levelMap.set(e,t)),t}_trimBitset(e){const t=e-20;t>0&&this.levelMap.forEach((e=>{e.delete(t)}))}_keysForStateComplete(e){const t=[];for(let[i,s]of e)s.state===ut&&t.push(i);return t}}class mt{constructor(){this.levelMap=new Map}totalLevels(){return this.levelMap.size}has(e,t){return this._createOrGetMap(t).has(e)}delete(e,t){return this._createOrGetMap(t).delete(e)}decre(e,t){const i=this._createOrGetMap(t);if(i.has(e)){let t=i.get(e);1===t?i.delete(e):i.set(e,t-1)}}incre(e,t){const i=this._createOrGetMap(t);if(i.has(e)){let t=i.get(e);i.set(e,t+1)}else i.set(e,1)}clear(){this.levelMap.forEach((e=>{e.clear()}))}size(e){return this._createOrGetMap(e).size}_createOrGetMap(e){"number"!=typeof e&&(e=Number(e));let t=this.levelMap.get(e);return t||(t=new Map,this.levelMap.set(e,t)),t}}class _t extends(_()){constructor(e){super(),this.internalMap=new Map,this.eventName=e}has(e,t){return this.internalMap.has(this._generateId(e,t))}set(e,t,i){const s=this._generateId(e,t);this.internalMap.set(s,i),this.emit(`${this.eventName}${e}-${t}`,i)}get(e,t){return this.internalMap.get(this._generateId(e,t))}delete(e,t){const i=this._generateId(e,t),s=this.internalMap.get(i);return!!s&&(s.destroy(),this.internalMap.delete(i),!0)}clear(){this.internalMap.clear(),this.removeAllListeners()}_generateId(e,t){return"number"!=typeof t&&(t=Number(t)),`${t}-${e}`}}class yt extends(_()){constructor(e,t,i,s,r,n=!1,o){super(),this.coordinator=e,this.logger=t,this.rangeSupported=n,this.rangeStart=0,this.rangeEnd=0,this.httpLoadTime=2e3,this.allowLoadPartial=!1,this.pieceMsg={event:Xe.DC_PIECE,sn:i,level:s,seg_id:r},o&&this.setExtra(o),this.forwardPeer=null,this.reversePeer=null,this.bufArr=[],this.forwardBufList=[],this.reverseBufList=[],this.forwardOffset=-1,this.reverseOffset=1e4,this.timeStart=0,this.timeReceivePiece=0,this.timer=void 0,this.destroyed=!1,this.forwardStreamListeners=[],this.reverseStreamListeners=[],this.rangeRequesting=!1,this.waitingRemain=!1,this.httpLoaded=0,this.p2pLoaded=0,this.deadline=0,this.p2pCanceled=!1}get segId(){return this.pieceMsg.seg_id}isDownloading(){return this.timeReceivePiece>0}isAlmostDeadline(){return!!this.rangeRequesting||this.deadline>0&&this.deadline-performance.now()<400}hasPeer(e){return!!e&&(e===this.forwardPeer||e===this.reversePeer)}_notifyStreamListeners(e,t,i){const{sn:s,seg_id:r,attachments:n}=this.pieceMsg,o=e&&0===i||!e&&i===n-1,a=e?this.reverseStreamListeners:this.forwardStreamListeners;e?this.reverseBufList.push(t):this.forwardBufList.push(t),o&&(this.forwardBufList.push([...this.reverseBufList].reverse()),this.reverseBufList.push([...this.forwardBufList].reverse()));for(let e of a){const{handler:i}=e;i(s,r,!1,t,o)}o&&(a.length=0)}_notifyStreamListenersAbort(){const e=[...this.reverseStreamListeners,...this.forwardStreamListeners];for(let t of e){const{handler:e}=t;e(void 0,void 0,!0,"aborted by synthesizer")}e.length=0}_notifyStreamListenersRemain(){if(this.forwardStreamListeners.length>0){for(let e=this.forwardOffset+1;e<this.bufArr.length;e++)this._notifyStreamListeners(!1,this.bufArr[e],e);this.forwardStreamListeners=[]}if(this.reverseStreamListeners.length>0){for(let e=this.reverseOffset-1;e>=0;e--)this._notifyStreamListeners(!0,this.bufArr[e],e);this.reverseStreamListeners=[]}}addStreamListener(e,t,i){(e?this.reverseStreamListeners:this.forwardStreamListeners).push({handler:i,peerId:t})}removeStreamListener(e){const t=t=>t.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)));this.forwardStreamListeners=t(this.forwardStreamListeners),this.reverseStreamListeners=t(this.reverseStreamListeners)}setTimeout(e=0){e<=0?setTimeout((()=>{this._handleTimeout(!1,!1)}),0):(this.deadline=performance.now()+e,this._startTimer(e))}setExtra(e={}){e.url&&(this.url=e.url),e.rangeStart&&(this.rangeStart=e.rangeStart),e.rangeEnd&&(this.rangeEnd=e.rangeEnd),e.httpLoadTime&&(this.httpLoadTime=e.httpLoadTime),e.allowLoadPartial&&(this.allowLoadPartial=!0),e.xhrSetup&&(this.xhrSetup=e.xhrSetup),e.headers&&(this.headers=e.headers),e.segId&&!this.pieceMsg.seg_id&&(this.pieceMsg.seg_id=e.segId)}hasForwardPeer(){return!!this.forwardPeer}hasReversePeer(){return!!this.reversePeer}hasPeerId(e){return this.forwardPeer&&this.forwardPeer.remotePeerId===e||this.reversePeer&&this.reversePeer.remotePeerId===e}isEmpty(){return null===this.forwardPeer&&null===this.reversePeer}isFull(){return this.forwardPeer&&this.reversePeer}setForwardPeer(e){this.forwardPeer=e,this.reversePeer&&this._print(),this._setupPeer(e,!1)}setReversePeer(e){this.reversePeer=e,this.forwardPeer&&this._print(),this._setupPeer(e,!0)}deletePeer(e,t=!1){const i=e===this.reversePeer;this._detachPeer(e),i?(this.reversePeer=null,t&&(this.reverseOffset=this.pieceMsg.attachments||1e4)):(this.forwardPeer=null,t&&(this.forwardOffset=-1)),this.isEmpty()&&this._handleTimeout(!1,!1)}terminate(){this._handleTimeout(!1,!1)}_emitPartialOrError(e){if(this.allowLoadPartial&&this.hasPartialBuffer()){const[e,t]=this.getPartialBuffer();this.emit(Xe.SYN_PARTIAL,this.pieceMsg,e,t)}else this.emit(Xe.SYN_ERROR,this.pieceMsg,e)}hasPartialBuffer(){return this.hasForwardBuffer()||this.hasReverseBuffer()}hasForwardBuffer(){return this.forwardOffset>=0}hasReverseBuffer(){return this.pieceMsg&&this.reverseOffset<this.pieceMsg.attachments}getPartialBuffer(){return[this.forwardOffset>=0?r.l.concat(this.bufArr.slice(0,this.forwardOffset+1)):null,this.pieceMsg&&this.reverseOffset<this.pieceMsg.attachments?r.l.concat(this.bufArr.slice(this.reverseOffset)):null]}_cancelP2p(){if(this.p2pCanceled)return;this.p2pCanceled=!0;const{seg_id:e,sn:t,level:i}=this.pieceMsg;[this.forwardPeer,this.reversePeer].filter((e=>!!e)).forEach((s=>{s.cancelDownload(t,i,e)}))}destroy(){this.logger.info("destroy syn"),clearTimeout(this.timer),this._notifyStreamListenersAbort(),this._cancelP2p(),this.removeAllListeners(),this.destroyed=!0,this._detachPeer(this.forwardPeer),this.forwardPeer=null,this.forwardOffset=-1,this._detachPeer(this.reversePeer),this.reversePeer=null,this.reverseOffset=1e4,this.bufArr=[],this.forwardStreamListeners=[],this.reverseStreamListeners=[]}_detachPeer(e){if(!e)return;const t=e===this.reversePeer?this.reverseEvents:this.forwardEvents;e.off(Xe.DC_PIECE_DATA,t.onPieceData).off(Xe.DC_PIECE,t.onPiece).off(Xe.DC_PIECE_NOT_FOUND,t.onPieceNotFound).off(Xe.DC_PIECE_ABORT,t.onPieceAbort)}_receivePacket(e,t,i,s=!0){const{seg_id:n,sn:o,level:a,size:h}=this.pieceMsg,l=t-1;if(this.bufArr[l])return this.logger.warn(`syn bufArr ${this.pieceMsg.sn} already has ${l} size ${i.byteLength}`),!1;if(s?this.p2pLoaded+=i.byteLength:this.httpLoaded+=i.byteLength,this.bufArr[l]=i,e?this.reverseOffset=l:this.forwardOffset=l,this._notifyStreamListeners(e,i,l),this.forwardOffset!==this.reverseOffset-1)return!0;this.forwardPeer&&(this.forwardPeer.miss=0),this.reversePeer&&(this.reversePeer.miss=0),clearTimeout(this.timer),this._notifyStreamListenersRemain();const c=h/(performance.now()-this.timeStart);let u=r.l.concat(this.bufArr);const d=u.byteLength;if(d===h){let e=u.buffer;const t=new T(o,n,e,this.getFromPeerId(),a);this.emit(Xe.SYN_OUTPUT,t,{speed:c,p2p:this.p2pLoaded,http:this.httpLoaded})}else{this.logger.error(`${a}-${o} expectedSize ${h} != byteLength ${d} forward ${this.forwardOffset} reverse ${this.reverseOffset}`);for(let e=0;e<this.bufArr.length;e++)this.logger.error(`piece ${e} size ${this.bufArr[e].byteLength}`);this.emit(Xe.SYN_ERROR,this.pieceMsg,Ye)}}_setupPeer(e,t){0===this.timeStart&&(this.timeStart=performance.now());const i=(t,i,s,r,n,o)=>{if(this.destroyed)return;if(!this._validateMsg(t,o.level,i))return void this.logger.warn(`onPieceData ${o.level}-${t} not match ${JSON.stringify(this.pieceMsg)} from ${e.remotePeerId}`);const{reverse:a}=o;this._receivePacket(a,r,s)&&!this.waitingRemain&&!this.rangeRequesting&&this.deadline>0&&this._shouldSwitch()&&(this.logger.warn("should switch to http"),clearTimeout(this.timer),this._handleTimeout(!1,!1))},s=t=>{if(this.destroyed)return;const{attachments:i,size:s,sn:r,level:n,seg_id:o}=t;return s&&this._validateMsg(r,n,o)?this.pieceMsg.size&&s!==this.pieceMsg.size?(this.logger.warn(`onPiece ${t.level}-${t.sn} size not match`),void this.emit(Xe.SYN_ERROR,this.pieceMsg,Ye)):void(0===this.bufArr.length&&(this.pieceMsg={...this.pieceMsg,seg_id:o,size:s,attachments:i},this.reverseOffset=i,this.bufArr=new Array(i),this.timeReceivePiece=performance.now())):(this.logger.warn(`onPiece ${JSON.stringify(t)} not match ${JSON.stringify(this.pieceMsg)}`),void this.deletePeer(e))},r=t=>{this.destroyed||this.deletePeer(e)},n=()=>{this.destroyed||this.deletePeer(e)},o={onPieceData:i,onPiece:s,onPieceNotFound:r,onPieceAbort:n};t?this.reverseEvents=o:this.forwardEvents=o,e.on(Xe.DC_PIECE_DATA,i).once(Xe.DC_PIECE,s).once(Xe.DC_PIECE_NOT_FOUND,r).once(Xe.DC_PIECE_ABORT,n)}_validateMsg(e,t,i){return(!this.pieceMsg.seg_id||i===this.pieceMsg.seg_id)&&(e===this.pieceMsg.sn&&t===this.pieceMsg.level)}_shouldSwitch(){const e=this.pieceMsg.size-64e3*this.loadedPackets();return this.coordinator.shouldSwitchToHttp(e,this.deadline,this.p2pSpeed,64e3,this.httpLoadTime)}_startTimer(e,t=!0){this.timer=setTimeout(this._handleTimeout.bind(this,t),e)}loadedPackets(){return this.pieceMsg.attachments-(this.reverseOffset-this.forwardOffset-1)}_handleTimeout(e=!1,t=!0){if(this.destroyed)return;const{level:i,sn:s,size:r,attachments:n}=this.pieceMsg;if(!r||0===this.timeReceivePiece)return this.logger.warn(`syn load timeout ${i}-${s} url ${this.url}`),void this.emit(Xe.SYN_ERROR,this.pieceMsg,Ye);if(e&&this.timeReceivePiece>0&&(this.logger.warn(`syn ${this.loadedPackets()} of ${n} packets loaded`),this.shouldWaitForRemain(this.httpLoadTime))){const e=this.httpLoadTime;return this.waitingRemain=!0,this.logger.info(`syn wait for remain ${e}`),void this._startTimer(e,!1)}if(t){const e=[this.forwardPeer,this.reversePeer].filter((e=>!!e)).sort(((e,t)=>e.currentLoadSpeed()-t.currentLoadSpeed())).shift();e&&e.loadtimeout()}if(this._cancelP2p(),this.rangeSupported&&this.url)return this._loadRemainBufferByHttp();this._notifyStreamListenersAbort(),this._emitPartialOrError(Ke)}shouldWaitForRemain(e){if(e<=0||this.isEmpty())return!1;const t=performance.now()-this.timeStart;return t<500||t<1e3&&this.timeReceivePiece>0&&e>3e3||this.shouldWaitForRemainUrgent(e)}shouldWaitForRemainUrgent(e){if(0===this.timeReceivePiece||e<=0)return!1;const t=this.p2pSpeed;let i=0;[this.forwardPeer,this.reversePeer].forEach((e=>{e&&(i+=e.loadedBytes())}));const s=(this.pieceMsg.size-i)/e;return this.logger.info(`syn remainTime ${e} speed ${t} required ${s}`),t>=s}get p2pSpeed(){let e=0;return[this.forwardPeer,this.reversePeer].forEach((t=>{t&&(e+=t.currentLoadSpeed())})),e}getFromPeerId(){const{forwardPeer:e,reversePeer:t}=this;return this.isFull()&&e!==t?`${e.remotePeerId}:${t.remotePeerId}`:e?`${e.remotePeerId}`:t?`${t.remotePeerId}`:""}_loadRemainBufferByHttp(){if(this.rangeRequesting)return;const{size:e,sn:t,level:i}=this.pieceMsg,s=this.rangeEnd>0?this.rangeEnd-1:0,n=this.forwardOffset,o=Ve(n,this.reverseOffset,e,this.rangeStart,s),a=performance.now();let h=this.deadline+this.httpLoadTime-a+1e3;h<2e3?h=2e3:h>6e3&&(h=6e3),this.logger.info(`continue download ${i}-${t} from ${this.url} range: ${o} timeout ${h}`),this.rangeRequesting=!0,this.headers&&(this.xhrSetup=e=>{for(const t of Object.keys(this.headers))e.setRequestHeader(t,this.headers[t])}),l(this.url,o,this.xhrSetup,h).then((e=>{if(this.destroyed)return;if(this.rangeRequesting=!1,!e)return void this.emit(Xe.SYN_ERROR,this.pieceMsg,Je);let i=r.l.from(e);const s=i.byteLength/(performance.now()-a);this.coordinator.addHttpSpeed(s),i.byteLength===this.pieceMsg.size&&this.logger.warn(`syn range request ${t} resp whole ts`);const o=d(i,0);let h=n+1;for(let e=0;e<o.length;e++)this.bufArr[h]||this._receivePacket(!1,h+1,o[e],!1),h++})).catch((e=>{if(this.destroyed)return;this.rangeRequesting=!1,this.logger.error(`http partial download ${t} error ${e}`);const i="timeout"===e?Qe:Je;this.emit(Xe.SYN_ERROR,this.pieceMsg,i)}))}_print(){const{level:e,sn:t}=this.pieceMsg;this.logger.info(`syn parallel loading ${e}-${t}`)}}class vt extends Ce{constructor(e,t){super(e,t),this.bitset=new pt(t.live||!1),this.bitCounts=new mt,this.requestingMap=new _t(Xe.REQUESTING_MAP_HAVE),this.segmentBuilderMap=new _t(Xe.BUILDER_MAP_HAVE),this.allowP2pLimit=t.httpLoadTime+1.5,this.playlistInfo=new Map,this.isUploader=!1,this.isReceiver=!1,this.targetPeers={},this.mBufferedDuration=0,this.sequential=!0,this.httpTimeouts=0,this.httpRangeErrs=0,this.coordinator=new et,this.loadingSegId="",this.loadingSN=0,this.currPlaySN=0,this.currLostSN=-1,this.nextLostSN=-1,this.config.live?this.maxPrefetchCount=10:(this.maxPrefetchCount=150,this.startCheckPeersTimer())}get httpRangeSupported(){return this.config.httpRangeSupported}handshakePeer(e){this._setupDC(e),e.sendMetaData(this.bitset.allArray(),!0,this.peersNum,this.isMobileNet)}_receiveDCHave(e,t,i){this.bitset.has(e,t)||this.bitCounts.incre(e,t),this.emit(Xe.SCH_DCHAVE,i)}_setupDC(e){super._setupDC(e),e.on(Xe.DC_HAVE,(t=>{if(e.bitset&&t.sn>=0){const{sn:i,level:s,complete:r,seg_id:n}=t;this._receiveDCHave(i,s,n);const o=r?ut:dt;e.bitset.add(i,s,n,o),e.isAvailableUrgently&&this._handleDCHave(e,i,s,n,o)}})).on(Xe.DC_HAVE_REVERSE,(t=>{if(e.bitset&&t.sn>=0){const{sn:i,level:s,seg_id:r}=t;this._receiveDCHave(i,s,r),e.bitset.hasCompleteOr(i,s,ft)||e.bitset.add(i,s,r,ft),e.isAvailableUrgently&&this._handleDCHave(e,i,s,r,ft)}})).on(Xe.DC_LOST,(t=>{if(!e.bitset)return;const{sn:i,level:s}=t;e.bitset.has(i,s)&&(e.bitset.delete(i,s),this.bitCounts.decre(i,s))})).on(Xe.DC_PIECE,(e=>{e.ext&&e.ext.incompletes>=7||this.notifyAllPeers(e.sn,e.level,e.seg_id,e.reverse?ft:dt)})).on(Xe.DC_PIECE_CANCEL,(t=>{const{sn:i,level:s}=t,r=this.requestingMap.get(i,s);if(r)return void r.removeStreamListener(e.remotePeerId);const n=this.segmentBuilderMap.get(i,s);n&&n.removeStreamListener(e.remotePeerId)})).on(Xe.DC_PIECE_NOT_FOUND,(t=>{const{sn:i,level:s}=t;e.bitset.delete(i,s),this.bitCounts.decre(i,s),e.checkIfNeedChoke(!0)})).on(Xe.DC_REQUEST,(async t=>{const{logger:i}=this,{sn:s,level:r,reverse:n}=t;this.isUploader=!0;let o=t.seg_id;o||(o=await this.bufMgr.getSegIdBySN(s));const a=this.requestingMap.get(s,r);let h=!1;a&&a.isDownloading()&&(h=!0);const l=await this.bufMgr.getSegById(o);if(l)i.info("found seg from bufMgr"),l.level===r?e.sendBuffer(l.sn,l.segId,l.data,{from:this.engine.swVersion?"SWCache":"Cache",level:l.level,reverse:n}):e.sendPieceNotFound(s,o,{level:r});else if(h){i.info(`syn had ${a.loadedPackets()} packets, wait remain from upstream ${a.getFromPeerId()}`);const t={...a.pieceMsg,reverse:n},s=n?a.reverseBufList:a.forwardBufList;e.sendPartialBuffer(t,s,{from:a.isFull()?"WaitPartialDouble":"WaitPartialSingle",incompletes:1}),s.length<t.attachments?u(a,e,n):e.uploading=!1}else if(n)e.sendPieceNotFound(s,o,{level:r});else{const t=this.segmentBuilderMap.get(s,r);if(t)i.info(`peer request ${s} wait from builder, sent ${t.bufferList.length}`),c(t,e);else if(s>=this.loadingSN){let t;const a=a=>{this.segmentBuilderMap.off(`${Xe.BUILDER_MAP_HAVE}${s}-${r}`,t),a&&a.level===r?(i.info(`peer request notify seg ${a.sn}`),e.sendBuffer(a.sn,a.segId,a.data,{from:"NotifySegment",level:a.level,reverse:n})):e.sendPieceNotFound(s,o,{level:r})};t=t=>{this.bufMgr.off(`${Xe.BM_ADDED_SN_}${s}`,a),c(t,e)},i.info(`peer request ${s} wait from fragLoader`),this.segmentBuilderMap.once(`${Xe.BUILDER_MAP_HAVE}${s}-${r}`,t),this.bufMgr.once(`${Xe.BM_ADDED_SN_}${s}`,a)}else e.sendPieceNotFound(s,o,{level:r})}function c(e,t){t.sendPartialBuffer(e.pieceMsg,e.bufferList,{from:e.source,incompletes:1}),e.bufferList.length<e.pieceMsg.attachments?u(e,t,!1):t.uploading=!1}function u(e,t,i){e.addStreamListener(i,t.remotePeerId,((e,i,s,r,n)=>{s?t.sendMsgPieceAbort(r):t.send(r),n&&(t.uploading=!1)}))}}))}handleMetaData(e,t){if(t.field){e.bitset=new pt(this.config.live,t.field);for(let e in t.field){const i=Number(e);if(i<0)continue;t.field[i].forEach((e=>{this.bitset.has(e,i)||this.bitCounts.incre(e,i)}))}this.addPeer(e),this.downloadOnly&&this.chokePeerRequest(e)}}peersHas(e,t){return this.bitCounts.has(e,t)}deletePeer(e){if(this.peerManager.hasPeer(e.remotePeerId)&&e.bitset){const t=e.bitset.allArray();for(let e in t){const i=Number(e),s=t[i];s&&s.forEach((e=>{this.bitCounts.decre(e,i)}))}}this.cleanRequestingMap(e.remotePeerId),super.deletePeer(e)}hasAndSetTargetPeer(e,t,i,s){const{logger:r,config:n}=this;this.waitForPeer&&(this.mBufferedDuration=s=n.waitForPeerTimeout+n.httpLoadTime);let o=1e3*(s-n.httpLoadTime);const a=n.httpLoadTime+1.5;if(r.info(`bufferedDuration ${s} remainLoadTime ${o}`),s<=a)return!1;if(this.requestingMap.has(e,t)){const h=this.requestingMap.get(e,t);if(!h)return this._searchAvailablePeers(e,t,i);const l=h.segId;if(l&&l!==i)return r.warn(`syn segId ${l} not match ${i}`),this.requestingMap.delete(e,t),this._searchAvailablePeers(e,t,i);if(!h.shouldWaitForRemain(o)){if(r.warn(`syn prefetch timeout at ${e}`),h.isFull())return!1;const o=this.peerManager.getPeersOrderByWeight(),l=gt(o,ut,e,t,i);let c=gt(o,dt,e,t,i),u=gt(o,ft,e,t,i);if(h.hasReversePeer()){if(c=l.concat(c),c.length>0)return this.targetPeers.forwardPeer=c[0],!0}else if(h.hasForwardPeer()){if(u=l.concat(u),u.length>0)return this.targetPeers.reversePeer=u[0],!0}else{if(l.length>0)return h.hasForwardBuffer()?this.targetPeers.reversePeer=l[0]:this.targetPeers.forwardPeer=l[0],!0;{let e=!1;if(c.length>0&&(this.targetPeers.forwardPeer=c[0],e=!0),u.length>0&&(this.targetPeers.reversePeer=u[0],e=!0),e)return!0}}return!h.isEmpty()&&n.httpRangeSupported&&s>a+1}return r.info(`prefetch ${e} wait for remain`),!0}return this._searchAvailablePeers(e,t,i)}_searchAvailablePeers(e,t,i){if(!this.hasIdlePeers||!this.peersHas(e,t))return!1;const s=this.peerManager.getPeersOrderByWeight(),[r,n]=((e,t,i,s)=>{const r=gt(e,ut,t,i,s);if(r.length>=2)return[r[0],r[1]];if(1===r.length){const n=gt(e,dt,t,i,s);if(n.length>=1)return[n[0],r[0]];const o=gt(e,ft,t,i,s);return o.length>=1?[r[0],o[0]]:0===h(0,1)?[null,r[0]]:[r[0],null]}const n=gt(e,dt,t,i,s);if(n.length>=1)return[n[0],null];const o=gt(e,ft,t,i,s);return o.length>=1?[null,o[0]]:[null,null]})(s,e,t,i);return this.targetPeers={forwardPeer:r,reversePeer:n},[r,n].some((e=>!!e))}reportTraffic(e,t,i){const{fetcher:s}=this.engine;s?(e>0&&s.reportFlow(e),t>0&&s.reportDCTraffic(t,i)):this.logger.error("DC report failed")}notifyAllPeers(e,t,i,s=ut){if(!i)return void this.logger.error("segId is required");if(this.downloadOnly)return;const{live:r}=this.config;if(this.bitset.has(e,t,s))return;const n=((e,t,i)=>`${e}-${t}-${i}`)(e,t,s);let o;s!==ft&&(o=s===ut);const a=this.requestingMap.get(e,t);for(let h of this.getPeers())a&&a.hasPeer(h)||h.notifySet.has(n)||h.bitset.hasCompleteOr(e,t,s)||h.uploading||(h.sendMsgHave(e,i,{level:t,reverse:s===ft,complete:o}),h.notifySet.add(n),r&&g(h.notifySet,20))}checkPeers(){if(!this.hasPeers)return;const{logger:e,config:t,engine:i}=this,s=t.live,{currentLevel:r}=i;if(e.info(`currentLevel ${r}`),0===this.bitCounts.size(r))return;if(!s&&this.nextLostSN>=0&&this.nextLostSN>=this.currPlaySN-10)return;if(this.mBufferedDuration<this.allowP2pLimit&&(0!==this.mBufferedDuration||this.isHlsjs))return void e.info(`low buffer time ${this.mBufferedDuration}, skip prefetch`);const n=this.peerManager.getPeersOrderByWeight();if(0===n.length)return;const o=[];let{prefetchNum:a,endSN:l,startSN:c}=t;s&&(a=1);let u=0,d=this.loadingSN+1;if(!s)if(this.loadingSN>=l&&!this.bufMgr.overflowed)d=c;else{const e=Math.min(...n.filter((e=>e.endSN>=d)).map((e=>e?e.startSN:1/0)));if(!isFinite(e))return;d<e&&(d=e)}for(;o.length<a&&o.length<n.length&&u<this.maxPrefetchCount;){if(!s&&d>l)return;if(s&&d>this.loadingSN+2)return;if(this.bitset.has(d,r))d++;else{if(d!==this.loadingSN&&this.bitCounts.has(d,r)&&!this.requestingMap.has(d,r))for(let i of n)if(!o.includes(i)&&i.bitset.has(d,r)){const s=i.bitset.getState(d,r);let n;n=s===ut?0===h(0,1):s===ft,o.push(i);const a=i.bitset.getSegId(d,r),l=new yt(this.coordinator,this.logger,d,r,a,t.httpRangeSupported);this._setupSynthesizer(l),n?l.setReversePeer(i):l.setForwardPeer(i),this.requestingMap.set(d,r,l),i.requestDataBySN(d,!1,{level:r,reverse:n}),e.info(`request prefetch ${d} level ${r} from peer ${i.remotePeerId} downloadNum ${i.downloadNum} reverse ${n}`);break}u++,d++}}this.loadedPeerNum=o.length}onBufferManagerLost(e,t,i,s){this.currLostSN=e,i&&(this.nextLostSN=i),this.bitset.delete(e,s),this.bitCounts.delete(e,s)}cleanRequestingMap(e){const t=this.peerManager.getPeer(e);if(t)for(let[i,s]of this.requestingMap.internalMap){const r=i.split("-"),n=Number(r[1]),o=Number(r[0]);s.hasPeerId(e)&&(this.logger.info(`delete ${e} in synthesizer`),s.deletePeer(t),this.bitCounts.decre(n,o),t.bitset.delete(n,o))}}shouldWaitForNextSeg(){let e;return e=!this.isUploader&&(!!this.isReceiver||h(0,100)>20),this.isReceiver=this.isUploader=!1,e}updateLoaded(e,t,i){this.bitset.hasCompleteOr(e,t)||(this.bitset.add(e,t,i,ut),this.bitCounts.delete(e,t))}broadcastPlaylist(e,t){if(!this.config.live)return;const i=function(e){const t=e.split("\n");let i=0,s=0;for(let e of t){const t=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(e);if(t&&t[1]){i=parseInt(t[1],10);break}}for(let e of t)e.startsWith("#EXTINF")&&s++;return i+s-1}(t);if(!this.isMobileNet){let s=0;for(let r of this.getPeers())if(s++,r.sendMsgPlaylist(e,t,i),s>=5)break}this.playlistInfo.set(e,{seq:i})}getPlaylistFromPeer(e){if(!this.config.live)return null;const{seq:t}=this.playlistInfo.get(e);for(let i of this.getPeers()){const s=i.getLatestPlaylist(e,t);if(s)return s}return null}getBufferedDuration(){let{media:e,currentSrc:t}=this.engine;if(!e||e.src!==t&&0===e.currentTime){if(this.logger.info("try get video element"),e=function(e,t){let i;if(e&&("string"==typeof e?i=document.querySelector(e):e instanceof HTMLMediaElement&&(i=e)),!i){const e=[...document.getElementsByTagName("video"),...document.getElementsByTagName("audio")];1===e.length?i=e[0]:(t&&(i=e.find((e=>e.src===t))),i||(i=e.find((e=>e.currentTime>0))))}return i}(this.config.mediaElem,t),!e)return 5;this.engine.media=e}let i=0,s=e.currentTime,r=e.buffered;for(let e=r.length-1;e>=0;e--)if(s>=r.start(e)&&s<=r.end(e)){i=r.end(e)-s;break}return this.mBufferedDuration=i,i>0?i:0}destroy(){super.destroy(),this.requestingMap.clear(),this.segmentBuilderMap.clear()}_notifySynthesizer(e,t,i,s,r,n=!0){const{logger:o}=this,a=this.requestingMap.get(i,s);if(!a)return;const h=a.segId;function l(r,n){n?e.requestDataById(t,i,!0,{level:s,reverse:r}):(o.info(`notify syn prefetch ${i}`),e.requestDataBySN(i,!1,{level:s,reverse:r}))}function c(){return r===dt||r===ut}function u(){return r===ft||r===ut}t&&h&&t!==h?o.warn(`notifySynthesizer segId ${t} not match ${h}`):a.isFull()||(a.isAlmostDeadline()?o.info("almost deadline, ignored"):a.isEmpty()?a.hasForwardBuffer()&&u()?(a.setReversePeer(e),l(!0,n)):a.hasReverseBuffer()&&c()&&(a.setForwardPeer(e),l(!1,n)):!a.hasForwardPeer()&&c()?(a.setForwardPeer(e),l(!1,n)):!a.hasReversePeer()&&u()&&(a.setReversePeer(e),l(!0,n)))}_setupEngine(){}getStatsForPeer(){const{currentLevel:e,media:t}=this.engine,i={level:e};if(t&&!this.config.live){const{currentTime:e}=t;i.pos=Math.round(e)}return i}_handleSynError(e){switch(e){case Je:this.logger.warn("ERROR_SYN_RANGE_REQUEST"),this.httpRangeErrs++;break;case Qe:this.logger.warn("ERROR_SYN_HTTP_TIMEOUT"),this.httpTimeouts+=3}this.httpRangeErrs>=5&&(this.config.httpLoadTime<=4.5&&(this.config.httpLoadTime+=.5),this.httpRangeErrs=0)}}class bt extends vt{constructor(e,t){super(e,t),this.logger.info("use HlsScheduler"),this.isHlsjs=!0,this.resolveMap=new Map}load(e,t,i,s,r){const{logger:n,config:o}=this;this.isReceiver=!0;let a=this.mBufferedDuration-o.httpLoadTime;a>this.dcDownloadTimeout&&(a=this.dcDownloadTimeout);const{forwardPeer:h,reversePeer:l}=this.targetPeers;h||l||(a-=1);let c=this.requestingMap.get(e,i),u=0,d=0;if(r.Range){const e=r.Range.substring(6);u=Number(e.split("-")[0]),d=Number(e.split("-")[1]),delete r.Range}let f={rangeStart:Number(u),rangeEnd:Number(d)+1,url:s,httpLoadTime:1e3*o.httpLoadTime-500,headers:r};c?c.setExtra(f):(c=new yt(this.coordinator,this.logger,e,i,t,this.httpRangeSupported,f),this._setupSynthesizer(c),this.requestingMap.set(e,i,c)),c.setTimeout(1e3*a),h&&(c.setForwardPeer(h),h.requestDataById(t,e,!0,{level:i})),l&&(c.setReversePeer(l),l.requestDataById(t,e,!0,{level:i,reverse:!0}));const g=new Promise((s=>{const r={resolve:s,sn:e,level:i,segId:t};this.resolveMap.set(e,r)}));return this.targetPeers={},g}_setupSynthesizer(e){e.on(Xe.SYN_OUTPUT,((t,i)=>{const{config:s,logger:r}=this,{segId:n,sn:o,data:a,level:h}=t,{speed:l,http:c,p2p:u}=i;this.httpTimeouts>0&&this.httpTimeouts--;const d=this.resolveMap.has(o);if(s.validateSegment(n,new Uint8Array(a))){this.notifyAllPeers(o,h,n),this.bitset.has(o,h)||this.reportTraffic(c,u,l);const i=e.getFromPeerId();if(d){r.info(`receive criticalSeg seg_id ${n}`);const e=this.resolveMap.get(o);this.resolveMap.delete(o),e.resolve({data:a,fromPeerId:i})}else this.bitset.has(o,h)||(this.bufMgr.putSeg(t),this.updateLoaded(o,h,n))}else if(r.error(`segment ${n} validate failed`),d){const e=this.resolveMap.get(o);this.resolveMap.delete(o),e.resolve()}this.requestingMap.delete(o,h)})).on(Xe.SYN_ERROR,((e,t)=>{const{sn:i,level:s}=e;if(this.resolveMap.has(i)){const e=this.resolveMap.get(i);this.resolveMap.delete(i),e.resolve()}this.requestingMap.delete(i,s)}))}destroy(){super.destroy(),this.logger.warn("destroy HlsSwScheduler")}onFragLoading(e,t,i){this.loadingSN=e,this.isMobileNet||this.notifyAllPeers(e,t,i,dt)}onFragLoaded(e,t,i,s){if(s&&this.notifyAllPeers(e,t,i),this.updateLoaded(e,t,i),!this.engine)return;const{media:r,targetDuration:n}=this.engine;!this.config.live&&r&&n&&(this.currPlaySN=Math.ceil(r.currentTime/n))}_handleDCHave(e,t,i,s,r){const n=0!==this.resolveMap.size;n&&this.resolveMap.has(t)?this._notifySynthesizer(e,s,t,i,r):this.httpTimeouts>=1&&t===this.loadingSN+1&&this._notifySynthesizer(e,void 0,t,i,r,!1),this.config.live&&!n&&v()((()=>{this.checkPeers()}))}getBufferedDuration(){const e=ht(this.engine.media);return this.mBufferedDuration=e,e>0?e:0}}class St{static parse(e,t,i,s,r){const n=new window.Headers;(function(e){const t=new Map;for(const i of Object.keys(e))t.set(i,e[i]);return t})(t.headers).forEach(((e,t)=>{n.append(t,e)}));const o=new window.AbortController,a={body:t.body||void 0,headers:n,method:t.method,signal:o.signal,credentials:t.allowCrossSiteCredentials?"include":void 0},h={canceled:!1,timedOut:!1},l=St.request_(e,i,a,h,s,r,t.streamDataCallback),c=new shaka.util.AbortableOperation(l,(()=>(h.canceled=!0,o.abort(),Promise.resolve()))),u=t.retryParameters.timeout;if(u){const e=new shaka.util.Timer((()=>{h.timedOut=!0,o.abort()}));e.tickAfter(u/1e3),c.finally((()=>{e.stop()}))}return c}static async request_(e,t,i,s,o,a,h){const l=window.fetch,c=window.ReadableStream;let u,f,g=0,p=Date.now();try{u=await l(e,i),a&&a(St.headersToGenericObject_(u.headers));const t=u.clone().body.getReader(),s=u.headers.get("Content-Length"),m=s?parseInt(s,10):0,_=n;let y=0,v=0,b=(0,r.l)(0);new c({start:e=>{const i=async()=>{let s;try{s=await t.read()}catch(e){return void console.error("error reading from stream",e.message)}const{value:n,done:a}=s,l=Date.now();n&&(y+=n.length);let c=l-p,u=g-0,f=m-g;if(a||(g+=n.byteLength,h&&await h(s.value)),a){if(b.byteLength>0)if(y<=_){const e=(0,r.l)(y);b.copy(e,0,v*_,b.byteLength),o(c,u,0,{buffers:[e],aborted:!1})}else{const e=d(b,v*_);o(c,u,0,{buffers:e,aborted:!1})}e.close()}else{if(b=r.l.concat([b,n]),y>=_){y-=_;const e=(0,r.l)(_);b.copy(e,0,v*_,(v+1)*_),v++,o(c,u,f,{buffers:[e],aborted:!1})}e.enqueue(n),i()}};i()}}),f=await u.arrayBuffer()}catch(i){throw o(0,0,0,{buffers:[],aborted:!0}),s.canceled?new shaka.util.Error(shaka.util.Error.Severity.RECOVERABLE,shaka.util.Error.Category.NETWORK,shaka.util.Error.Code.OPERATION_ABORTED,e,t):s.timedOut?new shaka.util.Error(shaka.util.Error.Severity.RECOVERABLE,shaka.util.Error.Category.NETWORK,shaka.util.Error.Code.TIMEOUT,e,t):new shaka.util.Error(shaka.util.Error.Severity.RECOVERABLE,shaka.util.Error.Category.NETWORK,shaka.util.Error.Code.HTTP_ERROR,e,i,t)}return function(e,t,i,s,r,n){if(i>=200&&i<=299&&202!=i){return{uri:r||s,originalUri:s,data:t,status:i,headers:e,fromCache:!!e["x-shaka-from-cache"]}}{let r=null;try{r=shaka.util.StringUtils.fromBytesAutoDetect(t)}catch(e){}console.error("HTTP error text:",r);const o=401==i||403==i?shaka.util.Error.Severity.CRITICAL:shaka.util.Error.Severity.RECOVERABLE;throw new shaka.util.Error(o,shaka.util.Error.Category.NETWORK,shaka.util.Error.Code.BAD_HTTP_STATUS,s,i,r,e,n)}}(St.headersToGenericObject_(u.headers),f,u.status,e,u.url,t)}static headersToGenericObject_(e){const t={};return e.forEach(((e,i)=>{t[i.trim()]=e})),t}static isSupported(){if(!window.ReadableStream)return!1;try{new ReadableStream({})}catch(e){return!1}return!(!window.fetch||!window.AbortController)}}class wt{constructor(e,t){this.bufferList=[],this.streamListeners=[],this.finished=!1,this.source="HttpStream",this.packetSize=n,this.attachments=t%this.packetSize==0?t/this.packetSize:Math.floor(t/this.packetSize)+1,this.pieceMsg={event:E.DC_PIECE,attachments:this.attachments,seg_id:e,size:t}}receiveBytes(e,t){e.byteLength&&(this.bufferList.push(e),t&&(this.finished=!0),this._notifyStreamListeners(e))}destroy(){this.finished||this._notifyStreamListenersAbort()}addStreamListener(e,t,i){this.streamListeners.push({handler:i,peerId:t})}removeStreamListener(e){this.streamListeners=this.streamListeners.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)))}_notifyStreamListenersAbort(){const{sn:e,seg_id:t}=this.pieceMsg;for(let i of this.streamListeners){const{handler:s}=i;s(e,t,!0,"aborted by httpLoader")}this.streamListeners.length=0}_notifyStreamListeners(e){const{sn:t,seg_id:i}=this.pieceMsg;for(let s of this.streamListeners){const{handler:r}=s;r(t,i,!1,e,this.finished)}this.finished&&(this.streamListeners.length=0)}}class Pt{constructor(e,t,i,s){this.bufferList=[],this.streamListeners=[],this.finished=!1,this.packetSize=n,this.attachments=s%this.packetSize==0?s/this.packetSize:Math.floor(s/this.packetSize)+1,this.pieceMsg={event:E.DC_PIECE,attachments:this.attachments,seg_id:i,sn:e,level:t,size:s,reverse:!1},this.sink=(0,r.l)(0),this.source="HttpStream"}receiveBytes(e,t){e.byteLength&&(this.sink=r.l.concat([this.sink,e]),this.bufferList.push(e),t&&(this.finished=!0),this._notifyStreamListeners(e))}getCompleteBuffer(){return this.sink.buffer}destroy(){this.finished||this._notifyStreamListenersAbort()}addStreamListener(e,t,i){this.streamListeners.push({handler:i,peerId:t})}removeStreamListener(e){this.streamListeners=this.streamListeners.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)))}_notifyStreamListenersAbort(){for(let e of this.streamListeners){const{handler:t}=e;t(void 0,void 0,!0,"aborted by httpLoader")}this.streamListeners.length=0}_notifyStreamListeners(e){const{sn:t,seg_id:i}=this.pieceMsg;for(let s of this.streamListeners){const{handler:r}=s;r(t,i,!1,e,this.finished)}this.finished&&(this.streamListeners.length=0)}}class Et{constructor(){this.method=null,this.key=null,this.iv=null,this._uri=null}get uri(){return!this._uri&&this.reluri&&(this._uri=e.buildAbsoluteURL(this.baseuri,this.reluri,{alwaysNormalize:!0})),this._uri}}class Tt{constructor(){this._url=null,this._byteRange=null,this._decryptdata=null,this.tagList=[],this.programDateTime=null,this.rawProgramDateTime=null,this._elementaryStreams={[Tt.ElementaryStreamTypes.AUDIO]:!1,[Tt.ElementaryStreamTypes.VIDEO]:!1}}static get ElementaryStreamTypes(){return{AUDIO:"audio",VIDEO:"video"}}get url(){return!this._url&&this.relurl&&(this._url=e.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url}set url(e){this._url=e}get byteRange(){if(!this._byteRange&&!this.rawByteRange)return[];if(this._byteRange)return this._byteRange;let e=[];if(this.rawByteRange){const t=this.rawByteRange.split("@",2);if(1===t.length){const t=this.lastByteRangeEndOffset;e[0]=t||0}else e[0]=parseInt(t[1]);e[1]=parseInt(t[0])+e[0],this._byteRange=e}return e}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get decryptdata(){return this._decryptdata||(this._decryptdata=this.fragmentDecryptdataFromLevelkey(this.levelkey,this.sn)),this._decryptdata}get endProgramDateTime(){if(!Number.isFinite(this.programDateTime))return null;let e=Number.isFinite(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){return!(!this.decryptdata||null===this.decryptdata.uri||null!==this.decryptdata.key)}addElementaryStream(e){this._elementaryStreams[e]=!0}hasElementaryStream(e){return!0===this._elementaryStreams[e]}createInitializationVector(e){let t=new Uint8Array(16);for(let i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}fragmentDecryptdataFromLevelkey(e,t){let i=e;return e&&e.method&&e.uri&&!e.iv&&(i=new Et,i.method=e.method,i.baseuri=e.baseuri,i.reluri=e.reluri,i.iv=this.createInitializationVector(t)),i}}class It{constructor(e){this.endCC=0,this.endSN=0,this.fragments=[],this.initSegment=null,this.live=!0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=e,this.version=null}get hasProgramDateTime(){return!(!this.fragments[0]||!Number.isFinite(this.fragments[0].programDateTime))}}const Ct=/^(\d+)x(\d+)$/,Nt=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class Dt{constructor(e){"string"==typeof e&&(e=Dt.parseAttrList(e));for(let t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const i=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)i[e]=parseInt(t.slice(2*e,2*e+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}enumeratedString(e){return this[e]}decimalResolution(e){const t=Ct.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t,i={};for(Nt.lastIndex=0;null!==(t=Nt.exec(e));){let e=t[2],s='"';0===e.indexOf(s)&&e.lastIndexOf(s)===e.length-1&&(e=e.slice(1,-1)),i[t[1]]=e}return i}}const Lt=Dt,Mt={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0}};const Rt=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,At=/#EXT-X-MEDIA:(.*)/g,Ot=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/|(?!#)([\S+ ?]+)/.source,/|#EXT-X-BYTERANGE:*(.+)/.source,/|#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/|#.*/.source].join(""),"g"),xt=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:(#)([^:]*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,kt=/\.(mp4|m4s|m4v|m4a)$/i;class Bt{static findGroup(e,t){if(!e)return null;let i=null;for(let s=0;s<e.length;s++){const r=e[s];r.id===t&&(i=r)}return i}static convertAVC1ToAVCOTI(e){let t,i=e.split(".");return i.length>2?(t=i.shift()+".",t+=parseInt(i.shift()).toString(16),t+=("000"+parseInt(i.shift()).toString(16)).substr(-4)):t=e,t}static resolve(t,i){return e.buildAbsoluteURL(i,t,{alwaysNormalize:!0})}static parseMasterPlaylist(e,t){let i,s=[];function r(e,t){["video","audio"].forEach((i=>{const s=e.filter((e=>function(e,t){const i=Mt[t];return!!i&&!0===i[e.slice(0,4)]}(e,i)));if(s.length){const r=s.filter((e=>0===e.lastIndexOf("avc1",0)||0===e.lastIndexOf("mp4a",0)));t[`${i}Codec`]=r.length>0?r[0]:s[0],e=e.filter((e=>-1===s.indexOf(e)))}})),t.unknownCodecs=e}for(Rt.lastIndex=0;null!=(i=Rt.exec(e));){const e={},n=e.attrs=new Lt(i[1]);e.url=Bt.resolve(i[2],t);const o=n.decimalResolution("RESOLUTION");o&&(e.width=o.width,e.height=o.height),e.bitrate=n.decimalInteger("AVERAGE-BANDWIDTH")||n.decimalInteger("BANDWIDTH"),e.name=n.NAME,r([].concat((n.CODECS||"").split(/[ ,]+/)),e),e.videoCodec&&-1!==e.videoCodec.indexOf("avc1")&&(e.videoCodec=Bt.convertAVC1ToAVCOTI(e.videoCodec)),s.push(e)}return s}static parseMasterPlaylistMedia(e,t,i,s=[]){let r,n=[],o=0;for(At.lastIndex=0;null!==(r=At.exec(e));){const e={},a=new Lt(r[1]);if(a.TYPE===i){if(e.groupId=a["GROUP-ID"],e.name=a.NAME,e.type=i,e.default="YES"===a.DEFAULT,e.autoselect="YES"===a.AUTOSELECT,e.forced="YES"===a.FORCED,a.URI&&(e.url=Bt.resolve(a.URI,t)),e.lang=a.LANGUAGE,e.name||(e.name=e.lang),s.length){const t=Bt.findGroup(s,e.groupId);e.audioCodec=t?t.codec:s[0].codec}e.id=o++,n.push(e)}}return n}static parseLevelPlaylist(e,t){let i,s,r=0,n=0,o=new It(t),a=new Et,h=0,l=null,c=new Tt,u=null;for(Ot.lastIndex=0;null!==(i=Ot.exec(e));){const e=i[1];if(e){c.duration=parseFloat(e);const t=(" "+i[2]).slice(1);c.title=t||null,c.tagList.push(t?["INF",e,t]:["INF",e])}else if(i[3]){if(Number.isFinite(c.duration)){const e=r++;c.start=n,c.levelkey=a,c.sn=e,c.cc=h,c.baseurl=t,c.relurl=(" "+i[3]).slice(1),$t(c,l),o.fragments.push(c),l=c,n+=c.duration,c=new Tt}}else if(i[4]){if(c.rawByteRange=(" "+i[4]).slice(1),l){const e=l.byteRangeEndOffset;e&&(c.lastByteRangeEndOffset=e)}}else if(i[5])c.rawProgramDateTime=(" "+i[5]).slice(1),c.tagList.push(["PROGRAM-DATE-TIME",c.rawProgramDateTime]),null===u&&(u=o.fragments.length);else{for(i=i[0].match(xt),s=1;s<i.length&&void 0===i[s];s++);const e=(" "+i[s+1]).slice(1),n=(" "+i[s+2]).slice(1);switch(i[s]){case"#":c.tagList.push(n?[e,n]:[e]);break;case"PLAYLIST-TYPE":o.type=e.toUpperCase();break;case"MEDIA-SEQUENCE":r=o.startSN=parseInt(e);break;case"TARGETDURATION":o.targetduration=parseFloat(e);break;case"VERSION":o.version=parseInt(e);break;case"EXTM3U":break;case"ENDLIST":o.live=!1;break;case"DIS":h++,c.tagList.push(["DIS"]);break;case"DISCONTINUITY-SEQ":h=parseInt(e);break;case"KEY":var d=new Lt(e),f=d.enumeratedString("METHOD"),g=d.URI,p=d.hexadecimalInteger("IV");f&&(a=new Et,g&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(f)>=0&&(a.method=f,a.baseuri=t,a.reluri=g,a.key=null,a.iv=p));break;case"START":let s=new Lt(e).decimalFloatingPoint("TIME-OFFSET");Number.isFinite(s)&&(o.startTimeOffset=s);break;case"MAP":let l=new Lt(e);c.relurl=l.URI,c.rawByteRange=l.BYTERANGE,c.baseurl=t,c.sn="initSegment",o.initSegment=c,c=new Tt,c.rawProgramDateTime=o.initSegment.rawProgramDateTime;break;default:console.warn(`line parsed but not handled: ${i}`)}}}return c=l,c&&!c.relurl&&(o.fragments.pop(),n-=c.duration),o.totalduration=n,o.averagetargetduration=n/o.fragments.length,o.endSN=r-1,o.startCC=o.fragments[0]?o.fragments[0].cc:0,o.endCC=h,!o.initSegment&&o.fragments.length&&o.fragments.every((e=>kt.test(e.relurl)))&&(console.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),c=new Tt,c.relurl=o.fragments[0].relurl,c.baseurl=t,c.level=id,c.sn="initSegment",o.initSegment=c,o.needSidxRanges=!0),u&&function(e,t){let i=e[t];for(let s=t-1;s>=0;s--){const t=e[s];t.programDateTime=i.programDateTime-1e3*t.duration,i=t}}(o.fragments,u),o}}function $t(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),Number.isFinite(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}const Ut="store not init";function qt(e){return new Promise(((t,i)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>i(e.error)}))}function zt(e,t){return t?t("readonly",(t=>qt(t.get(e)))):Promise.reject(Ut)}function Ft(e,t,i){return i?i("readwrite",(i=>(i.put(t,e),qt(i.transaction)))):Promise.reject(Ut)}function Ht(e,t){return t?t("readwrite",(t=>(t.delete(e),qt(t.transaction)))):Promise.reject(Ut)}function Wt(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},qt(e.transaction)}const jt="size";class Gt extends(_()){constructor(e,t){super(),this.name="SegmentStore",this.logger=t.logger,this.logger.info("use SegmentStore"),this.channel=e.channel;const i=e.browserInfo.device;this.isPC=i===C().device.PC_WEB||i===C().device.PC_NATIVE,this.maxBufSize=this.isPC?t.diskCacheLimit.pc:t.diskCacheLimit.mobile,this.overflowed=!1,this.loadingSN=0}async setupStore(){if(navigator.storage&&navigator.storage.estimate){const e=await navigator.storage.estimate(),t=Math.floor(e.quota-e.usage);t<this.maxBufSize&&(this.maxBufSize=t-104857600)}return new Promise((async(e,t)=>{if(this.isPC&&this.maxBufSize<629145600||!this.isPC&&this.maxBufSize<367001600)return void t("disk storage not enough");let i=function(e,t){const i=indexedDB.open(e);i.onupgradeneeded=()=>{const e=i.result;t.forEach((t=>{e.createObjectStore(t)}))};const s=qt(i);return t.map((e=>(t,i)=>s.then((s=>i(s.transaction(e,t).objectStore(e))))))}(this.channel,["segments","id2Sn","metadata"]);this.segmentsStore=i[0],this.id2SnStore=i[1],this.metaStore=i[2];const s=setTimeout((()=>{t("setupStore timeout")}),500);this._initMetaStore().then((()=>{clearTimeout(s),e()})).catch((e=>{t(e)}))}))}_initMetaStore(){return new Promise(((e,t)=>{zt(jt,this.metaStore).then((t=>{t||(this.logger.info("init MetaStore size"),Ft(jt,0,this.metaStore)),e()})).catch((e=>{t()}))}))}currBufSize(){return zt(jt,this.metaStore)}async hasSegOfId(e){if(!e)return Promise.resolve(!1);const t=await zt(e,this.id2SnStore);return new Promise(((i,s)=>{void 0!==t?zt(t,this.segmentsStore).then((t=>{t&&t.length>0&&t.some((t=>t.segId===e))?i(!0):i(!1)})).catch((e=>{this.logger.error(e),i(!1)})):i(!1)}))}async getSegById(e){if(!e)return null;const t=await zt(e,this.id2SnStore);return new Promise(((e,i)=>{void 0!==t?zt(t,this.segmentsStore).then((t=>{if(t&&t.length>0){const i=t[0];if(!p(i.data))return this.logger.error(`getSegById ${i.sn} is not buffer`),void e(null);e(T.fromSegment(i))}else e(null)})).catch((t=>{this.logger.error(t),e(null)})):e(null)}))}getSegIdBySN(e){return new Promise(((t,i)=>{zt(e,this.segmentsStore).then((e=>{e&&e.length>0?t(e[0].segId):t(null)})).catch((e=>{this.logger.error(e),t(null)}))}))}putSeg(e){const{logger:t}=this;p(e.data)?this._addSeg(e).then((e=>{this.emit(`${E.BM_ADDED_SN_}${e.sn}`,e),this.emit(E.BM_SEG_ADDED,e)})).catch((e=>{t.error(e),("QuotaExceededError"===e.name||e.inner&&"QuotaExceededError"===e.inner.name)&&this._trimDisk(!0)})):t.error(`putSeg ${e.sn} is not buffer`)}_addSeg(e){const{segId:t,sn:i}=e;return Ft(t,i,this.id2SnStore),new Promise(((s,r)=>{zt(i,this.segmentsStore).then((n=>{n?0===n.filter((e=>e.segId===t)).length&&(n.push(this._segmentToCache(e)),Ft(i,n,this.segmentsStore).then((()=>{this._increaseBufSize(e.data.byteLength),s(e)})).catch((e=>{r(e)}))):Ft(i,[this._segmentToCache(e)],this.segmentsStore).then((()=>{this._increaseBufSize(e.data.byteLength),s(e)})).catch((e=>{r(e)}))})).catch((e=>{r(e)}))}))}async _trimDisk(e=!1){let t=this.maxBufSize;const{logger:i}=this;let s=await this.currBufSize();var r;(e&&(t=s-52428800,t<0&&(t=0)),s<t)||(r=this.segmentsStore,r?r("readonly",(e=>{if(e.getAllKeys)return qt(e.getAllKeys());const t=[];return Wt(e,(e=>t.push(e.key))).then((()=>t))})):Promise.reject(Ut)).then((async e=>{const r=e.sort(((e,t)=>e-t));let n=0;do{if(n++>10){console.error("too much loops in SegmentStore");break}const e=r.shift();if(void 0===e){i.error("lastSN not found");continue}if(e>=this.loadingSN){i.warn(`trimDisk failed, loadingSN ${this.loadingSN}`);break}const t=r[0],o=await zt(e,this.segmentsStore);if(!o){i.warn("lastSeg not found");continue}let a=0;o.forEach((e=>{a+=e.data.byteLength})),Ht(e,this.segmentsStore).then((()=>{this._decreaseBufSize(parseInt(a))})),o.forEach((s=>{Ht(s.segId,this.id2SnStore),i.info(`pop seg ${s.segId} size ${s.data.byteLength}`),this.emit(E.BM_LOST,{sn:e,segId:s.segId,next:t,level:s.level})})),s-=a,i.info(`pop sn ${e} size ${a} currBufSize ${s}`),this.overflowed||(this.overflowed=!0)}while(s>=t)}))}_decreaseBufSize(e){zt(jt,this.metaStore).then((t=>{t&&Ft(jt,t-e,this.metaStore)})).catch((e=>{this.logger.error(e)}))}_increaseBufSize(e){zt(jt,this.metaStore).then((t=>{Ft(jt,t+e,this.metaStore),this._trimDisk()})).catch((e=>{this.logger.error(e)}))}_segmentToCache(e){return{data:e.data,level:e.level,segId:e.segId,sn:e.sn}}clear(){this.logger.warn("clear segment store");try{this._clearDisk()}catch(e){}}_clearDisk(e){return function(e){return new Promise(((t,i)=>{indexedDB.databases().then((s=>{const r=s.filter((t=>t.name!==e)).map((e=>new Promise(((t,i)=>{const s=indexedDB.deleteDatabase(e.name);s.onsuccess=t,s.onerror=i,s.onblocked=i}))));Promise.all(r).then(t).catch(i)})).catch(i)})).catch((e=>{}))}(e)}destroy(){this.clear(),this.removeAllListeners()}}const Xt=Gt;class Vt extends(_()){constructor(e,t){super(),this.name="SegmentCache",this.logger=t.logger,this.logger.info("use SegmentCache");const i=e.browserInfo.device;if(this.maxBufSize=i===C().device.PC_WEB||i===C().device.PC_NATIVE?t.memoryCacheLimit.pc:t.memoryCacheLimit.mobile,t.live)this.maxBufSize=31457280;else{const e=function(){const{memory:e}=performance;return e?e.jsHeapSizeLimit-e.usedJSHeapSize:-1}();e>=0&&e<this.maxBufSize&&(this.maxBufSize=e-31457280)}this._segPool=new Map,this._currBufSize=0,this.id2Sn=new Map,this.overflowed=!1,this.loadingSN=0}get currBufSize(){return this._currBufSize}hasSegOfId(e){return new Promise(((t,i)=>{const s=this.id2Sn.get(e);this._segPool.has(s)?t(this._segPool.get(s).some((t=>t.segId===e))):t(!1)}))}getSegById(e){const t=this.id2Sn.get(e);return new Promise(((i,s)=>{if(!this._segPool.has(t))return void i(null);const r=this._segPool.get(t);for(let t of r)if(t.segId===e)return void i(t);i(null)}))}getSegIdBySN(e){return new Promise(((t,i)=>{if(this._segPool.has(e)){t(this._segPool.get(e)[0].segId)}else t(null)}))}_calSegPoolSize(){let e=0;return this._segPool.forEach((t=>{t.forEach((t=>{e+=t.size}))})),e}putSeg(e){this._currBufSize>=1.5*this.maxBufSize&&(this._currBufSize=this._calSegPoolSize(),this._currBufSize>=1.5*this.maxBufSize&&(this.clear(),this.overflowed=!1)),p(e.data)?this._addSeg(e):this.logger.error(`putSeg ${e.sn} is not buffer`)}_addSeg(e){const{logger:t}=this,{segId:i,sn:s,size:r}=e;if(this.id2Sn.set(i,s),this._segPool.has(s)){this._segPool.get(s).push(e)}else this._segPool.set(s,[e]);this._currBufSize+=parseInt(r);const n=this._segPool.size;if(this.emit(`${E.BM_ADDED_SN_}${e.sn}`,e),this.emit(E.BM_SEG_ADDED,e),this._currBufSize<this.maxBufSize||n<=5)return;const o=Array.from(this._segPool.keys()).sort(((e,t)=>e-t));let a=0;do{if(a++>10){console.error("too much loops in SegmentCache");break}const e=o.shift();if(void 0===e){t.error("lastSN not found");continue}const i=o[0],s=this._segPool.get(e);if(!s){t.error("lastSeg not found");continue}let r=0;s.forEach((e=>{r+=e.size})),this._currBufSize-=parseInt(r),this._segPool.delete(e),s.forEach((t=>{this.id2Sn.delete(t.segId),this.emit(E.BM_LOST,{sn:e,segId:t.segId,next:i,level:t.level})})),t.info(`pop sn ${e} size ${r} currBufSize ${this._currBufSize}`),this.overflowed||(this.overflowed=!0)}while(this._currBufSize>=this.maxBufSize&&this._segPool.size>5)}clear(){this.logger.warn("clear segment cache"),this._segPool.clear(),this.id2Sn.clear(),this._currBufSize=0}destroy(){this.clear(),this.removeAllListeners()}}const Yt=Vt,Jt=e=>!!e&&"object"==typeof e,Qt=(...e)=>e.reduce(((e,t)=>("object"!=typeof t||Object.keys(t).forEach((i=>{Array.isArray(e[i])&&Array.isArray(t[i])?e[i]=e[i].concat(t[i]):Jt(e[i])&&Jt(t[i])?e[i]=Qt(e[i],t[i]):e[i]=t[i]})),e)),{}),Kt=e=>Object.keys(e).map((t=>e[t])),Zt=e=>e.reduce(((e,t)=>e.concat(t)),[]),ei=e=>{if(!e.length)return[];const t=[];for(let i=0;i<e.length;i++)t.push(e[i]);return t},ti="INVALID_NUMBER_OF_PERIOD",ii="DASH_EMPTY_MANIFEST",si="DASH_INVALID_XML",ri="NO_BASE_URL",ni="SEGMENT_TIME_UNSPECIFIED";function oi(e){const t=(i=e,window.atob?window.atob(i):Buffer.from(i,"base64").toString("binary"));var i;const s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s}const ai="http://example.com",hi=(e,i)=>{if(/^[a-z]+:/i.test(i))return i;/^data:/.test(e)&&(e=window.location&&window.location.href||"");const s="function"==typeof window.URL,r=/^\/\//.test(e),n=!window.location&&!/\/\//i.test(e);if(s?e=new window.URL(e,window.location||ai):/\/\//i.test(e)||(e=t().buildAbsoluteURL(window.location&&window.location.href||"",e)),s){const t=new URL(i,e);return n?t.href.slice(ai.length):r?t.href.slice(t.protocol.length):t.href}return t().buildAbsoluteURL(e,i)},li=e=>{let t;return t="bigint"==typeof e.offset||"bigint"==typeof e.length?window.BigInt(e.offset)+window.BigInt(e.length)-window.BigInt(1):e.offset+e.length-1,`${e.offset}-${t}`},ci=({baseUrl:e="",source:t="",range:i="",indexRange:s=""})=>{const r={uri:t,resolvedUri:hi(e||"",t)};if(i||s){const e=(i||s).split("-");let t,n=window.BigInt?window.BigInt(e[0]):parseInt(e[0],10),o=window.BigInt?window.BigInt(e[1]):parseInt(e[1],10);n<Number.MAX_SAFE_INTEGER&&"bigint"==typeof n&&(n=Number(n)),o<Number.MAX_SAFE_INTEGER&&"bigint"==typeof o&&(o=Number(o)),t="bigint"==typeof o||"bigint"==typeof n?window.BigInt(o)-window.BigInt(n)+window.BigInt(1):o-n+1,"bigint"==typeof t&&t<Number.MAX_SAFE_INTEGER&&(t=Number(t)),r.byterange={length:t,offset:n}}return r},ui=e=>(e&&"number"!=typeof e&&(e=parseInt(e,10)),isNaN(e)?null:e),di={static(e){const{duration:t,timescale:i=1,sourceDuration:s,periodDuration:r}=e,n=ui(e.endNumber),o=t/i;return"number"==typeof n?{start:0,end:n}:"number"==typeof r?{start:0,end:r/o}:{start:0,end:s/o}},dynamic(e){const{NOW:t,clientOffset:i,availabilityStartTime:s,timescale:r=1,duration:n,periodStart:o=0,minimumUpdatePeriod:a=0,timeShiftBufferDepth:h=1/0}=e,l=ui(e.endNumber),c=(t+i)/1e3,u=s+o,d=c+a-u,f=Math.ceil(d*r/n),g=Math.floor((c-u-h)*r/n),p=Math.floor((c-u)*r/n);return{start:Math.max(0,g),end:"number"==typeof l?l:Math.min(f,p)}}},fi=e=>{const{type:t,duration:i,timescale:s=1,periodDuration:r,sourceDuration:n}=e,{start:o,end:a}=di[t](e),h=((e,t)=>{const i=[];for(let s=e;s<t;s++)i.push(s);return i})(o,a).map((e=>t=>{const{duration:i,timescale:s=1,periodStart:r,startNumber:n=1}=e;return{number:n+t,duration:i/s,timeline:r,time:t*i}})(e));if("static"===t){const e=h.length-1,t="number"==typeof r?r:n;h[e].duration=t-i/s*e}return h},gi=e=>{const{baseUrl:t,initialization:i={},sourceDuration:s,indexRange:r="",periodStart:n,presentationTime:o,number:a=0,duration:h}=e;if(!t)throw new Error(ri);const l=ci({baseUrl:t,source:i.sourceURL,range:i.range}),c=ci({baseUrl:t,source:t,indexRange:r});if(c.map=l,h){const t=fi(e);t.length&&(c.duration=t[0].duration,c.timeline=t[0].timeline)}else s&&(c.duration=s,c.timeline=n);return c.presentationTime=o||n,c.number=a,[c]},pi=e=>{return(t=e,i=({timeline:e})=>e,Kt(t.reduce(((e,t)=>(t.forEach((t=>{e[i(t)]=t})),e)),{}))).sort(((e,t)=>e.timeline>t.timeline?1:-1));var t,i},mi=e=>Kt(e.reduce(((e,t)=>{const i=t.attributes.id+(t.attributes.lang||"");return e[i]?(t.segments&&(t.segments[0]&&(t.segments[0].discontinuity=!0),e[i].segments.push(...t.segments)),t.attributes.contentProtection&&(e[i].attributes.contentProtection=t.attributes.contentProtection)):(e[i]=t,e[i].attributes.timelineStarts=[]),e[i].attributes.timelineStarts.push({start:t.attributes.periodStart,timeline:t.attributes.periodStart}),e}),{})).map((e=>{var t,i;return e.discontinuityStarts=(t=e.segments||[],i="discontinuity",t.reduce(((e,t,s)=>(t[i]&&e.push(s),e)),[])),e})),_i=(e,t)=>{const i=(s=e.sidx)&&s.uri+"-"+li(s.byterange);var s;const r=i&&t[i]&&t[i].sidx;return r&&((e,t,i)=>{const s=e.sidx.map?e.sidx.map:null,r=e.sidx.duration,n=e.timeline||0,o=e.sidx.byterange,a=o.offset+o.length,h=t.timescale,l=t.references.filter((e=>1!==e.referenceType)),c=[],u=e.endList?"static":"dynamic",d=e.sidx.timeline;let f,g=d,p=e.mediaSequence||0;f="bigint"==typeof t.firstOffset?window.BigInt(a)+t.firstOffset:a+t.firstOffset;for(let e=0;e<l.length;e++){const o=t.references[e],a=o.referencedSize,l=o.subsegmentDuration;let m;m="bigint"==typeof f?f+window.BigInt(a)-window.BigInt(1):f+a-1;const _=gi({baseUrl:i,timescale:h,timeline:n,periodStart:d,presentationTime:g,number:p,duration:l,sourceDuration:r,indexRange:`${f}-${m}`,type:u})[0];s&&(_.map=s),c.push(_),f+="bigint"==typeof f?window.BigInt(a):a,g+=l/h,p++}e.segments=c})(e,r,e.sidx.resolvedUri),e},yi=(e,t={})=>{if(!Object.keys(t).length)return e;for(const i in e)e[i]=_i(e[i],t);return e},vi=({attributes:e,segments:t,sidx:i,discontinuityStarts:s})=>{const r={attributes:{NAME:e.id,AUDIO:"audio",SUBTITLES:"subs",RESOLUTION:{width:e.width,height:e.height},CODECS:e.codecs,BANDWIDTH:e.bandwidth,"PROGRAM-ID":1},uri:"",endList:"static"===e.type,timeline:e.periodStart,resolvedUri:"",targetDuration:e.duration,discontinuityStarts:s,timelineStarts:e.timelineStarts,segments:t,bandwidth:e.bandwidth};return e.contentProtection&&(r.contentProtection=e.contentProtection),i&&(r.sidx=i),r},bi=({attributes:e})=>"video/mp4"===e.mimeType||"video/webm"===e.mimeType||"video"===e.contentType,Si=({attributes:e})=>"audio/mp4"===e.mimeType||"audio/webm"===e.mimeType||"audio"===e.contentType,wi=({attributes:e})=>"text/vtt"===e.mimeType||"text"===e.contentType,Pi=e=>e?Object.keys(e).reduce(((t,i)=>{const s=e[i];return t.concat(s.playlists)}),[]):[],Ei=({dashPlaylists:e,locations:t,sidxMapping:i={}})=>{if(!e.length)return{};const{sourceDuration:s,type:r,suggestedPresentationDelay:n,minimumUpdatePeriod:o}=e[0].attributes,a=mi(e.filter(bi)).map(vi),h=mi(e.filter(Si)),l=mi(e.filter(wi));a.sort(((e,t)=>e.bandwidth-t.bandwidth));const c={discontinuityStarts:[],segments:[],endList:!0,uri:"",duration:s,playlists:yi(a,i)};o>=0&&(c.minimumUpdatePeriod=1e3*o),t&&(c.locations=t),"dynamic"===r&&(c.suggestedPresentationDelay=n);const u=0===c.playlists.length,d=h.length?((e,t={},i=!1)=>{let s;const r=e.reduce(((e,r)=>{const n=r.attributes.role&&r.attributes.role.value||"",o=r.attributes.lang||"";let a=r.attributes.label||"main";if(o&&!r.attributes.label){const e=n?` (${n})`:"";a=`${r.attributes.lang}${e}`}e[a]||(e[a]={language:o,autoselect:!0,default:"main"===n,playlists:[],uri:""});const h=_i((({attributes:e,segments:t,sidx:i,mediaSequence:s,discontinuitySequence:r,discontinuityStarts:n},o)=>{const a={attributes:{NAME:e.id,BANDWIDTH:e.bandwidth,CODECS:e.codecs,"PROGRAM-ID":1},uri:"",endList:"static"===e.type,timeline:e.periodStart,resolvedUri:"",targetDuration:e.duration,discontinuitySequence:r,discontinuityStarts:n,timelineStarts:e.timelineStarts,mediaSequence:s,segments:t};return e.contentProtection&&(a.contentProtection=e.contentProtection),i&&(a.sidx=i),o&&(a.attributes.AUDIO="audio",a.attributes.SUBTITLES="subs"),a})(r,i),t);return e[a].playlists.push(h),void 0===s&&"main"===n&&(s=r,s.default=!0),e}),{});s||(r[Object.keys(r)[0]].default=!0);return r})(h,i,u):null,f=l.length?((e,t={})=>e.reduce(((e,i)=>{const s=i.attributes.lang||"text";return e[s]||(e[s]={language:s,default:!1,autoselect:!1,playlists:[],uri:""}),e[s].playlists.push(_i((({attributes:e,segments:t,mediaSequence:i,discontinuityStarts:s,discontinuitySequence:r})=>{void 0===t&&(t=[{uri:e.baseUrl,timeline:e.periodStart,resolvedUri:e.baseUrl||"",duration:e.sourceDuration,number:0}],e.duration=e.sourceDuration);const n={NAME:e.id,BANDWIDTH:e.bandwidth,"PROGRAM-ID":1};return e.codecs&&(n.CODECS=e.codecs),{attributes:n,uri:"",endList:"static"===e.type,timeline:e.periodStart,resolvedUri:e.baseUrl||"",targetDuration:e.duration,timelineStarts:e.timelineStarts,discontinuityStarts:s,discontinuitySequence:r,mediaSequence:i,segments:t}})(i),t)),e}),{}))(l,i):null,g=a.concat(Pi(d),Pi(f)),p=g.map((({timelineStarts:e})=>e));var m,_;return c.timelineStarts=pi(p),m=g,_=c.timelineStarts,m.forEach((e=>{e.mediaSequence=0,e.discontinuitySequence=((e,t)=>{for(let i=0;i<e.length;i++)if(t(e[i]))return i;return-1})(_,(({timeline:t})=>t===e.timeline)),e.segments&&e.segments.forEach(((e,t)=>{e.number=t}))})),c},Ti=(e,t,i)=>{const{NOW:s,clientOffset:r,availabilityStartTime:n,timescale:o=1,periodStart:a=0,minimumUpdatePeriod:h=0}=e,l=(s+r)/1e3+h-(n+a);return Math.ceil((l*o-t)/i)},Ii=(e,t)=>{const{type:i,minimumUpdatePeriod:s=0,media:r="",sourceDuration:n,timescale:o=1,startNumber:a=1,periodStart:h}=e,l=[];let c=-1;for(let u=0;u<t.length;u++){const d=t[u],f=d.d,g=d.r||0,p=d.t||0;let m;if(c<0&&(c=p),p&&p>c&&(c=p),g<0){const a=u+1;m=a===t.length?"dynamic"===i&&s>0&&r.indexOf("$Number$")>0?Ti(e,c,f):(n*o-c)/f:(t[a].t-c)/f}else m=g+1;const _=a+l.length+m;let y=a+l.length;for(;y<_;)l.push({number:y,duration:f/o,time:c,timeline:h}),c+=f,y++}return l},Ci=/\$([A-z]*)(?:(%0)([0-9]+)d)?\$/g,Ni=(e,t)=>e.replace(Ci,(e=>(t,i,s,r)=>{if("$$"===t)return"$";if(void 0===e[i])return t;const n=""+e[i];return"RepresentationID"===i?n:(r=s?parseInt(r,10):1,n.length>=r?n:`${new Array(r-n.length+1).join("0")}${n}`)})(t)),Di=(e,t)=>{const i={RepresentationID:e.id,Bandwidth:e.bandwidth||0},{initialization:s={sourceURL:"",range:""}}=e,r=ci({baseUrl:e.baseUrl,source:Ni(s.sourceURL,i),range:s.range}),n=((e,t)=>e.duration||t?e.duration?fi(e):Ii(e,t):[{number:e.startNumber||1,duration:e.sourceDuration,time:0,timeline:e.periodStart}])(e,t);return n.map((t=>{i.Number=t.number,i.Time=t.time;const s=Ni(e.media||"",i),n=e.timescale||1,o=e.presentationTimeOffset||0,a=e.periodStart+(t.time-o)/n;return{uri:s,timeline:t.timeline,duration:t.duration,resolvedUri:hi(e.baseUrl||"",s),map:r,number:t.number,presentationTime:a}}))},Li=(e,t)=>{const{duration:i,segmentUrls:s=[],periodStart:r}=e;if(!i&&!t||i&&t)throw new Error(ni);const n=s.map((t=>((e,t)=>{const{baseUrl:i,initialization:s={}}=e,r=ci({baseUrl:i,source:s.sourceURL,range:s.range}),n=ci({baseUrl:i,source:t.media,range:t.mediaRange});return n.map=r,n})(e,t)));let o;i&&(o=fi(e)),t&&(o=Ii(e,t));return o.map(((t,i)=>{if(n[i]){const s=n[i],o=e.timescale||1,a=e.presentationTimeOffset||0;return s.timeline=t.timeline,s.duration=t.duration,s.number=t.number,s.presentationTime=r+(t.time-a)/o,s}})).filter((e=>e))},Mi=({attributes:e,segmentInfo:t})=>{let i,s;t.template?(s=Di,i=Qt(e,t.template)):t.base?(s=gi,i=Qt(e,t.base)):t.list&&(s=Li,i=Qt(e,t.list));const r={attributes:e};if(!s)return r;const n=s(i,t.segmentTimeline);if(i.duration){const{duration:e,timescale:t=1}=i;i.duration=e/t}else n.length?i.duration=n.reduce(((e,t)=>Math.max(e,Math.ceil(t.duration))),0):i.duration=0;return r.attributes=i,r.segments=n,t.base&&i.indexRange&&(r.sidx=n[0],r.segments=[]),r},Ri=(e,t)=>ei(e.childNodes).filter((({tagName:e})=>e===t)),Ai=e=>e.textContent.trim(),Oi=e=>{const t=/P(?:(\d*)Y)?(?:(\d*)M)?(?:(\d*)D)?(?:T(?:(\d*)H)?(?:(\d*)M)?(?:([\d.]*)S)?)?/.exec(e);if(!t)return 0;const[i,s,r,n,o,a]=t.slice(1);return 31536e3*parseFloat(i||0)+2592e3*parseFloat(s||0)+86400*parseFloat(r||0)+3600*parseFloat(n||0)+60*parseFloat(o||0)+parseFloat(a||0)},xi={mediaPresentationDuration:e=>Oi(e),availabilityStartTime(e){return/^\d+-\d+-\d+T\d+:\d+:\d+(\.\d+)?$/.test(t=e)&&(t+="Z"),Date.parse(t)/1e3;var t},minimumUpdatePeriod:e=>Oi(e),suggestedPresentationDelay:e=>Oi(e),type:e=>e,timeShiftBufferDepth:e=>Oi(e),start:e=>Oi(e),width:e=>parseInt(e,10),height:e=>parseInt(e,10),bandwidth:e=>parseInt(e,10),startNumber:e=>parseInt(e,10),timescale:e=>parseInt(e,10),presentationTimeOffset:e=>parseInt(e,10),duration(e){const t=parseInt(e,10);return isNaN(t)?Oi(e):t},d:e=>parseInt(e,10),t:e=>parseInt(e,10),r:e=>parseInt(e,10),DEFAULT:e=>e},ki=e=>e&&e.attributes?ei(e.attributes).reduce(((e,t)=>{const i=xi[t.name]||xi.DEFAULT;return e[t.name]=i(t.value),e}),{}):{},Bi={"urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b":"org.w3.clearkey","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed":"com.widevine.alpha","urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95":"com.microsoft.playready","urn:uuid:f239e769-efa3-4850-9c16-a903c6932efb":"com.adobe.primetime"},$i=(e,t)=>t.length?Zt(e.map((function(e){return t.map((function(t){return hi(e,Ai(t))}))}))):e,Ui=e=>{const t=Ri(e,"SegmentTemplate")[0],i=Ri(e,"SegmentList")[0],s=i&&Ri(i,"SegmentURL").map((e=>Qt({tag:"SegmentURL"},ki(e)))),r=Ri(e,"SegmentBase")[0],n=i||t,o=n&&Ri(n,"SegmentTimeline")[0],a=i||r||t,h=a&&Ri(a,"Initialization")[0],l=t&&ki(t);l&&h?l.initialization=h&&ki(h):l&&l.initialization&&(l.initialization={sourceURL:l.initialization});const c={template:l,segmentTimeline:o&&Ri(o,"S").map((e=>ki(e))),list:i&&Qt(ki(i),{segmentUrls:s,initialization:ki(h)}),base:r&&Qt(ki(r),{initialization:ki(h)})};return Object.keys(c).forEach((e=>{c[e]||delete c[e]})),c},qi=(e,t,i)=>s=>{const r=ki(s),n=$i(t,Ri(s,"BaseURL")),o=Ri(s,"Role")[0],a={role:ki(o)};let h=Qt(e,r,a);const l=Ri(s,"Accessibility")[0],c=(e=>{if("urn:scte:dash:cc:cea-608:2015"===e.schemeIdUri)return("string"!=typeof e.value?[]:e.value.split(";")).map((e=>{let t,i;return i=e,/^CC\d=/.test(e)?[t,i]=e.split("="):/^CC\d$/.test(e)&&(t=e),{channel:t,language:i}}));if("urn:scte:dash:cc:cea-708:2015"===e.schemeIdUri)return("string"!=typeof e.value?[]:e.value.split(";")).map((e=>{const t={channel:void 0,language:void 0,aspectRatio:1,easyReader:0,"3D":0};if(/=/.test(e)){const[i,s=""]=e.split("=");t.channel=i,t.language=e,s.split(",").forEach((e=>{const[i,s]=e.split(":");"lang"===i?t.language=s:"er"===i?t.easyReader=Number(s):"war"===i?t.aspectRatio=Number(s):"3D"===i&&(t["3D"]=Number(s))}))}else t.language=e;return t.channel&&(t.channel="SERVICE"+t.channel),t}))})(ki(l));c&&(h=Qt(h,{captionServices:c}));const u=Ri(s,"Label")[0];if(u&&u.childNodes.length){const e=u.childNodes[0].nodeValue.trim();h=Qt(h,{label:e})}const d=Ri(s,"ContentProtection").reduce(((e,t)=>{const i=ki(t);i.schemeIdUri&&(i.schemeIdUri=i.schemeIdUri.toLowerCase());const s=Bi[i.schemeIdUri];if(s){e[s]={attributes:i};const r=Ri(t,"cenc:pssh")[0];if(r){const t=Ai(r);e[s].pssh=t&&oi(t)}}return e}),{});Object.keys(d).length&&(h=Qt(h,{contentProtection:d}));const f=Ui(s),g=Ri(s,"Representation"),p=Qt(i,f);return Zt(g.map(((e,t,i)=>s=>{const r=Ri(s,"BaseURL"),n=$i(t,r),o=Qt(e,ki(s)),a=Ui(s);return n.map((e=>({segmentInfo:Qt(i,a),attributes:Qt(o,{baseUrl:e})})))})(h,n,p)))},zi=(e,t)=>(i,s)=>{const r=$i(t,Ri(i.node,"BaseURL")),n=Qt(e,{periodStart:i.attributes.start});"number"==typeof i.attributes.duration&&(n.periodDuration=i.attributes.duration);const o=Ri(i.node,"AdaptationSet"),a=Ui(i.node);return Zt(o.map(qi(n,r,a)))};var Fi=i(716);const Hi=(e,t={})=>{const i=((e,t={})=>{const{manifestUri:i="",NOW:s=Date.now(),clientOffset:r=0}=t,n=Ri(e,"Period");if(!n.length)throw new Error(ti);const o=Ri(e,"Location"),a=ki(e),h=$i([i],Ri(e,"BaseURL"));a.type=a.type||"static",a.sourceDuration=a.mediaPresentationDuration||0,a.NOW=s,a.clientOffset=r,o.length&&(a.locations=o.map(Ai));const l=[];return n.forEach(((e,t)=>{const i=ki(e),s=l[t-1];i.start=(({attributes:e,priorPeriodAttributes:t,mpdType:i})=>"number"==typeof e.start?e.start:t&&"number"==typeof t.start&&"number"==typeof t.duration?t.start+t.duration:t||"static"!==i?null:0)({attributes:i,priorPeriodAttributes:s?s.attributes:null,mpdType:a.type}),l.push({node:e,attributes:i})})),{locations:a.locations,representationInfo:Zt(l.map(zi(a,h)))}})((e=>{if(""===e)throw new Error(ii);const t=new Fi.DOMParser;let i,s;try{i=t.parseFromString(e,"application/xml"),s=i&&"MPD"===i.documentElement.tagName?i.documentElement:null}catch(e){}if(!s||s&&s.getElementsByTagName("parsererror").length>0)throw new Error(si);return s})(e),t),s=i.representationInfo.map(Mi);return Ei({dashPlaylists:s,locations:i.locations,sidxMapping:t.sidxMapping})};class Wi extends Fe{static get Events(){return je}constructor(e,i={}){super(i),this.config=Object.assign({},We,i),this.player=e,this.xhrPlugin=shaka.net.HttpXHRPlugin.parse?shaka.net.HttpXHRPlugin.parse:shaka.net.HttpXHRPlugin,this.mediaType=null,this.lastMpdManifest=void 0,this.fragMap=new Map,this.levelsHls=[],this.currentLevel=0,this.lastLevel=0,this.multiBitrate=!1;const s=this.initLogger();let{token:r,channelId:n}=this.config;r||(r=this.config.channelIdPrefix);let o=e=>{const i=t().parseURL(e);return`${i.netLoc.substr(2)+i.path.substring(0,i.path.lastIndexOf("."))}`};n&&(o=this.makeChannelId(r,n));const a=this.makeSignalId();e.addEventListener("manifestparsed",(()=>{const{config:t}=this;if(!this.mediaType)throw new Error("mediaType is null");const i=e.isLive();t.live=i,t.mediaType=this.mediaType;const r=this.commonBrowserInfo;this.browserInfo={...r,tag:this.mediaType,live:i,type:"shaka"},r.device===I.device.PC_NATIVE&&(this.browserInfo={...this.browserInfo,app:t.appName,bundle:t.appId}),this.channel=`${o(this.player.getAssetUri())}|${a}[${D.VERSION}]`,"dash"===this.mediaType&&(this.channel=`${this.channel}d`),s.info(`P2P version: ${Wi.version} Shaka version: ${shaka.Player.version}`),s.info(`channel ${this.channel}`),this.eventListened=!1,this._init(this.channel,this.browserInfo)})),this.logger.debug("init shaka networking engine"),shaka.net.NetworkingEngine.registerScheme("http",this._processNetworkRequest.bind(this)),shaka.net.NetworkingEngine.registerScheme("https",this._processNetworkRequest.bind(this))}_processNetworkRequest(e,i,s,r,n){if(!this.mediaType&&0===s){/.m3u8(#|\?|$)/i.exec(e)?this.mediaType="hls":/.mpd(#|\?|$)/i.exec(e)&&(this.mediaType="dash"),this.logger.info(`mediaType ${this.mediaType}`);let{segmentId:t}=this.config;t||("hls"===this.mediaType?this.config.segmentId=(e,t,i,s)=>`${e}-${t}`:this.config.segmentId=(e,t)=>{let i=e.split("?")[0];return i.startsWith("http")&&(i=i.split("://")[1]),t?`${i}|${t}`:`${i}`})}if(s===shaka.net.NetworkingEngine.RequestType.SEGMENT){if(this.curTsUri=e,"dash"===this.mediaType){const t=this.config.segmentId(e);this.fragMap.has(t)&&(this.currentLevel=this.fragMap.get(t).level)}if(this.hybridLoader)return this.hybridLoader.load(e,i,s,r,n)}else if(s===shaka.net.NetworkingEngine.RequestType.MANIFEST){const o=(async()=>{let o;o=this.config.sharePlaylist&&this.pLoader?await this.pLoader.load(e,i,s,r,n).promise:await this.xhrPlugin(e,i,s,r,n).promise;const a=o.data,h=(new TextDecoder).decode(a),l=this.player.getAssetUri();if("hls"===this.mediaType)if(h.indexOf("#EXTINF:")>0||h.indexOf("#EXT-X-TARGETDURATION:")>0){let i=0;const s=Bt.parseLevelPlaylist(h,e);this.levelsHls.length>1?(this.multiBitrate=!0,i=this.levelsHls.indexOf(s.url),-1!==i&&(this.currentLevel=i)):this.levelsHls=[l],this.targetDuration=s.averagetargetduration,s.fragments.forEach((e=>{e.level=i;let s=t().buildAbsoluteURL(e.baseurl,e.relurl,{alwaysNormalize:!0});const r=e.byteRange;2===r.length&&(s=`${s}|bytes=${r[0]}-${r[1]-1}`),this.fragMap.set(s,e)}))}else{const e=Bt.parseMasterPlaylist(h,l);e.length>0&&(e.sort(((e,t)=>e.bitrate-t.bitrate)),this.levelsHls=e.map((e=>e.url)))}else{this.multiBitrate=!0;const{playlists:t}=Hi(h,{manifestUri:e});let i=0;for(let e of t)e.segments.forEach((e=>{let t=e.resolvedUri;const s=e.byterange;let r;s&&(r=`bytes=${li(s)}`);const n=this.config.segmentId(t,r);this.fragMap.set(n,{level:i,sn:e.number,url:e.resolvedUri,duration:e.duration,range:r})})),i++}return this.config.live&&f(this.fragMap,100),o})();return new shaka.util.AbortableOperation(o,(async()=>{}))}return this.xhrPlugin(e,i,s,r,n)}async _init(e,t){const{config:i,logger:s}=this;if(!this.p2pEnabled)return;this.media=this.player.getMediaElement(),this.offEventRebuffer=function(e,t){let i=null;const s=()=>{i||(i=setTimeout((()=>{t()}),2500))},r=()=>{null!=i&&(clearTimeout(i),i=null)};return e.addEventListener("waiting",s),e.addEventListener("playing",r),()=>{e.removeEventListener("waiting",s),e.removeEventListener("playing",r)}}(this.media,(()=>{this.fetcher&&this.fetcher.increRebuffers()}));const n=()=>{this.fetcher=new Z(this,i.token,window.encodeURIComponent(e),i.announce||"",t)};let o;"hls"===this.mediaType?(o=new bt(this,i),await this.initSegmentManager(),t.live||(t.tag=`${this.mediaType}_${"SegmentStore"===this.bufMgr.name?"d":"m"}`),n(),this.hybridLoader=new class{constructor(e,t,i,s,r){this.config=r,this.fragMap=s,this.logger=r.logger,this.bufMgr=i,this.streamEnabled=shaka.net.HttpFetchPlugin.isSupported(),this.httpPlugin=this.streamEnabled?St.parse:shaka.net.HttpXHRPlugin.parse,this.p2pEnabled=r.p2pEnabled,this.scheduler=e,this.fetcher=t,this.forbidden=t.forbidden}destroy(){this.abort(),this.destroyed=!0}abort(){}load(e,t,i,s,n){const{logger:o,scheduler:a}=this,h=t.headers.Range;let l=e;h&&(l=`${l}|${h}`);const c=this.fragMap.get(l);if(!c)return o.warn("no frag"),this.httpPlugin(e,t,i,s,n);const{sn:u,level:d}=c,f=this.config.segmentId(d,u,e,h||void 0);if(o.info(`hybridLoader load segId ${f} sn ${u} level ${d}`),this.forbidden)return;this.fetcher.increMediaRequests(),n||(n=e=>{}),this.streamEnabled&&a.onFragLoading(u,d,f);const g=n;if(n=e=>{const t=e["content-length"],i=t?parseInt(t,10):0;if(this.streamEnabled&&i>0&&!a.segmentBuilderMap.has(u,d)){const e=new Pt(u,d,f,i);a.segmentBuilderMap.set(u,d,e)}g(e)},this.streamEnabled){const e=s;s=(t,i,s,{buffers:r,aborted:n})=>{if(n)return void a.segmentBuilderMap.delete(u,d);const o=a.segmentBuilderMap.get(u,d);if(o)for(let e=0;e<r.length;e++)o.receiveBytes(r[e],0===s&&e===r.length-1);e(t,i,s)}}const p=(async()=>{let h;return this.p2pEnabled&&await this.bufMgr.hasSegOfId(f)?(o.info(`bufMgr found seg segId ${f}`),h=(async()=>{let t=await this.bufMgr.getSegById(f),i=r.l.from(t.data),s=new r.l(t.data.byteLength);i.copy(s);let n=new Uint8Array(s).buffer;const a={uri:e,originalUri:e,data:n,fromCache:!0};return o.debug(`bufMgr loaded segId ${f} size ${n.byteLength}`),a})()):this.p2pEnabled&&a.hasAndSetTargetPeer(u,d,f,a.getBufferedDuration())?(o.info(`p2p load segId ${f}`),h=(async()=>{let h;const l=await a.load(u,f,d,e,t.headers);if(l&&l.data){if(!await this.bufMgr.hasSegOfId(f)){const e=r.l.from(l.data),t=new r.l(l.data.byteLength);e.copy(t);const i=new T(u,f,t,l.fromPeerId||this.fetcher.peerId,d);this.bufMgr.putSeg(i)}a.onFragLoaded(u,d,f,!1),h={uri:e,originalUri:e,data:l.data,fromCache:!0},o.info(`p2p loaded segId ${f} size ${l.data.byteLength}`)}else o.warn(`P2P timeout switched to HTTP load segId ${f}`),h=await this.requestByHttp(e,t,i,s,n,f);return h})()):(o.info(`HTTP load segId ${f}`),h=this.requestByHttp(e,t,i,s,n,f,u,d)),h})();return new shaka.util.AbortableOperation(p,(async()=>{}))}async requestByHttp(e,t,i,s,n,o,a,h){const l=await this.httpPlugin(e,t,i,s,n).promise;this.scheduler.segmentBuilderMap.delete(a,h);const c=l.data;if(!await this.bufMgr.hasSegOfId(o)){const e=r.l.from(c),t=new r.l(c.byteLength);e.copy(t);const i=new T(a,o,t,this.fetcher.peerId,h);this.bufMgr.putSeg(i)}return this.scheduler.onFragLoaded(a,h,o,!0),this.fetcher.reportFlow(c.byteLength),this.logger.info(`HTTP loaded ${o} size ${c.byteLength}`),l}}(o,this.fetcher,this.bufMgr,this.fragMap,i)):(o=new lt(this,i),this.bufMgr=new De(this,i,!1),n(),this.hybridLoader=new class{constructor(e,t,i,s,r){this.config=r,this.logger=r.logger,this.bufMgr=i,this.streamEnabled=shaka.net.HttpFetchPlugin.isSupported(),this.httpPlugin=this.streamEnabled?St.parse:shaka.net.HttpXHRPlugin.parse,this.p2pEnabled=r.p2pEnabled,this.scheduler=e,this.fetcher=t,this.forbidden=t.forbidden}destroy(){this.abort(),this.destroyed=!0}abort(){}load(e,t,i,s,n){const{logger:o,scheduler:a}=this,h=this.config.segmentId(e,t.headers.Range||void 0);if(this.forbidden)return;this.fetcher.increMediaRequests(),n||(n=e=>{}),a.onFragLoading(h);const l=n;if(n=e=>{a.onHttpBodyStart(h);const t=e["content-length"],i=t?parseInt(t,10):0;if(i>0&&!a.segmentBuilderMap.has(h)){const e=new wt(h,i);a.segmentBuilderMap.set(h,e)}l(e)},this.streamEnabled){const e=s;s=(t,i,s,{buffers:r,aborted:n})=>{if(n)return void a.segmentBuilderMap.delete(h);const o=a.segmentBuilderMap.get(h);if(o)for(let e=0;e<r.length;e++)o.receiveBytes(r[e],0===s&&e===r.length-1);e(t,i,s)}}let c;const u=a.getBufferedDuration();return this.p2pEnabled&&this.bufMgr.hasSegOfId(h)?(o.info(`bufMgr found seg segId ${h}`),c=(async()=>{let t=this.bufMgr.getSegById(h),i=r.l.from(t.data),s=new r.l(t.data.byteLength);i.copy(s);let n=new Uint8Array(s).buffer;return{uri:e,originalUri:e,data:n,fromCache:!0}})()):this.p2pEnabled&&a.hasAndSetTargetPeer(h,u)?(o.info(`p2p load segId ${h}`),c=(async()=>{let l;const c=await a.load(h,e,t.headers);if(c&&c.data){if(!this.bufMgr.hasSegOfId(h)){const e=r.l.from(c.data),t=new r.l(c.data.byteLength);e.copy(t);const i=new T(-1,h,t,c.fromPeerId||this.fetcher.peerId);this.bufMgr.putSeg(i)}a.onFragLoaded(h,!1),l={uri:e,originalUri:e,data:c.data,fromCache:!0},o.info(`p2p loaded segId ${h} size ${c.data.byteLength}`)}else o.warn(`P2P timeout switched to HTTP load segId ${h}`),l=await this.requestByHttp(e,t,i,s,n,h);return l})()):(o.info(`HTTP load segId ${h}`),c=this.requestByHttp(e,t,i,s,n,h)),new shaka.util.AbortableOperation(c,(async()=>{}))}async requestByHttp(e,t,i,s,n,o){const a=await this.httpPlugin(e,t,i,s,n).promise;this.scheduler.segmentBuilderMap.delete(o);const h=a.data;if(!this.bufMgr.hasSegOfId(o)){const e=r.l.from(h),t=new r.l(h.byteLength);e.copy(t);const i=new T(-1,o,t,this.fetcher.peerId);this.bufMgr.putSeg(i)}return this.scheduler.onFragLoaded(o,!0),this.fetcher.reportFlow(h.byteLength),this.logger.info(`HTTP loaded ${o} size ${h.byteLength}`),a}}(o,this.fetcher,this.bufMgr,this.fragMap,i)),this.tracker=new me(this,this.fetcher,o,i),o.bufferManager=this.bufMgr,this.pLoader=new class{constructor(e,t,i){this.config=i,this.logger=i.logger,this.xhrPlugin=t,this.p2pEnabled=i.p2pEnabled,this.scheduler=e,this.isHls="hls"===i.mediaType}destroy(){this.abort(),this.destroyed=!0}abort(){}load(e,t,i,s,n){const{logger:o}=this;let a;o.info(`HTTP load playlist ${e}`);const h=e.split("?")[0];if(this.isHls&&this.scheduler.playlistInfo.has(h)){const t=this.scheduler.getPlaylistFromPeer(h);if(t&&t.data){const{data:i,seq:s}=t;return o.info(`got playlist ${e} from peer seq ${s}`),a=(async()=>({uri:e,originalUri:e,data:r.l.from(i).buffer,fromCache:!1}))(),new shaka.util.AbortableOperation(a,(async()=>{}))}}return a=this.requestByHttp(e,t,i,s,n,h),new shaka.util.AbortableOperation(a,(async()=>{}))}async requestByHttp(e,t,i,s,r,n){const o=await this.xhrPlugin(e,t,i,s,r).promise,a=o.data,h=(new TextDecoder).decode(a);return this.scheduler.broadcastPlaylist(n,h),this.logger.info("HTTP loaded playlist"),o}}(o,this.xhrPlugin,i),this.trackerTried=!1,this.trackerTried||this.tracker.connected||!i.p2pEnabled||(this.tracker.resumeP2P(),this.trackerTried=!0,this.once("serverConnected",(()=>{i.useHttpRange&&this.curTsUri?l(this.curTsUri).then((()=>{i.httpRangeSupported=!0,s.info("http range is supported"),i.httpLoadTime-=1.5,i.httpLoadTime<1.5&&(i.httpLoadTime=1.5)})).catch((()=>{i.httpRangeSupported=!1,s.warn("http range is not supported")})):i.httpRangeSupported=!1}))),this.setupWindowListeners()}disableP2P(){this.logger&&this.logger.warn("disable P2P"),this.offEventRebuffer&&this.offEventRebuffer(),this.p2pEnabled&&(this.p2pEnabled=!1,this.config.p2pEnabled=this.p2pEnabled,this.tracker&&this.tracker instanceof me&&(this.tracker.stopP2P(),this.tracker={},this.fetcher=null,this.bufMgr.destroy(),this.bufMgr=null))}getExtraForStats(){const e=super.getExtraForStats();return this.config.live||(e.pos=Math.round(this.media.currentTime)),this.multiBitrate&&this.currentLevel!==this.lastLevel&&(e.level=this.currentLevel+"",this.lastLevel=this.currentLevel),e}getExtraForPeersRequest(){const e=super.getExtraForPeersRequest();return this.multiBitrate&&(e.level=this.currentLevel+""),e}async initSegmentManager(){const{logger:e,config:t}=this;if(window.indexedDB&&t.useDiskCache&&!t.live){const i=new Xt(this,t);try{await i.setupStore(),this.bufMgr=i}catch(i){e.warn(i),this.bufMgr=new Yt(this,t)}}else this.bufMgr=new Yt(this,t);if(this.bufMgr.maxBufSize<=0)throw new Error("bufMgr state is invalid")}}window&&(window.P2pEngineShaka=Wi);const ji=Wi})(),s=s.default})()));